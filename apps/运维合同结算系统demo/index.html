<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运维合同结算管理系统 - OLED Pro</title>
    <!-- Google Fonts: IBM Plex Sans -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* OLED Dark Palette (Default) */
            --color-primary: #0F172A;
            --color-secondary: #1E293B;
            --color-cta: #22C55E;
            --color-cta-hover: #16a34a;
            --color-background: #020617;
            --color-text: #F8FAFC;
            --color-text-muted: #94A3B8;
            --color-border: #1E293B;
            --color-danger: #EF4444;
            --color-warning: #F59E0B;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            /* Effects */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.5);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.8);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.9);
            --shadow-xl: 0 20px 25px rgba(0,0,0,1);
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.05);
            --radius: 12px;
            
            --main-gradient: radial-gradient(circle at top right, #0f172a 0%, #020617 100%);
            --transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.light-mode {
            --color-primary: #ffffff;
            --color-secondary: #f1f5f9;
            --color-background: #f8fafc;
            --color-text: #0f172a;
            --color-text-muted: #64748b;
            --color-border: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            --main-gradient: radial-gradient(circle at top right, #f1f5f9 0%, #f8fafc 100%);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'IBM Plex Sans', 'Noto Sans SC', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--color-primary);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            padding: var(--space-xl);
            z-index: 100;
            flex-shrink: 0;
            box-shadow: 4px 0 24px rgba(0,0,0,0.5);
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-cta);
            margin-bottom: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            text-decoration: none;
            color: var(--color-text-muted);
            border-radius: var(--radius);
            margin-bottom: 10px;
            transition: var(--transition);
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
        }

        .nav-link:hover {
            background-color: var(--color-secondary);
            color: var(--color-text);
            transform: translateX(4px);
        }

        .nav-link.active {
            background-color: var(--color-cta);
            color: white;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .nav-link svg {
            width: 20px;
            height: 20px;
            opacity: 0.8;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: var(--space-md);
            background: var(--color-secondary);
            border-radius: var(--radius);
            font-size: 13px;
        }

        .sidebar-footer h4 {
            margin: 0 0 8px 0;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Main Content */
        .main {
            flex-grow: 1;
            padding: var(--space-xl) var(--space-2xl);
            overflow-y: auto;
            position: relative;
            background: var(--main-gradient);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 10px 0;
        }

        h1 {
            font-size: 32px;
            margin: 0;
            font-weight: 700;
            background: linear-gradient(to right, var(--color-text), var(--color-text-muted));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--glass-bg);
            padding: 8px 20px;
            border-radius: 40px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: var(--transition);
        }

        .user-profile:hover {
            border-color: var(--color-cta);
        }

        /* Views */
        .view-section {
            display: none;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .view-section.active {
            display: block;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--color-primary);
            padding: 28px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .card:hover {
            border-color: var(--color-cta-hover);
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-text);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 32px;
            background: var(--glass-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            align-items: center;
        }

        select, input[type="text"], input[type="number"] {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            background: var(--color-background);
            color: var(--color-text);
            font-family: inherit;
            font-size: 14px;
            transition: var(--transition);
        }

        select:focus, input:focus {
            border-color: var(--color-cta);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
        }

        .btn-primary {
            background: var(--color-cta);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:hover {
            background: var(--color-cta-hover);
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.4);
            transform: scale(1.02);
        }

        /* Table */
        .table-container {
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--color-border);
            background: var(--color-primary);
            box-shadow: var(--shadow-lg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th {
            background-color: var(--color-secondary);
            color: var(--color-text);
            font-weight: 600;
            text-align: left;
            padding: 20px;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        td {
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .qty-input { width: 90px; text-align: center; }
        .adjust-input { width: 110px; color: var(--color-cta); font-weight: 700; }

        .lump-sum-tag {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-cta);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .reason-cell {
            color: var(--color-text-muted);
            font-style: italic;
            cursor: pointer;
        }

        .reason-cell:hover { color: var(--color-cta); text-decoration: underline; }

        .total-row {
            background: var(--color-secondary);
            font-weight: 700;
        }

        .total-row td {
            font-size: 18px;
            color: var(--color-cta);
            border-bottom: none;
        }

        /* Modal */
        #adjustmentModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--color-primary);
            padding: 40px;
            border-radius: 24px;
            width: 500px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-xl);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Guide Banner */
        .info-banner {
            background: rgba(34, 197, 94, 0.1);
            border: 1px dashed var(--color-cta);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }

        .info-icon {
            color: var(--color-cta);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .info-content h5 { margin: 0 0 6px 0; font-size: 15px; }
        .info-content p { margin: 0; font-size: 13px; color: var(--color-text-muted); line-height: 1.6; }

        .toast {
            position: fixed;
            bottom: 32px; right: 32px;
            background: var(--color-cta);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.5);
            z-index: 2000;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-background); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-secondary); }
        /* Assessment specific styles */
        .assessment-row {
            background: rgba(239, 68, 68, 0.05) !important;
            color: var(--color-danger);
        }
        .assessment-tag {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .import-btn {
            background: var(--color-primary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }
        .import-btn:hover {
            border-color: var(--color-cta);
            background: var(--color-secondary);
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            <span>O&M OLED Pro</span>
        </div>
        <nav class="nav-links">
            <div class="nav-link active" onclick="switchView('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                工作仪表盘
            </div>
            <div class="nav-link" onclick="switchView('settlement')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                季度结算申报
            </div>
            <div class="nav-link" onclick="switchView('library')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                合同标段库
            </div>
            <div class="nav-link" onclick="switchView('history')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                结算历史记录
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <h4>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-cta)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                操作建议
            </h4>
            <p style="margin:0; opacity:0.8; line-height:1.4;">系统根据合同自动生成包干金额。修改【调整额】时请务必备注理由以通过审计。</p>
        </div>
    </aside>

    <main class="main">
        <header>
            <h1 id="pageTitle">工作仪表盘</h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <button id="themeToggle" onclick="toggleTheme()" style="background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--color-text); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); box-shadow: var(--shadow-md);">
                    <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
                </button>
                <div class="user-profile">
                    <div style="width: 36px; height: 36px; background: var(--color-cta); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white;">甲</div>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-size: 14px; font-weight: 600;">甲方管理员</span>
                        <span style="font-size: 11px; color: var(--color-text-muted);">权限: 综合部/审计</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- View: Dashboard -->
        <section id="dashboard" class="view-section active">
            <div class="info-banner">
                <div class="info-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </div>
                <div class="info-content">
                    <h5>系统公告与使用指引</h5>
                    <p>欢迎使用运维合同结算管理系统。本演示版已预载 2026 Q1 的标段库数据。<strong>结算流程：</strong>选择场站 → 核对自动包干额 → 输入实际人工量 → 填写调整原因(如有) → 提交申报。所有数据变动将实时保存至本地缓存。</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <div class="stat-label">本季度已结算场站</div>
                    <div class="stat-value">12 / 18</div>
                    <div style="margin-top:15px; height:4px; background:rgba(255,255,255,0.1); border-radius:2px;">
                        <div style="width:66%; height:100%; background:var(--color-cta); border-radius:2px; box-shadow:0 0 10px var(--color-cta);"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="stat-label">待审核申报</div>
                    <div class="stat-value">3</div>
                    <p style="font-size:12px; color:var(--color-warning); margin-top:10px;">需在 3 个工作日内完成...</p>
                </div>
                <div class="card">
                    <div class="stat-label">本年已结算总额</div>
                    <div class="stat-value">¥ 4,250,300.20</div>
                    <p style="font-size:12px; color:var(--color-cta); margin-top:10px;">同比上年度 增长 4.2% ↑</p>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
                <div class="card">
                    <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        近期结算趋势
                    </h3>
                    <div style="height: 200px; display: flex; align-items: flex-end; gap: 15px; padding-top: 20px;">
                        <div style="flex:1; height:40%; background:var(--color-secondary); border-radius:4px 4px 0 0;"></div>
                        <div style="flex:1; height:60%; background:var(--color-secondary); border-radius:4px 4px 0 0;"></div>
                        <div style="flex:1; height:85%; background:var(--color-cta); border-radius:4px 4px 0 0;"></div>
                        <div style="flex:1; height:50%; background:var(--color-secondary); border-radius:4px 4px 0 0;"></div>
                        <div style="flex:1; height:30%; background:var(--color-secondary); border-radius:4px 4px 0 0;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; color: var(--color-text-muted);">
                        <span>2025 Q3</span><span>2025 Q4</span><span style="color:var(--color-cta)">2026 Q1(当前)</span><span>2026 Q2</span><span>2026 Q3</span>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-top: 0;">操作记录</h3>
                    <ul style="list-style: none; padding: 0; font-size: 13px; line-height: 2;">
                        <li style="border-bottom: 1px solid var(--color-border); padding: 8px 0;"><span style="color:var(--color-cta)">[已提交]</span> 大新龙门风电场 - 2026Q1</li>
                        <li style="border-bottom: 1px solid var(--color-border); padding: 8px 0;"><span style="color:var(--color-text-muted)">[已归档]</span> 天等把荷风电场 - 2025Q4</li>
                        <li style="padding: 8px 0;"><span style="color:var(--color-warning)">[待重申]</span> 宁明板棍光伏 - 附件缺失</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- View: Settlement -->
        <section id="settlement" class="view-section">
            <div class="controls">
                <div style="flex-grow: 1; display: flex; gap: 15px;">
                    <select id="stationSelect" style="flex: 2;" onchange="loadSettlementData()">
                        <option value="">-- 请先选择待申报场站 --</option>
                        <option value="S001" data-lot="L001">大新龙门风电场 (标段 A)</option>
                        <option value="S002" data-lot="L002">扶绥中原光伏项目 (标段 B)</option>
                        <option value="S003" data-lot="L001">宁明板棍光伏项目 (标段 A)</option>
                        <option value="S004" data-lot="L003">天等把荷风电场 (标段 C)</option>
                    </select>
                    <select id="periodSelect" style="flex: 1;" onchange="loadSettlementData()">
                        <option value="2026Q1">2026 第一季度 (Q1)</option>
                        <option value="2026Q2">2026 第二季度 (Q2)</option>
                        <option value="2026Q3">2026 第三季度 (Q3)</option>
                        <option value="2026Q4">2026 第四季度 (Q4)</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="loadSettlementData()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                    刷新状态
                </button>
            </div>

            <div id="settlementTableArea" style="display: none;">
                <div class="info-banner" style="margin-bottom: 15px; border-style: solid; background: rgba(255,255,255,0.03);">
                    <div class="info-icon" style="color: var(--color-warning)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    </div>
                    <div class="info-content">
                        <p style="color: var(--color-text); font-size: 14px; font-weight: 500;">填报提醒：</p>
                        <p>请点击黄色单元格调整费用。若金额较理论值有变动，系统将自动锁死并要求您点击“调整备注”列补充佐证原因。合价字段为含税金额。</p>
                    </div>
                </div>

                <div class="table-container">
                    <table id="settlementTable">
                        <thead>
                            <tr>
                                <th width="60">ID</th>
                                <th>项目名称 / 结算类型</th>
                                <th>单位</th>
                                <th>合同年合价</th>
                                <th>本次结算量</th>
                                <th>理论结算额</th>
                                <th>费用调整额</th>
                                <th>实际结算额</th>
                                <th>审计说明</th>
                            </tr>
                        </thead>
                        <tbody id="settlementBody"></tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="7" style="text-align: right; padding-right: 32px;">本季度结算总额 (含税)：</td>
                                <td id="footerTotal">¥ 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="action-bar" style="display: flex; gap: 16px; margin-top: 24px;">
                    <button style="background: transparent; color: var(--color-text); border: 1px solid var(--color-border); padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600;">暂存本地</button>
                    <button class="import-btn" onclick="openAssessmentModal()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        导入考核项
                    </button>
                    <button class="btn-primary" onclick="submitFinal()">提交甲方复核</button>
                </div>
            </div>

            <div id="noDataMessage" style="text-align: center; padding: 100px; color: var(--color-text-muted); background: var(--color-primary); border-radius: 20px; border: 2px dashed var(--color-border);">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 24px; opacity: 0.3;"><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
                <h3 style="margin: 0; color: white;">就绪，请选择场站</h3>
                <p style="margin-top: 10px;">选择一个场站以开始本季度的结算数据录入与校对。</p>
            </div>
        </section>

        <!-- View: Library -->
        <section id="library" class="view-section">
            <div class="card">
                <h3 style="margin-top: 0; color: var(--color-cta);">标段价格对照库</h3>
                <p style="color: var(--color-text-muted); margin-bottom: 32px;">所有计价标准均来自中标合同附件。场站关联后，系统将自动基于场站容量(MW)派生对应价格指标。</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>标段编号</th>
                                <th>标段名称</th>
                                <th>执行场站数</th>
                                <th>结算模型</th>
                                <th>版本状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code style="background:var(--color-secondary); padding:4px 8px; border-radius:4px;">L001</code></td>
                                <td style="font-weight: 600;">2026-南宁及凭祥片区运维标</td>
                                <td>3</td>
                                <td>固定单价 + 季度包干</td>
                                <td><span style="color: var(--color-cta);">● 执行中 (V1.2)</span></td>
                            </tr>
                            <tr>
                                <td><code style="background:var(--color-secondary); padding:4px 8px; border-radius:4px;">L002</code></td>
                                <td style="font-weight: 600;">2026-崇左光伏专项运维标</td>
                                <td>1</td>
                                <td>按实结算</td>
                                <td><span style="color: var(--color-cta);">● 执行中 (V1.0)</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="history" class="view-section">
            <div class="card" style="text-align: center; padding: 120px 0; border-style: dashed;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                <p style="margin-top: 20px; color: var(--color-text-muted); font-size: 15px;">历史归档系统正在同步中，请稍后...</p>
            </div>
        </section>
    </main>

    <!-- Adjustment Modal -->
    <div id="adjustmentModal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-top: 0; color: var(--color-cta);">费用说明录入</h3>
            <p style="font-size: 14px; color: var(--color-text-muted); margin-bottom: 24px;">因该项金额偏离理论设定值，依《结算管理办法》必须在下面录入偏差说明或关联工作票证编号。</p>
            <textarea id="modalReason" rows="5" style="width: 100%; border-radius: 12px; border: 1px solid var(--color-border); background: var(--color-background); color: var(--color-text); padding: 16px; font-family: inherit; font-size: 14px; line-height: 1.6;" placeholder="请输入调整原因，例如：本季度因XX原因导致XX量变动，关联审批号#2026-001..."></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px;">
                <button onclick="closeModal()" style="background: transparent; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; opacity: 0.7;">暂不保存</button>
                <button onclick="confirmAdjustment()" class="btn-primary">保存说明并锁定</button>
            </div>
        </div>
    </div>

    <!-- Assessment Modal -->
    <div id="assessmentModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: var(--color-primary); padding: 40px; border-radius: 24px; width: 600px; border: 1px solid var(--color-border); box-shadow: var(--shadow-xl);">
            <h3 style="margin-top: 0; color: var(--color-danger);">导入考核与违约金</h3>
            <p style="font-size: 14px; color: var(--color-text-muted); margin-bottom: 24px;">系统将扫描关联项目的日常运行台账，自动提取本季度的考核扣款项。您可以手动核对扫描结果。</p>
            
            <div id="assessmentPreview" style="max-height: 300px; overflow-y: auto; margin-bottom: 24px;">
                <div style="text-align: center; padding: 40px; color: var(--color-text-muted); border: 1px dashed var(--color-border); border-radius: 12px;">
                    点击下方按钮模拟从《季度运行考核台账.xlsx》读取数据
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px;">
                <button onclick="closeAssessmentModal()" style="background: transparent; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; opacity: 0.7;">取消</button>
                <button onclick="simulateImport()" class="btn-primary" style="background: var(--color-secondary); color: var(--color-text); border: 1px solid var(--color-border);">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    扫描台账
                </button>
                <button id="confirmImportBtn" onclick="confirmImport()" class="btn-primary" disabled style="opacity: 0.5;">确认导入并结算</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">操作成功</div>

    <script>
        const priceTemplate = [
            { id: "1.1", name: "站长", unit: "元/人/月", defaultQty: 0, price: 21200, isLumpSum: false },
            { id: "1.2", name: "运检组长", unit: "元/人/月", price: 14840, isLumpSum: false },
            { id: "1.3", name: "运检人员", unit: "元/人/月", defaultQty: 36, price: 11660, isLumpSum: false },
            { id: "2.1", name: "工器具配备", unit: "元/MW/年", defaultQty: 65, price: 318, isLumpSum: true },
            { id: "2.2", name: "仪器仪表配备", unit: "元/MW/年", defaultQty: 65, price: 318, isLumpSum: true },
            { id: "2.3", name: "备品备件供应", unit: "元/MW/年", defaultQty: 65, price: 318, isLumpSum: false },
            { id: "2.4", name: "消耗品供应", unit: "元/MW/年", defaultQty: 65, price: 233.2, isLumpSum: true },
            { id: "3.3", name: "建构筑物维护费", unit: "元/站/年", defaultQty: 1, price: 10600, isLumpSum: true },
            { id: "4.8", name: "防雷检测", unit: "元/次", defaultQty: 1, price: 60950, isLumpSum: false },
            { id: "6.1", name: "交通费/车辆运行", unit: "元/辆/年", defaultQty: 1, price: 116600, isLumpSum: false },
            { id: "9.1", name: "预留暂列金", unit: "项", defaultQty: 1, price: 334000, isLumpSum: false, method: "据实结算" }
        ];

        // 模拟外部考核数据源
        const externalAssessmentTable = [
            { id: "K001", type: "安全考核", name: "未按规定穿戴劳保用品", amount: 500, date: "2026-01-15", reason: "大新龙门风电场审计发现" },
            { id: "K002", type: "运行考核", name: "AGC响应响应合格率不达标", amount: 1200.5, date: "2026-02-10", reason: "二月运行月报统计" },
            { id: "K003", type: "管理考核", name: "消缺及时率低于95%", amount: 3000, date: "2026-03-01", reason: "季度管理考评扣减" }
        ];

        let currentActiveItem = null;
        let settlementData = [];
        let assessmentItems = []; // 存储已导入的考核项

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(v => v.classList.remove('active'));
            
            document.getElementById(viewId).classList.add('active');
            const links = document.querySelectorAll('.nav-link');
            links.forEach(l => {
                if(l.getAttribute('onclick').includes(viewId)) l.classList.add('active');
            });
            
            const titles = {
                dashboard: "工作仪表盘",
                settlement: "季度结算申报",
                library: "合同标段库",
                history: "结算历史记录"
            };
            document.getElementById('pageTitle').innerText = titles[viewId];
        }

        function loadSettlementData() {
            const station = document.getElementById('stationSelect').value;
            if (!station) {
                document.getElementById('settlementTableArea').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            document.getElementById('settlementTableArea').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';

            settlementData = priceTemplate.map(item => {
                let annualTotal = item.price * (item.defaultQty || 0);
                let theory = item.isLumpSum ? (annualTotal / 4) : 0;
                let currentQty = item.isLumpSum ? 0.25 : 0;

                return {
                    ...item,
                    annualTotal: annualTotal,
                    qty: currentQty,
                    theory: theory,
                    adjust: 0,
                    actual: theory,
                    reason: ""
                };
            });

            renderTable();
        }

        /**
         * 渲染结算表格
         */
        function renderTable() {
            const body = document.getElementById('settlementBody');
            if (!body) return;
            body.innerHTML = '';
            let grandTotal = 0;

            // 1. 渲染常规合同项
            settlementData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const qtyHtml = row.isLumpSum 
                    ? `<span class="lump-sum-tag">季度包干 (0.25)</span>` 
                    : `<input type="number" class="qty-input" value="${row.qty}" onchange="updateQty(${index}, this.value)">`;

                const theoryVal = row.isLumpSum ? row.theory : (row.qty * row.price);
                const actual = theoryVal + row.adjust;
                grandTotal += actual;

                tr.innerHTML = `
                    <td style="color:var(--color-text-muted); font-size:12px;">${row.id}</td>
                    <td><div style="font-weight:600">${row.name}</div><div style="font-size:11px; color:var(--color-text-muted)">${row.isLumpSum ? '季度分摊包干' : '按实测算项目'}</div></td>
                    <td><span style="font-size:12px; background:var(--color-secondary); padding:2px 6px; border-radius:4px;">${row.unit}</span></td>
                    <td>¥ ${row.annualTotal.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td>${qtyHtml}</td>
                    <td style="color:var(--color-text-muted)">¥ ${theoryVal.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td><input type="number" class="adjust-input" value="${row.adjust}" onchange="updateAdjust(${index}, this.value)"></td>
                    <td style="font-weight:700; color:var(--color-text)">¥ ${actual.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td class="reason-cell" onclick="openAdjustmentModal(${index})">${row.reason || (row.adjust != 0 ? '<span style="color:var(--color-danger)">● 缺失说明</span>' : '-')}</td>
                `;
                body.appendChild(tr);
            });

            // 2. 渲染考核项（如有）
            const assessmentSum = renderAssessmentRows(body);
            grandTotal += assessmentSum;

            document.getElementById('footerTotal').innerText = `¥ ${grandTotal.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
        }

        /**
         * 渲染考核项列
         * @param {HTMLElement} body - 表格主体
         * @returns {number} 考核项总合计 (负数)
         */
        function renderAssessmentRows(body) {
            let assessmentTotal = 0;
            assessmentItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'assessment-row';
                const actual = -item.amount;
                assessmentTotal += actual;

                tr.innerHTML = `
                    <td style="color:var(--color-danger); font-size:12px;">${item.id}</td>
                    <td><div style="font-weight:600">${item.name}</div><div style="font-size:11px; opacity:0.8">${item.type} (${item.date})</div></td>
                    <td><span class="assessment-tag">扣罚项</span></td>
                    <td>-</td>
                    <td>1.0</td>
                    <td style="opacity:0.8">¥ -${item.amount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td>-</td>
                    <td style="font-weight:700">¥ ${actual.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td class="reason-cell" style="color:var(--color-danger)">${item.reason}</td>
                `;
                body.appendChild(tr);
            });
            return assessmentTotal;
        }

        /**
         * 更新原有的 renderTable 以包含考核项
         */
        function renderTable() {
            const body = document.getElementById('settlementBody');
            body.innerHTML = '';
            let grandTotal = 0;

            // 1. 渲染常规合同项
            settlementData.forEach((row, index) => {
                const tr = document.createElement('tr');
                const qtyHtml = row.isLumpSum 
                    ? `<span class="lump-sum-tag">季度包干 (0.25)</span>` 
                    : `<input type="number" class="qty-input" value="${row.qty}" onchange="updateQty(${index}, this.value)">`;

                const theoryVal = row.isLumpSum ? row.theory : (row.qty * row.price);
                const actual = theoryVal + row.adjust;
                grandTotal += actual;

                tr.innerHTML = `
                    <td style="color:var(--color-text-muted); font-size:12px;">${row.id}</td>
                    <td><div style="font-weight:600">${row.name}</div><div style="font-size:11px; color:var(--color-text-muted)">${row.isLumpSum ? '季度分摊包干' : '按实测算项目'}</div></td>
                    <td><span style="font-size:12px; background:var(--color-secondary); padding:2px 6px; border-radius:4px;">${row.unit}</span></td>
                    <td>¥ ${row.annualTotal.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td>${qtyHtml}</td>
                    <td style="color:var(--color-text-muted)">¥ ${theoryVal.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td><input type="number" class="adjust-input" value="${row.adjust}" onchange="updateAdjust(${index}, this.value)"></td>
                    <td style="font-weight:700; color:var(--color-text)">¥ ${actual.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td class="reason-cell" onclick="openAdjustmentModal(${index})">${row.reason || (row.adjust != 0 ? '<span style="color:var(--color-danger)">● 缺失说明</span>' : '-')}</td>
                `;
                body.appendChild(tr);
            });

            // 2. 渲染考核项（如有）
            const assessmentSum = renderAssessmentRows(body);
            grandTotal += assessmentSum;

            document.getElementById('footerTotal').innerText = `¥ ${grandTotal.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
        }

        function updateQty(index, val) {
            settlementData[index].qty = parseFloat(val) || 0;
            renderTable();
        }

        function updateAdjust(index, val) {
            const newVal = parseFloat(val) || 0;
            settlementData[index].adjust = newVal;
            if (newVal !== 0 && !settlementData[index].reason) {
                openAdjustmentModal(index);
            }
            renderTable();
        }

        function openAdjustmentModal(index) {
            currentActiveItem = index;
            document.getElementById('modalTitle').innerText = `审计说明: ${settlementData[index].name}`;
            document.getElementById('modalReason').value = settlementData[index].reason;
            document.getElementById('adjustmentModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('adjustmentModal').style.display = 'none';
        }

        function confirmAdjustment() {
            const reason = document.getElementById('modalReason').value;
            if (settlementData[currentActiveItem].adjust !== 0 && !reason.trim()) {
                alert("审计要求：手动调整类项目必须录入文字佐证。");
                return;
            }
            settlementData[currentActiveItem].reason = reason;
            closeModal();
            renderTable();
            showToast("理由已保存并关联至审计线索。");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            t.style.transform = 'translateY(0)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(100px)';
            }, 3000);
        }

        function submitFinal() {
            const missingReason = settlementData.some(d => d.adjust !== 0 && !d.reason.trim());
            if (missingReason) {
                alert("申报受阻：仍有“偏差项目”未填写审计说明，请检查红色标记项。");
                return;
            }
            showToast("成功！结算凭证已下推至甲方综合部复核。");
        }

        // Theme Toggle Logic
        function toggleTheme() {
            const body = document.body;
            const isLight = body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isLight = document.body.classList.contains('light-mode');
            const icon = document.getElementById('themeIcon');
            if (isLight) {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'; // Moon for light mode (means switch to dark)
            } else {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>'; // Sun for dark mode (means switch to light)
            }
        }

        // Initialize Theme
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            updateThemeIcon();
        })();

        // Initialize modal behavior
        window.onclick = function(event) {
            const adjustmentModal = document.getElementById('adjustmentModal');
            const assessmentModal = document.getElementById('assessmentModal');
            if (event.target == adjustmentModal) closeModal();
            if (event.target == assessmentModal) closeAssessmentModal();
        }

        /**
         * 考核项管理逻辑
         */
        function openAssessmentModal() {
            document.getElementById('assessmentModal').style.display = 'flex';
        }

        function closeAssessmentModal() {
            document.getElementById('assessmentModal').style.display = 'none';
        }

        function simulateImport() {
            const preview = document.getElementById('assessmentPreview');
            preview.innerHTML = `
                <table style="width:100%; font-size:13px; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid var(--color-border)">
                            <th style="padding:10px 0">类型</th>
                            <th>名称</th>
                            <th>金额</th>
                            <th>关联原因</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${externalAssessmentTable.map(item => `
                            <tr style="border-bottom:1px solid var(--color-border); opacity:0.9">
                                <td style="padding:12px 0; color:var(--color-danger)">${item.type}</td>
                                <td>${item.name}</td>
                                <td style="font-weight:700">¥ ${item.amount}</td>
                                <td style="font-size:11px; color:var(--color-text-muted)">${item.reason}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('confirmImportBtn').disabled = false;
            document.getElementById('confirmImportBtn').style.opacity = '1';
            showToast("扫描完成，发现 3 笔考核待处理。");
        }

        function confirmImport() {
            assessmentItems = [...externalAssessmentTable];
            renderTable();
            closeAssessmentModal();
            showToast("考核数据已成功导入结算单并完成冲抵。");
        }
    </script>
</body>
</html>
