<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>广西现货市场：新能源策略与限电分析系统</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

		body {
			font-family: 'Noto Sans SC', sans-serif;
			background-color: #F3F4F6;
		}

		/* Chart Container Styling - Mandatory per instructions */
		.chart-container {
			position: relative;
			width: 100%;
			max-width: 600px;
			/* Max width to prevent excessive stretching */
			margin-left: auto;
			margin-right: auto;
			height: 350px;
			/* Base height */
			max-height: 400px;
		}

		/* Custom scrollbar for text panels */
		.custom-scroll::-webkit-scrollbar {
			width: 6px;
		}

		.custom-scroll::-webkit-scrollbar-track {
			background: #f1f1f1;
		}

		.custom-scroll::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 3px;
		}

		.custom-scroll::-webkit-scrollbar-thumb:hover {
			background: #94a3b8;
		}

		.tab-active {
			border-bottom: 2px solid #0D9488;
			color: #0D9488;
			font-weight: 600;
		}

		.tab-inactive {
			color: #64748B;
			font-weight: 400;
		}

		.tab-inactive:hover {
			color: #0F766E;
		}
	</style>
	<!-- Chosen Palette: Teal & Slate (Teal representing Clean Energy/Grid, Slate for Engineering/Data) -->
</head>

<body class="text-slate-800">

	<!-- Application Structure Plan: 
         1. Header: Context and Title.
         2. Navigation: Tabs for "Rule Decoding", "Market Simulator", and "Strategy Analysis".
            - Logic: Users first need to understand the definitions (PDF content), then visualize the mechanism (Simulator), then apply it (Strategy).
         3. Main Content Area: Dynamic JS-driven views based on selected tab.
         4. Footer: References.
    -->

	<!-- Header -->
	<header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
			<div class="flex items-center gap-3">
				<div class="w-8 h-8 bg-teal-600 rounded flex items-center justify-center text-white font-bold">G</div>
				<h1 class="text-xl font-bold text-slate-900 tracking-tight">广西电力现货交易决策支持系统 <span
						class="text-xs font-normal text-slate-500 ml-2 border border-slate-200 px-2 py-0.5 rounded">基于2025实施细则V2.0</span>
				</h1>
			</div>
			<div class="hidden md:flex text-sm text-slate-500 gap-4">
				<span class="flex items-center">🔌 状态: 连续结算试运行</span>
				<span class="flex items-center">📊 节点: 广西电网</span>
			</div>
		</div>
	</header>

	<!-- Navigation -->
	<nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
		<div class="flex border-b border-slate-200 space-x-8" id="nav-tabs">
			<button onclick="switchTab('rules')" id="tab-rules"
				class="tab-active py-4 px-1 transition-colors duration-200">1. 规则图谱 & 交易模式</button>
			<button onclick="switchTab('simulator')" id="tab-simulator"
				class="tab-inactive py-4 px-1 transition-colors duration-200">2. 现货出清与限电模拟</button>
			<button onclick="switchTab('strategy')" id="tab-strategy"
				class="tab-inactive py-4 px-1 transition-colors duration-200">3. 报量报价策略分析</button>
		</div>
	</nav>

	<!-- Main Content -->
	<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen">

		<!-- VIEW 1: RULES DECODING -->
		<div id="view-rules" class="block animate-fade-in">
			<div class="mb-6">
				<h2 class="text-2xl font-bold text-slate-800 mb-2">广西现货市场核心机制解析</h2>
				<p class="text-slate-600 max-w-3xl">基于《广西电力市场现货电能量交易实施细则（2025年V2.0版）》，主要梳理新能源场站参与市场的五种模式及价格形成机制。</p>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
				<!-- Card 1: Key Definitions -->
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 col-span-1 lg:col-span-1">
					<h3 class="font-bold text-teal-700 mb-4 flex items-center">
						<span class="bg-teal-100 p-1 rounded mr-2 text-lg">📖</span> 关键术语定义
					</h3>
					<div class="space-y-4 text-sm text-slate-700 custom-scroll h-96 overflow-y-auto pr-2">
						<div class="p-3 bg-slate-50 rounded border-l-4 border-teal-500">
							<strong class="block text-slate-900 mb-1">节点边际电价 (LMP)</strong>
							<p>指在满足输电约束下，某节点增加单位负荷需增加的边际成本。LMP = 系统电能价格 + 阻塞价格。（细则Page 104）</p>
						</div>
						<div class="p-3 bg-slate-50 rounded border-l-4 border-amber-500">
							<strong class="block text-slate-900 mb-1">市场化机组</strong>
							<p>集中式新能源（风电、光伏）原则上需参与现货市场。水电、生物质暂不参与，作为边界条件。（细则Page 2）</p>
						</div>
						<div class="p-3 bg-slate-50 rounded border-l-4 border-blue-500">
							<strong class="block text-slate-900 mb-1">出清逻辑</strong>
							<p>以社会福利最大化为目标，全网统一出清。新能源优先消纳，但在阻塞或负荷低谷时面临市场化限电。</p>
						</div>
					</div>
				</div>

				<!-- Card 2: The 5 Participation Modes -->
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 col-span-1 lg:col-span-2">
					<h3 class="font-bold text-teal-700 mb-4 flex items-center">
						<span class="bg-teal-100 p-1 rounded mr-2 text-lg">🔄</span> 五类经营主体参与方式 (细则 1.4)
					</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<!-- Mode A -->
						<div class="border border-slate-200 rounded-lg p-4 hover:border-teal-400 transition-colors cursor-pointer group"
							onclick="highlightMode(1)">
							<div class="flex justify-between items-start">
								<h4 class="font-bold text-slate-800">1. 报量报价参与优化</h4>
								<span class="bg-teal-100 text-teal-800 text-xs px-2 py-1 rounded-full">推荐策略</span>
							</div>
							<p class="text-xs text-slate-500 mt-2">主体自主申报量价曲线。通过价格竞争决定是否中标。适合希望通过价格策略规避亏损或争取电量的主体。</p>
						</div>
						<!-- Mode B -->
						<div class="border border-slate-200 rounded-lg p-4 hover:border-teal-400 transition-colors cursor-pointer group"
							onclick="highlightMode(2)">
							<div class="flex justify-between items-start">
								<h4 class="font-bold text-slate-800">2. 报量不报价参与优化</h4>
								<span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-full">价格接受者</span>
							</div>
							<p class="text-xs text-slate-500 mt-2">自主申报曲线，全容量以<span
									class="font-bold text-red-500">市场申报价格下限</span>作为权重。优先出清，但在极度拥堵时按比例切负荷。</p>
						</div>
						<!-- Mode C -->
						<div class="border border-slate-200 rounded-lg p-4 opacity-60">
							<h4 class="font-bold text-slate-800 text-sm">3. 调度设置价格权重</h4>
							<p class="text-xs text-slate-500 mt-1">调度机构根据需求配置。</p>
						</div>
						<!-- Mode D -->
						<div class="border border-slate-200 rounded-lg p-4 opacity-60">
							<h4 class="font-bold text-slate-800 text-sm">4. 安全调节模式</h4>
							<p class="text-xs text-slate-500 mt-1">以基准计划执行，仅在安全越限时调整。</p>
						</div>
					</div>
					<div class="mt-4 p-3 bg-amber-50 text-amber-800 text-sm rounded flex items-start gap-2">
						<span>💡</span>
						<p><strong>核心洞察：</strong> 新能源场站主要在模式1和模式2中选择。选择“报量不报价”意味着你默认以此刻市场允许的最低价格（地板价）去争取出清，本质是“以价换量”。
						</p>
					</div>
				</div>
			</div>
		</div>

		<!-- VIEW 2: SIMULATOR -->
		<div id="view-simulator" class="hidden animate-fade-in">
			<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

				<!-- Controls Side -->
				<div class="lg:col-span-4 space-y-6">
					<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
						<h3 class="font-bold text-slate-800 mb-1">🔍 市场环境模拟器</h3>
						<p class="text-xs text-slate-500 mb-6">调整供需关系，观察现货价格(LMP)与限电情况的变化。</p>

						<!-- Control: System Load -->
						<div class="mb-6">
							<div class="flex justify-between mb-2">
								<label class="text-sm font-medium text-slate-700">系统负荷需求 (MW)</label>
								<span id="val-load" class="text-sm font-bold text-teal-600">6000</span>
							</div>
							<input type="range" id="input-load" min="3000" max="10000" value="6000" step="100"
								class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-teal-600"
								oninput="updateSimulation()">
						</div>

						<!-- Control: Renewable Output -->
						<div class="mb-6">
							<div class="flex justify-between mb-2">
								<label class="text-sm font-medium text-slate-700">全网新能源预测出力 (MW)</label>
								<span id="val-renewable" class="text-sm font-bold text-amber-500">2500</span>
							</div>
							<input type="range" id="input-renewable" min="500" max="6000" value="2500" step="100"
								class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
								oninput="updateSimulation()">
							<p class="text-xs text-slate-400 mt-1">模拟光伏大发或风电高峰时段</p>
						</div>

						<!-- Control: Coal/Gas Base -->
						<div class="mb-6">
							<div class="flex justify-between mb-2">
								<label class="text-sm font-medium text-slate-700">火电/必开机组基数 (MW)</label>
								<span id="val-thermal" class="text-sm font-bold text-slate-600">3000</span>
							</div>
							<input type="range" id="input-thermal" min="2000" max="5000" value="3000" step="100"
								class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500"
								oninput="updateSimulation()">
						</div>

						<div class="p-4 bg-slate-50 rounded border border-slate-200">
							<h4 class="text-sm font-bold text-slate-800 mb-2">模拟结果预测:</h4>
							<div class="flex justify-between items-center mb-1">
								<span class="text-sm text-slate-600">系统出清价 (SMP):</span>
								<span id="res-price" class="text-lg font-bold text-slate-800">350 元/MWh</span>
							</div>
							<div class="flex justify-between items-center">
								<span class="text-sm text-slate-600">新能源限电状态:</span>
								<span id="res-curtailment"
									class="text-sm font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded">全额消纳</span>
							</div>
						</div>
					</div>

					<!-- Theory Explanation -->
					<div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
						<h4 class="text-sm font-bold text-blue-800 mb-2">💡 经济学原理</h4>
						<p class="text-xs text-blue-700 leading-relaxed">
							当<span class="font-bold">新能源出力 + 必开火电 >
								系统负荷</span>时，供给过剩。根据边际出清原理，价格会跌至发电机组报价的下限（地板价）。此时若线路阻塞，LMP甚至可能为负（如果规则允许）或导致物理切机（限电）。
						</p>
					</div>
				</div>

				<!-- Visualization Side -->
				<div class="lg:col-span-8 space-y-6">
					<!-- Chart 1: Merit Order Stack -->
					<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
						<div class="flex justify-between items-center mb-4">
							<h3 class="font-bold text-slate-800">⚡ 电力市场出清堆栈图 (Merit Order)</h3>
							<div class="flex gap-2 text-xs">
								<span class="flex items-center"><span
										class="w-3 h-3 bg-amber-400 rounded-full mr-1"></span>新能源(低价)</span>
								<span class="flex items-center"><span
										class="w-3 h-3 bg-slate-400 rounded-full mr-1"></span>火电(高价)</span>
								<span class="flex items-center"><span
										class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>负荷需求</span>
							</div>
						</div>
						<!-- Chart Container -->
						<div class="chart-container">
							<canvas id="chartMeritOrder"></canvas>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- VIEW 3: STRATEGY ANALYSIS -->
		<div id="view-strategy" class="hidden animate-fade-in">
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

				<!-- Strategy Input -->
				<div class="col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
					<h3 class="font-bold text-teal-700 mb-6 border-b pb-2">🎯 您的场站报量报价策略配置</h3>

					<div class="space-y-6">
						<div>
							<label class="block text-sm font-bold text-slate-700 mb-2">选择交易模式</label>
							<div class="flex gap-2">
								<button onclick="setStrategyMode('taker')" id="btn-taker"
									class="flex-1 py-3 px-4 rounded border-2 border-teal-600 bg-teal-50 text-teal-800 font-bold text-sm transition-all">
									模式A: 报量不报价<br>
									<span class="text-xs font-normal opacity-75">(价格接受者)</span>
								</button>
								<button onclick="setStrategyMode('maker')" id="btn-maker"
									class="flex-1 py-3 px-4 rounded border border-slate-200 bg-white text-slate-600 font-medium text-sm transition-all hover:bg-slate-50">
									模式B: 报量报价<br>
									<span class="text-xs font-normal opacity-75">(策略博弈者)</span>
								</button>
							</div>
						</div>

						<div id="strategy-details"
							class="p-4 bg-slate-50 rounded border border-slate-200 transition-all">
							<h4 class="text-sm font-bold text-slate-800 mb-2">当前策略解析:</h4>
							<p id="strategy-desc" class="text-sm text-slate-600 leading-relaxed">
								您全额申报预测电量，并接受市场出清的任何价格。系统会将您的电量作为<span
									class="font-bold text-teal-600">最低价格权重</span>优先排序。
								<br><br>
								✅ 优势：在非极端拥堵情况下，最大化发电量。<br>
								⚠️ 风险：当发生严重拥堵，且所有人都报地板价时，您将面临按比例（Pro-rata）削减。
							</p>
						</div>

						<!-- Manual Bid Price Slider (Only for Maker) -->
						<div id="bid-price-control" class="opacity-50 pointer-events-none transition-opacity">
							<div class="flex justify-between mb-2">
								<label class="text-sm font-medium text-slate-700">自主申报价格 (元/MWh)</label>
								<span id="val-bid" class="text-sm font-bold text-teal-600">0</span>
							</div>
							<input type="range" id="input-bid" min="0" max="600" value="0" step="10"
								class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-teal-600"
								oninput="updateStrategyCalc()">
							<p class="text-xs text-slate-400 mt-1">若高于市场出清价(SMP)，您将无法中标（经济性弃电）。</p>
						</div>
					</div>
				</div>

				<!-- Strategy Outcome -->
				<div class="col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
					<h3 class="font-bold text-slate-800 mb-4">📊 策略效果预演 (基于当前模拟环境)</h3>

					<div class="grid grid-cols-2 gap-4 mb-6">
						<div class="p-4 bg-indigo-50 rounded text-center">
							<div class="text-xs text-indigo-500 uppercase font-bold tracking-wide mb-1">预计中标电量</div>
							<div id="res-volume" class="text-2xl font-bold text-indigo-700">100%</div>
							<div class="text-xs text-indigo-400 mt-1">无物理限电</div>
						</div>
						<div class="p-4 bg-emerald-50 rounded text-center">
							<div class="text-xs text-emerald-500 uppercase font-bold tracking-wide mb-1">预计小时收入</div>
							<div id="res-revenue" class="text-2xl font-bold text-emerald-700">¥ 8,750</div>
							<div class="text-xs text-emerald-400 mt-1">按当前SMP计算</div>
						</div>
					</div>

					<!-- Comparison Chart -->
					<div class="mt-4">
						<h4 class="text-sm font-bold text-slate-700 mb-3">策略对比：地板价 vs 高报</h4>
						<!-- Chart Container -->
						<div class="chart-container" style="height: 250px;">
							<canvas id="chartStrategyComp"></canvas>
						</div>
					</div>
				</div>

				<!-- Advice Section -->
				<div
					class="col-span-1 lg:col-span-2 bg-gradient-to-r from-teal-500 to-teal-700 p-6 rounded-xl text-white shadow-md">
					<h3 class="font-bold text-lg mb-2">🤖 专家策略建议</h3>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div>
							<h4 class="font-bold text-teal-100 mb-1">针对“弃风弃光”风险：</h4>
							<p class="text-sm text-teal-50 opacity-90 leading-relaxed">
								若该节点历史LMP经常触底，建议采用<span
									class="font-bold underline">“报量不报价”</span>模式，确保获得优先调度序列。若预测发生严重阻塞（LMP极低甚至为负），且您有调节能力，可考虑在“报量报价”模式下申报略高于地板价，主动避免在负电价时段发电（视具体规则是否允许负电价而定）。
							</p>
						</div>
						<div>
							<h4 class="font-bold text-teal-100 mb-1">提升收益关键：</h4>
							<p class="text-sm text-teal-50 opacity-90 leading-relaxed">
								现货市场的核心是<span
									class="font-bold">预测精度</span>。尽量缩小“日前申报曲线”与“实时实际出力”的偏差。偏差过大将面临高额的偏差考核费用，抵消现货收益。
							</p>
						</div>
					</div>
				</div>

			</div>
		</div>

	</main>

	<!-- Footer -->
	<footer class="bg-slate-800 text-slate-400 py-8 mt-8">
		<div class="max-w-7xl mx-auto px-4 text-center">
			<p class="text-sm mb-2">本工具基于公开的《广西电力市场现货电能量交易实施细则（2025年V2.0版）》设计</p>
			<p class="text-xs opacity-60">
				<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
				<!-- Visualization & Content Choices: 
                     1. Merit Order Chart (Line/Area fill): Goals -> Visualize clearing price mechanism. Interaction -> Sliders. Lib -> Chart.js.
                     2. Comparison Bar Chart: Goal -> Compare revenue outcomes. Lib -> Chart.js.
                     3. Interactive Cards: HTML/Tailwind for mode selection.
                -->
				Generated for educational simulation purposes.
			</p>
		</div>
	</footer>

	<script>
		// State Management
		let appState = {
			systemLoad: 6000,
			renewableOutput: 2500,
			thermalBase: 3000, // Non-flexible thermal/hydro
			clearingPrice: 400,
			curtailment: 0,

			userStrategy: 'taker', // 'taker' or 'maker'
			userBidPrice: 0, // For 'maker' mode
			userCapacity: 100, // MW, assumed single station capacity

			marketFloor: 50, // Assumed floor price
			marketCap: 1000, // Assumed cap
			coalCost: 350, // Marginal cost of coal
		};

		// Charts Instances
		let meritChart = null;
		let strategyChart = null;

		// --- Initialization ---
		document.addEventListener('DOMContentLoaded', () => {
			initMeritOrderChart();
			initStrategyChart();
			updateSimulation();
		});

		// --- Navigation Logic ---
		function switchTab(tabId) {
			// Hide all views
			['rules', 'simulator', 'strategy'].forEach(id => {
				document.getElementById(`view-${id}`).classList.add('hidden');
				document.getElementById(`view-${id}`).classList.remove('block');

				// Update button styles
				const btn = document.getElementById(`tab-${id}`);
				if (id === tabId) {
					btn.classList.remove('tab-inactive');
					btn.classList.add('tab-active');
				} else {
					btn.classList.add('tab-inactive');
					btn.classList.remove('tab-active');
				}
			});

			// Show selected view
			document.getElementById(`view-${tabId}`).classList.remove('hidden');
			document.getElementById(`view-${tabId}`).classList.add('block');

			// Resize charts if becoming visible
			if (tabId === 'simulator' && meritChart) meritChart.resize();
			if (tabId === 'strategy' && strategyChart) strategyChart.resize();
		}

		// --- Simulator Logic ---
		function updateSimulation() {
			// Get Inputs
			appState.systemLoad = parseInt(document.getElementById('input-load').value);
			appState.renewableOutput = parseInt(document.getElementById('input-renewable').value);
			appState.thermalBase = parseInt(document.getElementById('input-thermal').value);

			// Update DOM text
			document.getElementById('val-load').innerText = appState.systemLoad;
			document.getElementById('val-renewable').innerText = appState.renewableOutput;
			document.getElementById('val-thermal').innerText = appState.thermalBase;

			// Calculate Clearing Logic (Simplified Merit Order)
			// Stack: 1. Renewables (0 cost/Floor) -> 2. Thermal Base -> 3. Expensive Peakers

			let totalSupplyLowCost = appState.renewableOutput; // Bid at floor
			let totalSupplyMidCost = appState.renewableOutput + appState.thermalBase; // Bid around 350

			// Determine Price & Curtailment
			if (appState.systemLoad < totalSupplyLowCost) {
				// Surplus of renewable energy
				appState.clearingPrice = appState.marketFloor; // Price crashes to floor
				appState.curtailment = totalSupplyLowCost - appState.systemLoad; // Amount to cut

				document.getElementById('res-price').innerText = `${appState.marketFloor} 元/MWh (地板价)`;
				document.getElementById('res-price').className = "text-lg font-bold text-red-600";

				document.getElementById('res-curtailment').innerText = `⚠️ 市场化限电: ${appState.curtailment} MW`;
				document.getElementById('res-curtailment').className = "text-sm font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded";

			} else if (appState.systemLoad < totalSupplyMidCost) {
				// Renewables cleared, Thermal setting price
				appState.clearingPrice = appState.coalCost + ((appState.systemLoad - totalSupplyLowCost) / appState.thermalBase) * 100; // Linear increase
				appState.curtailment = 0;

				document.getElementById('res-price').innerText = `${Math.round(appState.clearingPrice)} 元/MWh`;
				document.getElementById('res-price').className = "text-lg font-bold text-slate-800";

				document.getElementById('res-curtailment').innerText = "全额消纳";
				document.getElementById('res-curtailment').className = "text-sm font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded";
			} else {
				// Scarcity
				appState.clearingPrice = appState.marketCap;
				appState.curtailment = 0;
				document.getElementById('res-price').innerText = `${appState.marketCap} 元/MWh (顶格)`;
				document.getElementById('res-price').className = "text-lg font-bold text-amber-600";
				document.getElementById('res-curtailment').innerText = "全额消纳";
				document.getElementById('res-curtailment').className = "text-sm font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded";
			}

			updateMeritChart();
			updateStrategyCalc();
		}

		// --- Chart 1: Merit Order ---
		function initMeritOrderChart() {
			const ctx = document.getElementById('chartMeritOrder').getContext('2d');
			meritChart = new Chart(ctx, {
				type: 'line',
				data: {
					datasets: [
						{
							label: '市场供给曲线',
							data: [],
							borderColor: '#0D9488', // Teal
							backgroundColor: 'rgba(13, 148, 136, 0.1)',
							borderWidth: 2,
							stepped: true,
							fill: true,
							pointRadius: 0
						},
						{
							label: '系统负荷需求',
							data: [],
							borderColor: '#EF4444', // Red
							borderWidth: 2,
							borderDash: [5, 5],
							pointRadius: 0,
							fill: false
						}
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						x: {
							type: 'linear',
							title: { display: true, text: '累计电量 (MW)' },
							min: 0,
							max: 10000
						},
						y: {
							title: { display: true, text: '报价 (元/MWh)' },
							min: 0,
							max: 1000
						}
					},
					plugins: {
						tooltip: {
							callbacks: {
								label: function (context) {
									return `价格: ${context.parsed.y} 元, 容量: ${context.parsed.x} MW`;
								}
							}
						}
					}
				}
			});
		}

		function updateMeritChart() {
			if (!meritChart) return;

			// Construct Stepped Curve
			// Step 1: Renewable (Vol: renewableOutput, Price: Floor)
			// Step 2: Thermal (Vol: thermalBase, Price: Increases)

			const dataPoints = [
				{ x: 0, y: appState.marketFloor },
				{ x: appState.renewableOutput, y: appState.marketFloor }, // End of renewable block
				{ x: appState.renewableOutput, y: appState.coalCost }, // Start of thermal block
				{ x: appState.renewableOutput + appState.thermalBase, y: 600 }, // End of thermal block
				{ x: 10000, y: 1000 } // Cap
			];

			// Demand Line (Vertical line essentially, but drawn as a small segment crossing the supply)
			const demandPoints = [
				{ x: appState.systemLoad, y: 0 },
				{ x: appState.systemLoad, y: 1000 }
			];

			meritChart.data.datasets[0].data = dataPoints;
			meritChart.data.datasets[1].data = demandPoints;
			meritChart.update();
		}

		// --- Strategy Logic ---
		function setStrategyMode(mode) {
			appState.userStrategy = mode;

			// UI Toggle
			const btnTaker = document.getElementById('btn-taker');
			const btnMaker = document.getElementById('btn-maker');
			const desc = document.getElementById('strategy-desc');
			const sliderDiv = document.getElementById('bid-price-control');

			if (mode === 'taker') {
				btnTaker.className = "flex-1 py-3 px-4 rounded border-2 border-teal-600 bg-teal-50 text-teal-800 font-bold text-sm transition-all";
				btnMaker.className = "flex-1 py-3 px-4 rounded border border-slate-200 bg-white text-slate-600 font-medium text-sm transition-all hover:bg-slate-50";

				desc.innerHTML = `您全额申报预测电量，并接受市场出清的任何价格。系统会将您的电量作为<span class="font-bold text-teal-600">最低价格权重</span>优先排序。<br><br>✅ 优势：在非极端拥堵情况下，最大化发电量。<br>⚠️ 风险：当发生严重拥堵，且所有人都报地板价时，您将面临按比例（Pro-rata）削减。`;

				sliderDiv.classList.add('opacity-50', 'pointer-events-none');
				appState.userBidPrice = appState.marketFloor; // Reset to floor logic
			} else {
				btnMaker.className = "flex-1 py-3 px-4 rounded border-2 border-amber-500 bg-amber-50 text-amber-800 font-bold text-sm transition-all";
				btnTaker.className = "flex-1 py-3 px-4 rounded border border-slate-200 bg-white text-slate-600 font-medium text-sm transition-all hover:bg-slate-50";

				desc.innerHTML = `您自主设定申报价格。如果市场出清价低于您的报价，您将无法中标（经济性弃电）。<br><br>✅ 优势：避免在价格低于成本（或负电价）时发电。<br>⚠️ 风险：若报价过高，可能导致全额弃电，损失所有电量收益。`;

				sliderDiv.classList.remove('opacity-50', 'pointer-events-none');
			}
			updateStrategyCalc();
		}

		function updateStrategyCalc() {
			if (appState.userStrategy === 'maker') {
				appState.userBidPrice = parseInt(document.getElementById('input-bid').value);
				document.getElementById('val-bid').innerText = appState.userBidPrice;
			}

			// Calculation Logic
			// If User Bid > Clearing Price -> 0 Volume
			// If User Bid <= Clearing Price -> 
			//    If Curtailment > 0 (Price == Floor), then reduce volume pro-rata
			//    Else Full Volume

			let userVol = appState.userCapacity;

			if (appState.userBidPrice > appState.clearingPrice) {
				// Priced out
				userVol = 0;
			} else {
				// Cleared by price, check capacity constraints
				if (appState.curtailment > 0 && appState.clearingPrice === appState.marketFloor) {
					// Everyone is at floor, assume pro-rata curtailment
					// Curtailment Ratio = (Total Supply - Load) / Total Supply
					let totalRenewable = appState.renewableOutput;
					let ratio = (totalRenewable - appState.systemLoad) / totalRenewable;
					if (ratio < 0) ratio = 0;
					userVol = appState.userCapacity * (1 - ratio);
				}
			}

			let revenue = Math.round(userVol * appState.clearingPrice);

			document.getElementById('res-volume').innerText = `${Math.round(userVol)} MW`;
			document.getElementById('res-volume').nextElementSibling.innerText = userVol < appState.userCapacity ? `限电/未中标: ${Math.round(appState.userCapacity - userVol)} MW` : '无物理限电';

			document.getElementById('res-revenue').innerText = `¥ ${revenue.toLocaleString()}`;

			updateComparisonChart(revenue);
		}

		// --- Chart 2: Strategy Comparison ---
		function initStrategyChart() {
			const ctx = document.getElementById('chartStrategyComp').getContext('2d');
			strategyChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: ['当前策略', '理想无限电'],
					datasets: [{
						label: '预估小时收入 (元)',
						data: [0, 0],
						backgroundColor: ['#0D9488', '#E2E8F0'],
						borderRadius: 4
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: { beginAtZero: true }
					}
				}
			});
		}

		function updateComparisonChart(currentRevenue) {
			if (!strategyChart) return;
			// Benchmark: Full capacity at current price (if no curtailment existed)
			let potential = appState.userCapacity * appState.clearingPrice;

			strategyChart.data.datasets[0].data = [currentRevenue, potential];
			// Color update based on performance
			if (currentRevenue < potential * 0.8) {
				strategyChart.data.datasets[0].backgroundColor[0] = '#EF4444'; // Red if heavy loss
			} else {
				strategyChart.data.datasets[0].backgroundColor[0] = '#0D9488'; // Teal if good
			}
			strategyChart.update();
		}

	</script>
</body>

</html>