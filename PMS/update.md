# 计划管理系统更新记录

## 已完成功能

- [x] 报表导出 (Excel) ✅
- [x] 红黄牌定时任务 (APScheduler)
- [x] 申诉流程完善 (全栈实现)
- [x] **Bug 修复 (高优先级)**:
  - [x] 修复点击「绩效统计」报错问题 (Phase 1)
  - [x] 修复「任务管理」导出报表失败问题 (Phase 1)
  - [x] 修复「我的任务」中看不到“待验收”任务的问题 (Phase 1)
- [x] **逻辑与校验优化**:
  - [x] 进度更新校验：禁止进度倒退（需提示），日期不能早于当日（早于当日需审批）
  - [x] 任务时间精度：开始、结束时间精确到年、月、日、小时 ✅
  - [x] 状态回退：允许从「待验收」状态回退至「进行中」
  - [x] 自动逻辑：提交验收时，任务进度强制设为 100%
  - [x] 校验：结束时间不能早于开始时间；输入日期错误时自动提示
- [ ] **UI/UX 增强**:
  - [x] 仪表盘优化：增加「待审批」统计，支持点击穿透进入相关任务列表
  - [x] 流程合并：将“创建任务”与“提交审批”整合在同一个页面
  - [x] 审批 UI：提供点选选项来评判 I/D 系数，并增加计算提示
- [x] UI/UX 体验重塑 (全站 Glassmorphism)

### 2026-02-08 06:40 - UI/UX 体验重塑 & 流程优化 ✅

- [x] 基于 UI-UX Pro Max 完成全站 Glassmorphism 风格升级
- [x] 集成 Poppins & Open Sans 字体系统
- [x] 深度优化任务列表、绩效看板、登录页面的视觉质感
- [x] 完善红牌申诉全链路交互
- [x] 增强 PC/移动端 响应式一致性

### 2026-02-08 06:45 - 部署脚本优化 ✅

- [x] 优化 `start.sh`：增加 Docker 环境自动检测
- [x] 优化 `start.sh`：增加 Docker Compose 版本自适应 (v1/v2)
- [x] 优化 `start.sh`：增加数据库 (5432) 与前端 (5173) 端口就绪等待逻辑

### 2026-02-08 08:25 - 后端健壮性修复 ✅

- [x] 修复任务创建时的日期解析错误：后端 Schema 已适配前端发送的 `YYYY-MM-DD` 格式。

### 2026-02-08 10:30 - 系统功能优化 & 核心反馈落实 ✅

- [x] 名称统一更改为「计划管理系统」，提升品牌感
- [x] 得分算法逻辑优化：引入「完成度系数」，完成度为 0% 时得分为 0
- [x] 任务表单升级：支持「直接提交审批」与「编辑草稿」在同一页面完成，增强操作连贯性
- [x] 侧边栏交互优化：取消隐藏文字功能，确保导航标签在 PC 端始终可见，提升可用性
- [x] 流程优化：
  - 增加「回撤申请」功能，允许在待验收状态回退至进行中
  - 强制「提交验收」任务记录当前进度，不再硬性覆盖为 100%
- [x] 数据校验增强：
  - 任务计划结束日期不能早于开始日期
  - 录入日期早于当日时自动提示（创建时）
- [x] 稳定性修复：
  - 修复 KPI 页面语法错误导致的无法访问
  - 修复逾期检查任务中 AppealStatus 缺失的 NameError

### **已完成 (2026-02-08 14:55)**

- **时间精度升级**：
  - [x] 后端 Task 模型及 Schema 升级为 DateTime 类型，支持精确到分钟。
  - [x] 前端任务表单使用 `datetime-local` 组件，支持小时/分钟选择。
- **进度更新校验**：
  - [x] 后端 `update_progress` 防倒退校验。
  - [x] 前端实时进度回退警告。
- **日期合法性校验**：
  - [x] 前端实时校验结束时间 >= 开始时间，错误提示红字显示。
  - [x] 后端 Schema 增加 Validator 兜底校验。
- **验收自动化**：
  - [x] 提交验收 (`complete_task`) 自动将进度设为 100%。

✅ 2026年2月8日 20:30 「附件系统升级」支持多文件、元数据记录、下载统计、类型/大小配置 ✅

- [x] 附件元数据保存至数据库 (`Attachment` 模型)
- [x] 支持在「更新进展」和「提交验收」时上传多个附件
- [x] 增加附件下载功能，并自动统计下载次数
- [x] 附件展示增强：显示文件名、大小、上传时间、下载次数，支持图片在线预览
- [x] 附件配置化：支持通过 `Settings` 设置最大文件大小 (20MB) 和 允许的文件类型
- [x] 任务日志/历史记录 UI 增强：使用列表/平铺形式展示多个附件，样式适配 Glassmorphism

- [x] ✅ 2026年2月8日 20:59 增加下载附件的功能
✅ 2026年2月8日 21:00 「进展说明」为必填
✅ 2026年2月8日 21:02 要将任务更新至100%才允许提交
✅ 2026年2月8日 21:02 未显示附件上传时间
✅ 2026年2月8日 21:02 附件可以上传多个
✅ 2026年2月8日 21:02 注明附件上传时间，下载次数
✅ 2026年2月9日 20:12 与 GitHub 同步数据完成

## 待完成功能

组织架构管理页面
系统设置页面 (Admin)

**功能扩展**:
支持任务分类自定义及任务批量导入
支持一个人拥有多种权限角色

## 其他问题

进度回退无法提交
可以默认选择当前日期时间
「更新进展」可以提交进度倒退，提示确认，并视为工作完成质量不好的指标
任务提交选择接收人
负责人可以「回撤申请」，主管可以「退回」，然后任务进入负责人进行中的工作
每个任务应挂钩「责任人」
点击仪表盘相关任务，自动与点选类型挂钩，比如「待审批」，穿透后看到的就是「待审批」项目
「任务管理」可以查看任务的难度、用时、重要性等信息
明
任务详情：增加「任务进展」专门视图，记录更新人及历史动态 ❌未完成
增加申请延期功能
附件可以一个一个上传，也可以批量上传
附件保存到数据库
增加查看图片的功能 ❌未完成
可以设置上传附件类型、附件的的大小 ❌未完成
任务日志改为列表的形式，展示附件、完成人、完成时间、百分比等 ❌未完成

审批 UI 与穿透交互 (体验优化)

权限体系与组织架构 (系统底座)

## 规划

必填项UI提示
权限与角色精细化控制优化 (Ongoing)
组织架构管理页面 (Admin)
AI Skill 辅助任务难度自动评级
日志功能（登录日志、使用日志、告警日志）
PWA 离线支持
AI Skill 申诉评判

### 核心底层：重构多角色与责任人逻辑

请重构系统的权限与任务模型。
权限重构：修改 User 模型，支持一个用户关联多个 Role（多对多关系）。例如：杨杰可以同时拥有‘部门主管’和‘任务负责人’角色。
责任人逻辑：在任务（Task）模型中明确 owner_id (责任人) 和 creator_id (创建者)。
流转逻辑：实现负责人‘回撤申请’功能（仅限状态为待审批时），以及主管‘退回任务’功能。退回后任务状态重置为‘进行中’。
代码要求：请输出更新后的 Prisma Schema（或数据库迁移脚本）以及对应的后端逻辑函数。确保逻辑严密，防止越权操作。

### 交互闭环：进度回退确认与附件管理

解决“进度回退无法提交”及附件保存问题。
优化任务提交与附件管理功能：
进度回退逻辑：在‘更新进展’页面，如果用户输入的百分比低于当前值，提交时弹出确认窗：‘当前进度低于已有进度，提交将记录为工作质量不佳指标，是否继续？’。确认后允许提交，并在数据库记录该异常标记。
默认时间：所有日期选择组件默认填充当前系统日期时间。
附件系统：实现附件批量上传功能，文件信息保存至数据库 Attachments 表，支持常见的图片格式预览。
UI 要求：使用毛玻璃质感组件，附件列表采用列表形式展示（包含文件名、上传人、上传时间、大小）。

### 系统底座：组织架构 Admin 页面

目标： 利用树形组件构建部门管理系统。
新建一个组织架构管理（Admin）页面：
组件选型：使用递归树形组件（Tree Component）展示公司部门层级。
功能要求：支持在树节点上直接进行‘新增子部门’、‘编辑名称’和‘删除部门（需校验下方无人员）’的操作。
自动化关联：编写逻辑，当新任务创建时，系统根据负责人的 user_id 自动查询其所属部门，并填充任务的 department_id 字段。
视觉规范：遵循 UI-UX Pro Max 规范，使用 Poppins 字体，背景保持半透明毛玻璃效果，操作按钮需有清晰的视觉反馈。
