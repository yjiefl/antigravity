# 计划管理系统更新记录

## 已完成功能

- [x] 报表导出 (Excel) ✅
- [x] 红黄牌定时任务 (APScheduler)
- [x] 申诉流程完善 (全栈实现)
- [x] Bug 修复 (高优先级):
  - [x] 修复点击「绩效统计」报错问题 (Phase 1)
  - [x] 修复「任务管理」导出报表失败问题 (Phase 1)
  - [x] 修复「我的任务」中看不到“待验收”任务的问题 (Phase 1)
- [x] 逻辑与校验优化:
  - [x] 进度更新校验：禁止进度倒退（需提示），日期不能早于当日（早于当日需审批）
  - [x] 任务时间精度：开始、结束时间精确到年、月、日、小时 ✅
  - [x] 状态回退：允许从「待验收」状态回退至「进行中」✅
  - [x] 自动逻辑：提交验收时，任务进度强制设为 100%
  - [x] 校验：结束时间不能早于开始时间；输入日期错误时自动提示
- [ ] UI/UX 增强:
  - [x] 仪表盘优化：增加「待审批」统计，支持点击穿透进入相关任务列表
  - [x] 流程合并：将“创建任务”与“提交审批”整合在同一个页面
  - [x] 审批 UI：提供点选选项来评判 I/D 系数，并增加计算提示
- [x] UI/UX 体验重塑 (全站 Glassmorphism)

### 2026-02-08 06:40 - UI/UX 体验重塑 & 流程优化 ✅

- [x] 基于 UI-UX Pro Max 完成全站 Glassmorphism 风格升级
- [x] 集成 Poppins & Open Sans 字体系统
- [x] 深度优化任务列表、绩效看板、登录页面的视觉质感
- [x] 完善红牌申诉全链路交互
- [x] 增强 PC/移动端 响应式一致性

### 2026-02-08 06:45 - 部署脚本优化 ✅

- [x] 优化 `start.sh`：增加 Docker 环境自动检测
- [x] 优化 `start.sh`：增加 Docker Compose 版本自适应 (v1/v2)
- [x] 优化 `start.sh`：增加数据库 (5432) 与前端 (5173) 端口就绪等待逻辑

### 2026-02-08 08:25 - 后端健壮性修复 ✅

- [x] 修复任务创建时的日期解析错误：后端 Schema 已适配前端发送的 `YYYY-MM-DD` 格式。

### 2026-02-08 10:30 - 系统功能优化 & 核心反馈落实 ✅

- [x] 名称统一更改为「计划管理系统」，提升品牌感
- [x] 得分算法逻辑优化：引入「完成度系数」，完成度为 0% 时得分为 0
- [x] 任务表单升级：支持「直接提交审批」与「编辑草稿」在同一页面完成，增强操作连贯性
- [x] 侧边栏交互优化：取消隐藏文字功能，确保导航标签在 PC 端始终可见，提升可用性
- [x] 流程优化：
  - 增加「回撤申请」功能，允许在待验收状态回退至进行中
  - 强制「提交验收」任务记录当前进度，不再硬性覆盖为 100%
- [x] 数据校验增强：
  - 任务计划结束日期不能早于开始日期
  - 录入日期早于当日时自动提示（创建时）
- [x] 稳定性修复：
  - 修复 KPI 页面语法错误导致的无法访问
  - 修复逾期检查任务中 AppealStatus 缺失的 NameError

### 已完成 (2026-02-08 14:55)

- 时间精度升级：
  - [x] 后端 Task 模型及 Schema 升级为 DateTime 类型，支持精确到分钟。
  - [x] 前端任务表单使用 `datetime-local` 组件，支持小时/分钟选择。
- 进度更新校验：
  - [x] 后端 `update_progress` 防倒退校验。
  - [x] 前端实时进度回退警告。
- 日期合法性校验：
  - [x] 前端实时校验结束时间 >= 开始时间，错误提示红字显示。
  - [x] 后端 Schema 增加 Validator 兜底校验。
- 验收自动化：
  - [x] 提交验收 (`complete_task`) 自动将进度设为 100%。

✅ 2026年2月8日 20:30 「附件系统升级」支持多文件、元数据记录、下载统计、类型/大小配置 ✅

- [x] 附件元数据保存至数据库 (`Attachment` 模型)
- [x] 支持在「更新进展」和「提交验收」时上传多个附件
- [x] 增加附件下载功能，并自动统计下载次数
- [x] 附件展示增强：显示文件名、大小、上传时间、下载次数，支持图片在线预览
- [x] 附件配置化：支持通过 `Settings` 设置最大文件大小 (20MB) 和 允许的文件类型
- [x] 任务日志/历史记录 UI 增强：使用列表/平铺形式展示多个附件，样式适配 Glassmorphism

- [x] ✅ 2026年2月8日 20:59 增加下载附件的功能
      ✅ 2026年2月8日 21:00 「进展说明」为必填
      ✅ 2026年2月8日 21:02 要将任务更新至100%才允许提交
      ✅ 2026年2月8日 21:02 未显示附件上传时间
      ✅ 2026年2月8日 21:02 附件可以上传多个
      ✅ 2026年2月8日 21:02 注明附件上传时间，下载次数
      ✅ 2026年2月9日 20:12 与 GitHub 同步数据完成

### 2026-02-09 20:38 - 核心逻辑优化、交互改进与组织架构管理 ✅

- [x] 核心逻辑重构:
  - [x] 用户模型支持多角色 (User Roles Refactoring)
  - [x] 任务模型明确 `owner_id` (负责人) 与 `creator_id` (创建者)
  - [x] 实现「撤回申请」功能 (Creator/Owner)
  - [x] 实现「退回任务」功能 (Manager)

- [x] 交互与附件改进:
  - [x] 进度回退逻辑：允许进度回退，但在前端增加二次确认提示
  - [x] 默认日期优化：新建任务时，计划开始/结束时间默认为当前时间
  - [x] 附件系统：已集成批量上传、数据库存储及列表预览功能

- [x] 组织架构管理 (Admin):
  - [x] 新增「组织架构管理」页面 (`/admin/org`)
  - [x] 实现递归树形组件 (`OrgTreeItem`) 展示公司-部门-岗位结构
  - [x] 支持部门/岗位的增删改查操作
  - [x] 自动关联：创建任务时自动填充部门信息

- [x] 进度回退无法提交 ✅ 2026年2月9日 21:14
- [x] 可以默认选择当前日期时间 ✅ （时间正确）
- [x] 「更新进展」可以提交进度倒退，提示确认，并视为工作完成质量不好的指标 ✅
- [x] 负责人可以「回撤申请」，然后任务进入负责人进行中的工作 ✅ （主管无法退回）2026年2月9日 21:44
- [x] 撤回申请：提交审批后，点击“撤回申请”，确认状态变回“草稿”。（✅）2026年2月9日 21:44
- [x] 进度回退：在“进行中”状态更新进度，输入比当前小的数值，确认弹出提示框，点击确认后提交成功。（✅）2026年2月9日 21:44
- [x] 在“更新进展”时上传 2 个以上文件。（✅可以分开上传）2026年2月9日 21:44
- [x] 退回任务：主管在“待审批”或“待验收”状态下点击“退回”，确认状态流转正确。（✅）2026年2月9日 21:44
- [x] 进入 `/admin/org` 页面。 ✅2026年2月9日 21:44
- [x] 提交后查看日志列表，确认附件是否显示。（附件图标显示有问题，无法识别图片）（✅）2026年2月9日 21:59
- [x] 点击图片附件，确认是否可以预览。（✅）2026年2月9日 21:59
- [x] 点击仪表盘相关任务，自动与点选类型挂钩，比如「待审批」，穿透后看到的就是「待审批」项目 ✅2026年2月9日 21:59
- [x] 组织架构管理页面 (Admin) ✅ (2026-02-09 完成)
- [x] 系统设置页面 (Admin) ✅ (组织架构管理已作为核心Admin功能上线)
- [x] 支持一个人拥有多种权限角色 ✅
- [x] 任务提交选择接收人 (当前由系统自动根据部门/岗位分配，或默认为空需认领？目前逻辑已改为指定) ✅ [ ] 支持任务分类自定义及任务批量导入 ❌
- [x] 「任务管理」可以查看任务的难度、用时、重要性等信息 ✅
- [x] 任务详情：增加「任务进展」专门视图，记录更新人及历史动态 (日志列表已支持，独立视图待定) ✅
- [x] 增加申请延期功能 ✅
- [x] 附件可以一个一个上传，也可以批量上传 ✅
- [x] 任务日志改为列表的形式，展示附件、完成人、完成时间、百分比等 ✅
- [x] 权限体系与组织架构 (系统底座) ✅
- [x] 禁用用户可以操作 ✅2026年2月10日 05:43
- [x] 被禁用的用户无法登陆 ✅2026年2月10日 05:44
- [x] 简化了用户管理功能，取消了邮箱和手机号的录入。 ✅2026年2月10日 05:59
      后端: 更新了 Pydantic 校验模式，移除了 email 和 phone 字段。
      前端: 移除了新增/编辑用户弹窗中的邮箱和手机号输入框。取消了用户列表中的相关展示。简化的逻辑，不再处理这两个字段。
- [x] 新建任务：验证默认时间是否为当前时间；（有默认时间✅）
- [x] 尝试在部门下添加一个岗位。✅2026年2月10日 06:07
- [x] 验证当前用户是否具有多重身份 (可查看 Network 请求 `/api/users/me` 响应中的 roles 字段)。 ✅2026年2月10日 06:07
- [x] 审计日志功能已完成！已实现功能：✅2026年2月10日 06:17
      ✅ 后端审计日志模型和 API
      ✅ 登录成功/失败的审计记录
      ✅ 用户管理操作的审计记录（创建、启用/禁用、重置密码）
      ✅ 数据库表已创建
      ✅ 后端服务已重启
      ✅ 前端审计日志页面（/admin/audit）
- [x] 任务缺少创建人、负责人等信息 ✅2026年2月10日 06:17
- [x] 日志功能（登录日志、使用日志、告警日志）✅2026年2月10日 06:21

### ✅ 2026年2月10日 21:48 第一阶段：夯实底座（解决现有 Bug 与逻辑漏洞） 进行中

- [x] 修复组织架构管理 Bug ✅
- [x] 纠正审批权限偏离 ✅
- [x] 引入“待提交”状态 ✅
- [x] 完善岗位库编辑 ✅
- [x] 修复 `appeals.py` 权限判断 Bug ✅
修复组织架构管理： _解决部门编辑无法保存、新增公司/部门报错的问题。这是系统的“根”，根不稳定，权限校验就会失效。 ✅ 2026年2月10日 21:44
纠正审批权限偏离：_ 目前存在“审批权限与选择不对应”的问题。需重新梳理 Position 与 Task 的关联逻辑，确保只有该任务流向中的“主管”或“负责人”能看到审批按钮。 ✅ 2026年2月10日 21:44
引入“待提交”状态： _目前任务创建后可能直接进入审批或草稿。增加一个明确的 Pending Submission 状态，方便员工在正式提交前进行多次修改。 ✅ 2026年2月10日 21:44
完善岗位库编辑：_ 支持 Admin 对岗位（Position）的增删改查，这是 RBAC（基于角色的权限控制）灵活性的基础。 ✅ 2026年2月10日 21:44

问题：
新增部门报错：Request failed with status code 500 ✅ 2026年2月10日 21:47
审批按钮只对指定审批人显示，不行，管理员还能看到待审批流程 ✅ 2026年2月10日 21:47

### 第二阶段：管理逻辑深度优化（进行中 🔄）

- [ ] 逻辑删除 (Logical Deletion)
  - [ ] 后端模型添加 `is_deleted` 字段
  - [ ] API `delete_task` 改为软删除
  - [ ] 列表查询默认过滤已删除任务
- [x] 组长角色与审批流 (Group Leader) ✅
  - [x] 新增 `GROUP_LEADER` 角色 ✅
  - [x] 任务模型添加 `leader_id` (使用 reviewer_id 代替，动态判定) ✅
  - [x] 实现二级审批流 (`PENDING_LEADER_APPROVAL`) ✅
  - [x] 前端适配组长审批操作 ✅
  - [x] 后端实现 `approve_task_leader` 接口 ✅
- [ ] 动态系数调整
  - [ ] 后端新增系数调整 API (带日志记录)
  - [ ] 前端实现管理者调整 I/D/Q 系数入口

## 规划

- [ ] 任务分类自定义 - 让用户可以自定义任务的分类/类型
- [ ] 批量导入任务 - 通过 Excel/CSV 批量创建任务
- [ ] 必填项UI提示
- [ ] 权限与角色精细化控制优化 (Ongoing)
- [ ] AI Skill 辅助任务难度/质量/重要性系数自动评级，AI Skill 申诉评判
- [ ] PWA 离线支持

---

## 核心管理逻辑补丁，管理逻辑深度优化（业务价值提升）

### 通过“子任务拆解”实现工作量的精准量化

解决多人协作下的积分分配公平性问题，并引入中间管理层（组长）提升审核效率。

#### 积分计算与分发模型

系统采用“性质继承、量化在下”的原则。主任务定义性质（I/D），子任务定义工作量（B）与执行人。

#### 实施人（执行者）得分公式

每一个子任务完成并经过验收后，该子任务的实施人获得积分 $S_{exec}$：

$$S_{exec} = B_{sub} \times I_{main} \times D_{main} \times Q_{sub} \times T_{sub}$$

变量定义：

- $B_{sub}$ (Sub-workload): 子任务工作量基准分（如：20/50/80）。
- $I_{main} / D_{main}$: 继承自主任务的重要性与难度系数。
- $Q_{sub} / T_{sub}$: 该子任务独立的质量系数与时效系数。

#### 时效系数 $T$ 标准公式

$$T = \begin{cases} 1.0, & \Delta t \le 0 \\ \max \left( 0.2, 1.0 - \frac{\Delta t}{D_{duration}} \cdot f \right), & \Delta t > 0 \end{cases}$$

#### 任务拆解与工作量量化方案

##### 拆解原则

- 颗粒度： 建议单条子任务耗时不超过 2 个工作日。超过 3 天的任务必须拆解。

- 工作量聚合： 主任务的原始规模由其下所有子任务的 $B_{sub}$ 之和决定。
- 分发逻辑： 拆解时，每个子任务必须明确唯一的 `executor_id`（实施人）。

##### 负责人（Owner）拿分逻辑

负责人通过以下两种方式体现管理价值：

1. 管理型子任务： 负责人亲自承担“架构设计”、“最终校验”等子任务，获取相应的 $B_{sub}$ 积分。
2. 管理提成 (Optional)： 系统根据所有实施人总得分，额外生成 $10\%$ 的管理积分分发给负责人。

#### 动态系数调整 (Dynamic Audit)

- 逻辑： 允许在任务执行中调整 $I$ 和 $D$。

- 审计流： 每次修改必须触发 `CoefficientChangedEvent`，记录：修改人、旧值、新值、修改原因（Reason Code）、时间戳。最终得分以最新系数为准。

### 5 “组长”角色与三级审批流

为适配 50 人左右规模，建立如下审批链路：

1. Staff (实施人)： 提交子任务，上传成果链接。状态 $\rightarrow$ `Pending_L1` (待初审)。
2. Group Leader (组长)： 负责业务真实性初审。通过后状态 $\rightarrow$ `Pending_L2` (待终审)；组长获得少量“审核分”。
3. Manager (主管)： 负责最终质量评分 ($Q$) 及分值封账。状态 $\rightarrow$ `Settled` (已结清)。

### 6 任务“逻辑删除”原则

任务“不可删除”原则： 实现“逻辑删除”而非“物理删除”。所有任务即便取消，也应在数据库保留记录（Status = Cancelled），作为年度绩效审计的依据。

实现方式： 数据库中不使用 `DELETE`。使用 `is_deleted` (Boolean) 和 `status = 'Cancelled'`。

管理价值： 即使是取消的任务，其已产生的日志、工期消耗、已完成的子任务积分依然保留，用于年度“无效工作量”分析。

### 新增“组长”角色

在“主管”和“员工”之间增加“组长”层级。
任务或自任务可以根据情况安排审1次还是审2次，可以指定审核人。比如组长负责初审，主管负责终审。或者组长审核就算完成。
增加评价体系，主管可以对已完成的任务进行评价，评价后根据情况调整系数或扣分。

### 增加任务复盘（待定）

可以将任务或子任务做成典型任务，作为参照物，评估工作任务的难度系数和质量系数。

### 第三阶段：引入 AI 智能算力（发挥 Agent 优势）

由于你已经在规划中提到了 AI Skill，这一步是 PMS 系统超越传统 OA 的关键。
AI 申诉裁决官： 利用你正在开发的 Antigravity AI Skill，自动分析申诉人的证据（5W2H 链）与历史日志。AI 给出裁决建议（如：准予撤销红牌，建议系数调低），最后由人工确认。
AI 难度系数预测： 根据任务描述的关键词、预估工期，自动推荐 I 和 D 的初始分值，减少主管评分的主观性。
风险预警助手： AI 定时扫描所有“进行中”任务的日志，识别出带有“困难”、“受阻”、“等待”等负面情绪或状态的描述，主动向主管推送“高风险任务提醒”。

### 第四阶段：自动化与工程化（效率工具集成）

作为喜欢用自动化手段解决问题的用户，你可以通过以下方式进一步释放系统潜力：
Excel/WPS 深度集成： _既然你擅长 Excel，可以开发一个 Excel Add-in 或使用 Python 脚本。实现：在本地 Excel 填好计划，一键同步到 Web 端；或者从 Web 端一键生成复杂的绩效透视表。
批量导入/导出：_ 支持标准化的 Excel 模板导入任务，解决初始化系统时录入量大的痛点。
PWA 增强与通知： 目前推送是“登录后查看”，建议接入微信机器人（如企业微信 Webhook）或钉钉机器人。当红黄牌触发时，直接推送到负责人手机上。

### 问题记录

缺少子任务功能
标记待提交报错：Request failed with status code 500
审批权等可以分配调整
草稿状态未在仪表盘显示
计划管理功能，增加管理人员评论反馈
子任务可以调整为主任务
增加绩效考核功能

### 2026-02-11 06:00 - 紧急修复 (Hotfix) ✅

- [x] 修复 `AuditModule` 缩进错误导致的启动失败
- [x] 修复 `audit.py` 中 `Float` 类型缺失导致的潜在错误
- [x] 修复 `task.py` 中 `Boolean` 类型缺失导致的 `NameError`
