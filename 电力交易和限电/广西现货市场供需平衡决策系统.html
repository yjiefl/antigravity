<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿è¥¿ç°è´§å¸‚åœºï¼šä¾›éœ€å¹³è¡¡ä¸ç­–ç•¥æ¨¡æ‹Ÿç³»ç»Ÿ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #F8FAFC;
            color: #1E293B;
        }

        /* Strict Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        /* Specific Heights for layout balance */
        .chart-h-sm {
            height: 250px;
            max-height: 250px;
        }

        .chart-h-md {
            height: 350px;
            max-height: 350px;
        }

        .chart-h-lg {
            height: 450px;
            max-height: 500px;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #0F766E;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #CBD5E1;
            border-radius: 2px;
        }

        /* Flow Diagram CSS Elements */
        .flow-box {
            border: 1px solid #E2E8F0;
            background: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .flow-box:hover {
            border-color: #0F766E;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .arrow-down {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #94A3B8;
            margin: 4px auto;
        }
    </style>

    <!-- Chosen Palette: "Grid Stability"
         Primary: #0F766E (Teal 700 - Balanced Grid/Renewables)
         Secondary: #F59E0B (Amber 500 - Solar/Warning)
         Danger: #EF4444 (Red 500 - Curtailment/Risk)
         Neutral: #64748B (Slate 500 - Infrastructure)
         Background: #F8FAFC (Slate 50 - Clean Canvas)
    -->

    <!-- Application Structure Plan:
         1. Header: Context setting (Guangxi 2025 Rules).
         2. Concept Section (The Scale): Visualizing Supply = Demand. Explaining "Net Load".
         3. The "Balance Simulator" (Core):
            - A timeline slider (00:00 - 24:00).
            - Inputs: Weather (Supply side), Industrial Activity (Demand side).
            - Visualization: Stacked Area Chart (Gen Mix) vs Line (Load).
            - Real-time Balance Gauge: Shows "Surplus" vs "Deficit".
         4. Strategy & Impact:
            - How "Net Load" drives the Price (LMP).
            - User selects Mode A vs B.
            - See financial outcome based on the simulated balance moment.
         5. Analysis Panel: Key takeaways about Peak Shaving and Trough Filling.
    -->
</head>

<body class="bg-slate-50">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-teal-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-md">
                    âš–ï¸</div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">å¹¿è¥¿ç°è´§å¸‚åœºï¼šä¾›éœ€å¹³è¡¡å†³ç­–ç³»ç»Ÿ</h1>
                    <p class="text-xs text-slate-500">åŸºäº2025å¹´å®æ–½ç»†åˆ™V2.0 | å…³æ³¨ï¼šæºè·äº’åŠ¨ä¸ä»·æ ¼å½¢æˆ</p>
                </div>
            </div>
            <div class="hidden md:block">
                <span
                    class="px-3 py-1 bg-teal-50 text-teal-700 rounded-full text-xs font-medium border border-teal-100">
                    æ ¸å¿ƒé€»è¾‘ï¼šå®æ—¶å¹³è¡¡ = ä»·æ ¼ä¿¡å·
                </span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- SECTION 1: THE CONCEPT (Why Balance Matters) -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8 items-center">
                <div class="md:col-span-4">
                    <h2 class="text-2xl font-bold text-slate-800 mb-3">ä¾›éœ€å¹³è¡¡ï¼šç°è´§å¸‚åœºçš„â€œæŒ‡æŒ¥æ£’â€</h2>
                    <p class="text-sm text-slate-600 leading-relaxed mb-4">
                        æ‚¨ä¹‹å‰çš„ç ”ç©¶å¯èƒ½ä¾§é‡äºå‘ç”µä¾§ã€‚ä½†ç°è´§å¸‚åœºçš„æ ¸å¿ƒçŸ›ç›¾åœ¨äºï¼š<strong>ç”µèƒ½éš¾ä»¥å¤§è§„æ¨¡å­˜å‚¨ï¼Œå‘ç”µå¿…é¡»æ—¶åˆ»è·Ÿéšç”¨æˆ·ç”¨ç”µã€‚</strong>
                    </p>
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h3 class="text-sm font-bold text-blue-800 mb-1">å…³é”®å…¬å¼ï¼šå‡€è´Ÿè· (Net Load)</h3>
                        <p class="text-xs text-blue-700 font-mono">
                            å‡€è´Ÿè· = ç”¨æˆ·æ€»ç”¨ç”µéœ€æ±‚ - (é£ç”µ + å…‰ä¼å‡ºåŠ›)
                        </p>
                        <p class="text-xs text-blue-600 mt-2">
                            ğŸ”¥ <strong>ç«ç”µ/æ°´ç”µçš„ä½œç”¨ï¼š</strong> å¡«è¡¥â€œå‡€è´Ÿè·â€çš„ç¼ºå£ã€‚<br>
                            ğŸ’° <strong>ä»·æ ¼å½¢æˆï¼š</strong> å¡«è¡¥ç¼ºå£çš„æœ€åä¸€å°æœºç»„æŠ¥ä»·å†³å®šäº†å…¨ç½‘ç”µä»· (SMP)ã€‚
                        </p>
                    </div>
                </div>
                <!-- Logic Flow Diagram (HTML/CSS) -->
                <div class="md:col-span-8 bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <div
                        class="flex justify-between items-center text-xs text-slate-500 mb-2 font-bold uppercase tracking-wider">
                        <span>ä¾›ç»™ä¾§ (Supply)</span>
                        <span>å¸‚åœºå‡ºæ¸… (Clearing)</span>
                        <span>éœ€æ±‚ä¾§ (Demand)</span>
                    </div>
                    <div class="grid grid-cols-5 gap-2 text-sm">
                        <!-- Supply Stack -->
                        <div class="col-span-1 space-y-2">
                            <div class="flow-box border-teal-200 bg-teal-50 text-teal-800">â˜€ï¸ å…‰ä¼/é£ç”µ<br><span
                                    class="text-xs opacity-75">(æ³¢åŠ¨æ€§å¤§)</span></div>
                            <div class="flow-box border-slate-300 text-slate-700">ğŸ­ ç«ç”µ/æ ¸ç”µ<br><span
                                    class="text-xs opacity-75">(è°ƒèŠ‚ä¸»åŠ›)</span></div>
                        </div>

                        <!-- Arrows -->
                        <div class="col-span-1 flex flex-col justify-center items-center">
                            <div class="h-0.5 w-full bg-slate-300 relative">
                                <div
                                    class="absolute right-0 top-1/2 transform -translate-y-1/2 -mt-1 border-l-8 border-l-slate-300 border-t-4 border-t-transparent border-b-4 border-b-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- The Market Scale -->
                        <div class="col-span-1 flex flex-col justify-center items-center relative">
                            <div
                                class="w-16 h-16 rounded-full border-4 border-amber-500 bg-white flex items-center justify-center shadow-lg z-10">
                                <span class="text-lg">âš–ï¸</span>
                            </div>
                            <div class="absolute top-20 text-center w-40">
                                <span class="block font-bold text-slate-800">ç°è´§ä»·æ ¼ (LMP)</span>
                                <span class="text-xs text-slate-500">å¹³è¡¡çš„ä¿¡å·ç¯</span>
                            </div>
                        </div>

                        <!-- Arrows -->
                        <div class="col-span-1 flex flex-col justify-center items-center">
                            <div class="h-0.5 w-full bg-slate-300 relative">
                                <div
                                    class="absolute left-0 top-1/2 transform -translate-y-1/2 -mt-1 border-r-8 border-r-slate-300 border-t-4 border-t-transparent border-b-4 border-b-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- Demand Stack -->
                        <div class="col-span-1 space-y-2">
                            <div class="flow-box border-indigo-200 bg-indigo-50 text-indigo-800">ğŸ­ å·¥ä¸šè´Ÿè·<br><span
                                    class="text-xs opacity-75">(åˆšæ€§/å¤§å®¹é‡)</span></div>
                            <div class="flow-box border-orange-200 bg-orange-50 text-orange-800">ğŸ  å±…æ°‘è´Ÿè·<br><span
                                    class="text-xs opacity-75">(éšæ°”æ¸©å˜åŒ–)</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: THE BALANCE SIMULATOR (Interactive Core) -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Controls Panel -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col h-full">
                <h3 class="font-bold text-lg text-slate-800 mb-6 flex items-center">
                    <span class="w-2 h-6 bg-teal-500 rounded mr-2"></span> ç¯å¢ƒå˜é‡æ§åˆ¶å°
                </h3>

                <div class="space-y-8 flex-grow">
                    <!-- Control 1: Time of Day -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700">å½“å‰æ—¶åˆ» (Time)</label>
                            <span id="val-time" class="text-sm font-bold text-teal-700">12:00</span>
                        </div>
                        <input type="range" id="input-time" min="0" max="23" value="12" step="1"
                            oninput="updateSimulation()">
                        <div class="flex justify-between text-xs text-slate-400 mt-1">
                            <span>0:00</span><span>12:00</span><span>23:00</span>
                        </div>
                    </div>

                    <!-- Control 2: Weather (Supply Impact) -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700">å¤©æ°”çŠ¶å†µ (å…‰ä¼å‡ºåŠ›)</label>
                            <span id="val-weather" class="text-sm font-bold text-amber-500">æ™´æœ— (100%)</span>
                        </div>
                        <input type="range" id="input-weather" min="0" max="100" value="90" step="10"
                            class="accent-amber-500" oninput="updateSimulation()">
                        <p class="text-xs text-slate-400 mt-2">å½±å“æ–°èƒ½æºä¾›ç»™ã€‚é˜´é›¨å¤©ä¼šå¯¼è‡´å…‰ä¼å‡ºåŠ›éª¤é™ï¼Œéœ€ç«ç”µé¡¶å³°ã€‚</p>
                    </div>

                    <!-- Control 3: Demand Intensity -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-700">å…¨ç¤¾ä¼šç”¨ç”µéœ€æ±‚</label>
                            <span id="val-demand" class="text-sm font-bold text-indigo-600">æ­£å¸¸ (100%)</span>
                        </div>
                        <input type="range" id="input-demand" min="60" max="140" value="100" step="5"
                            class="accent-indigo-500" oninput="updateSimulation()">
                        <p class="text-xs text-slate-400 mt-2">å—å·¥ä¸šç”Ÿäº§ã€å­£èŠ‚ï¼ˆç©ºè°ƒè´Ÿè·ï¼‰å½±å“ã€‚120%æ¨¡æ‹Ÿå¤å­£é«˜å³°ã€‚</p>
                    </div>
                </div>

                <!-- Instant Status Box -->
                <div id="status-box"
                    class="mt-8 p-4 rounded-lg bg-green-50 border border-green-200 transition-colors duration-300">
                    <h4 class="text-xs font-bold uppercase tracking-wider text-green-800 mb-2">å½“å‰ç”µç½‘çŠ¶æ€</h4>
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-bold text-green-700" id="grid-status-text">ä¾›éœ€å¹³è¡¡</span>
                        <span class="text-sm text-green-600" id="grid-price-text">ç”µä»·é€‚ä¸­</span>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Chart 1: The Duck Curve (24h Overview) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800">âš¡ å…¨å¤©ä¾›éœ€æ›²çº¿ (24h Dispatch)</h3>
                        <div class="flex gap-4 text-xs">
                            <span class="flex items-center"><span
                                    class="w-3 h-3 bg-amber-400 rounded-full mr-1"></span>æ–°èƒ½æº(ä½ä»·)</span>
                            <span class="flex items-center"><span
                                    class="w-3 h-3 bg-slate-400 rounded-full mr-1"></span>ç«ç”µ(è¾¹é™…)</span>
                            <span class="flex items-center"><span class="w-3 h-1 bg-indigo-600 mr-1"></span>ç”¨æˆ·è´Ÿè·</span>
                        </div>
                    </div>
                    <!-- Chart Container -->
                    <div class="chart-container chart-h-md">
                        <canvas id="chartCurve"></canvas>
                    </div>
                    <p class="text-xs text-slate-400 mt-2 text-center">
                        æ‹–åŠ¨å·¦ä¾§æ»‘å—ï¼Œè§‚å¯Ÿâ€œé¸­å­æ›²çº¿â€å½¢æ€å˜åŒ–åŠå‡€è´Ÿè·ï¼ˆNet Loadï¼‰å¯¹ç«ç”µè°ƒå³°éœ€æ±‚çš„æŒ¤å‹ã€‚
                    </p>
                </div>

                <!-- Chart 2 & 3: Snapshot Balance & Price -->
                <div class="grid grid-cols-2 gap-6">
                    <!-- Real-time Balance Snapshot -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-sm text-slate-700 mb-4">ğŸ•’ <span id="snapshot-time">12:00</span>
                            å®æ—¶åˆ‡ç‰‡ï¼šç”µæºç»“æ„</h3>
                        <div class="chart-container chart-h-sm">
                            <canvas id="chartPie"></canvas>
                        </div>
                    </div>

                    <!-- Price Mechanism -->
                    <div
                        class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col justify-center items-center text-center">
                        <h3 class="font-bold text-sm text-slate-700 mb-2">å½“å‰æ—¶åˆ»å¸‚åœºå‡ºæ¸…ä»· (SMP)</h3>

                        <div class="relative w-40 h-40 flex items-center justify-center">
                            <!-- SVG-free Gauge Metaphor using CSS Borders -->
                            <div class="w-32 h-32 rounded-full border-8 border-slate-100 border-t-teal-500 border-r-amber-500 border-b-red-500 rotate-45 transform transition-all duration-500"
                                id="price-gauge"></div>
                            <div class="absolute">
                                <span id="display-price" class="text-3xl font-black text-slate-800">350</span>
                                <span class="block text-xs text-slate-500">å…ƒ/MWh</span>
                            </div>
                        </div>

                        <div id="price-explanation" class="text-xs bg-slate-100 p-2 rounded w-full mt-2">
                            ç«ç”µä½œä¸ºè¾¹é™…æœºç»„å®šä»·
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- SECTION 3: STRATEGY & OUTCOME -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center">
                    <span class="text-xl mr-2">ğŸ“Š</span> æ‚¨çš„ç­–ç•¥ç»“æœåˆ†æ
                </h3>
                <div class="flex bg-slate-700 rounded p-1">
                    <button class="px-3 py-1 text-xs font-bold rounded text-white bg-teal-600 shadow" id="btn-mode-a"
                        onclick="setStrategy('taker')">æ¨¡å¼A: æŠ¥é‡ä¸æŠ¥ä»·</button>
                    <button class="px-3 py-1 text-xs font-bold rounded text-slate-300 hover:text-white" id="btn-mode-b"
                        onclick="setStrategy('maker')">æ¨¡å¼B: æŠ¥é‡æŠ¥ä»·</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-8">
                <div>
                    <h4 class="font-bold text-slate-800 mb-2">å½“å‰åœºæ™¯ä¸‹çš„è¿è¡ŒçŠ¶å†µ</h4>
                    <p class="text-sm text-slate-600 mb-4" id="strategy-context">
                        åœ¨å½“å‰è´Ÿè·ä¸å¤©æ°”ä¸‹ï¼Œç³»ç»Ÿ<span class="font-bold text-teal-600">æ¶ˆçº³è‰¯å¥½</span>ã€‚
                    </p>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-100">
                            <span class="text-sm text-slate-600">è®¡åˆ’å‘ç”µé‡</span>
                            <span class="font-bold text-slate-800" id="res-gen">100 MW</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-100">
                            <span class="text-sm text-slate-600">å®é™…ä¸Šç½‘ç”µé‡ (æ‰£é™¤é™ç”µ)</span>
                            <span class="font-bold text-teal-600" id="res-cleared">100 MW</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-amber-50 rounded border border-amber-100">
                            <span class="text-sm text-amber-800">å°æ—¶æ”¶å…¥é¢„æµ‹</span>
                            <span class="font-bold text-amber-700 text-lg" id="res-revenue">Â¥ 35,000</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-slate-800 mb-2">ç­–ç•¥å¯¹æ¯” (ç›ˆäºåˆ†æ)</h4>
                    <div class="chart-container chart-h-sm">
                        <canvas id="chartStrategy"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-indigo-50 p-4 text-xs text-indigo-800 border-t border-indigo-100 flex gap-4">
                <span class="font-bold text-xl">ğŸ’¡</span>
                <div>
                    <p class="font-bold mb-1">å…³é”®æ´å¯Ÿï¼š</p>
                    <p id="insight-text">
                        å½“ç”¨æˆ·è´Ÿè·ä½ï¼ˆä¸­åˆ/æ·±å¤œï¼‰ä¸”æ–°èƒ½æºå¤§å‘æ—¶ï¼Œç«ç”µè¢«è¿«å‹è‡³æœ€å°æŠ€æœ¯å‡ºåŠ›ï¼ˆæ·±è°ƒï¼‰ï¼Œæ­¤æ—¶å®¹æ˜“å‘ç”Ÿ**å¼ƒé£å¼ƒå…‰**æˆ–**è´Ÿç”µä»·**ã€‚ç­–ç•¥é‡ç‚¹åº”ä»â€œå¤šå‘ç”µâ€è½¬å‘â€œåœ¨ç”µä»·é«˜æ—¶å¤šå‘â€ï¼ˆå¦‚æœé…å¤‡å‚¨èƒ½ï¼‰ã€‚
                    </p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-slate-400 text-xs py-8">
            <p class="mb-2">Visualization of Supply-Demand Balance in Spot Markets</p>
            <!-- Visualization & Content Choices:
                 1. 24h Area Chart: Goal -> Show Relationship (Supply vs Demand). Viz -> Chart.js Stacked Line/Area.
                 2. Gauge/Indicator: Goal -> Inform (Price status). Viz -> CSS Transforms + Text.
                 3. Pie Chart: Goal -> Show Composition (Energy Mix). Viz -> Chart.js Pie.
                 4. Strategy Bar Chart: Goal -> Compare (Revenue). Viz -> Chart.js Bar.
                 NO SVG Used. NO Mermaid Used.
            -->
            <p>Â© 2026 Guangxi Energy Simulation Tool</p>
        </footer>

    </main>

    <script>
        // --- DATA & STATE ---
        const state = {
            currentTime: 12,
            weatherFactor: 0.9, // 0 to 1
            demandFactor: 1.0,  // 0.6 to 1.4
            strategy: 'taker',  // 'taker' or 'maker'

            // Constants
            capacity: 100, // User's station capacity
            thermalMin: 2000,
            thermalMax: 8000,
            renewablesCap: 6000
        };

        // Base Profiles (24h) - Simplified representation
        const baseProfile = {
            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
            solar: [0, 0, 0, 0, 0, 0, 5, 20, 50, 80, 95, 100, 100, 95, 80, 50, 20, 5, 0, 0, 0, 0, 0, 0], // Bell curve
            wind: [70, 75, 70, 65, 60, 50, 40, 30, 20, 20, 30, 40, 50, 45, 40, 35, 40, 50, 60, 70, 80, 80, 75, 70], // Higher at night
            load: [40, 35, 30, 30, 32, 35, 45, 60, 75, 85, 90, 85, 80, 80, 82, 85, 90, 95, 100, 95, 85, 70, 60, 50] // Double hump
        };

        // Chart Instances
        let chartCurve, chartPie, chartStrategy;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateSimulation();
        });

        // --- CORE LOGIC ---
        function calculateMarket(hour, weather, demandMult) {
            // 1. Calculate Supply at this hour
            const solarGen = (baseProfile.solar[hour] / 100) * (state.renewablesCap * 0.6) * weather; // Solar is 60% of RE cap
            const windGen = (baseProfile.wind[hour] / 100) * (state.renewablesCap * 0.4); // Wind is 40%
            const totalRenewable = solarGen + windGen;

            // 2. Calculate Demand
            const totalLoad = (baseProfile.load[hour] / 100) * 10000 * demandMult; // 10000 is base system peak

            // 3. Determine Net Load (Demand for Thermal)
            let netLoad = totalLoad - totalRenewable;

            // 4. Determine Dispatch & Price
            let smp = 0;
            let status = 'normal';
            let curtailment = 0;
            let thermalOutput = 0;

            if (netLoad < state.thermalMin) {
                // OVERSUPPLY / CURTAILMENT
                status = 'curtailment';
                thermalOutput = state.thermalMin; // Must run at min
                let excess = state.thermalMin - netLoad;
                curtailment = excess; // Renewables must be cut
                smp = 50; // Floor price
            } else if (netLoad > state.thermalMax) {
                // SCARCITY
                status = 'scarcity';
                thermalOutput = state.thermalMax;
                smp = 1000; // Cap price
                // In reality, load shedding would happen here
            } else {
                // NORMAL MARGINAL CLEARING
                status = 'balanced';
                thermalOutput = netLoad;
                // Linear price model: Price increases as thermal load increases
                let loadRatio = (netLoad - state.thermalMin) / (state.thermalMax - state.thermalMin);
                smp = 300 + (loadRatio * 400); // Base 300, up to 700
            }

            return {
                solar: solarGen,
                wind: windGen,
                thermal: thermalOutput,
                load: totalLoad,
                curtailment: curtailment,
                price: smp,
                status: status
            };
        }

        function updateSimulation() {
            // Read Inputs
            state.currentTime = parseInt(document.getElementById('input-time').value);
            state.weatherFactor = parseInt(document.getElementById('input-weather').value) / 100;
            state.demandFactor = parseInt(document.getElementById('input-demand').value) / 100;

            // Update Labels
            document.getElementById('val-time').textContent = `${state.currentTime}:00`;
            document.getElementById('snapshot-time').textContent = `${state.currentTime}:00`;

            let wText = state.weatherFactor > 0.8 ? "æ™´æœ— (100%)" : state.weatherFactor > 0.4 ? "å¤šäº‘ (50%)" : "é˜´é›¨ (10%)";
            document.getElementById('val-weather').textContent = wText;
            document.getElementById('val-demand').textContent = `${Math.round(state.demandFactor * 100)}%`;

            // --- 1. Update 24h Curve Data ---
            const fullDayData = baseProfile.labels.map((_, i) => calculateMarket(i, state.weatherFactor, state.demandFactor));

            const solarSeries = fullDayData.map(d => d.solar);
            const windSeries = fullDayData.map(d => d.wind);
            const thermalSeries = fullDayData.map(d => d.thermal);
            const loadSeries = fullDayData.map(d => d.load);
            const curtailSeries = fullDayData.map(d => d.curtailment); // For showing lost opportunity

            chartCurve.data.datasets[0].data = solarSeries;
            chartCurve.data.datasets[1].data = windSeries;
            chartCurve.data.datasets[2].data = thermalSeries;
            chartCurve.data.datasets[3].data = loadSeries;
            chartCurve.update();

            // --- 2. Update Snapshot Logic (Current Time) ---
            const currentSnap = fullDayData[state.currentTime];

            // Pie Chart
            chartPie.data.datasets[0].data = [currentSnap.solar, currentSnap.wind, currentSnap.thermal];
            chartPie.update();

            // Price & Gauge
            animatePrice(currentSnap.price);
            updateStatusBox(currentSnap);

            // Strategy Calc
            updateStrategyOutcome(currentSnap);
        }

        function updateStatusBox(snap) {
            const box = document.getElementById('status-box');
            const statusText = document.getElementById('grid-status-text');
            const priceText = document.getElementById('grid-price-text');

            box.className = "mt-8 p-4 rounded-lg border transition-colors duration-300";

            if (snap.status === 'curtailment') {
                box.classList.add('bg-red-50', 'border-red-200');
                statusText.textContent = "ä¾›å¤§äºæ±‚ (å¼ƒç”µ)";
                statusText.className = "text-2xl font-bold text-red-600";
                priceText.textContent = "åœ°æ¿ä»·æ—¶åˆ»";
                priceText.className = "text-sm text-red-500";

                document.getElementById('insight-text').innerHTML = "âš ï¸ <strong>è­¦å‘Šï¼š</strong> æ­¤æ—¶æ®µæ–°èƒ½æºå‡ºåŠ›è¿‡å¤§ï¼Œè¶…è¿‡ç”µç½‘æ¶ˆçº³èƒ½åŠ›ã€‚ç³»ç»Ÿå¼ºåˆ¶å‹ä½ç«ç”µè‡³æœ€å°å‡ºåŠ›ä»æ— æ³•å¹³è¡¡ï¼Œè§¦å‘<strong>å¸‚åœºåŒ–é™ç”µ</strong>ã€‚è‹¥æ‚¨é‡‡ç”¨â€œæŠ¥é‡ä¸æŠ¥ä»·â€ï¼Œå°†é¢ä¸´æŒ‰æ¯”ä¾‹åˆ‡è´Ÿè·ï¼›è‹¥æœ‰æŠ¥ä»·ï¼Œå¯èƒ½å› é«˜ä»·æœªä¸­æ ‡ã€‚";

            } else if (snap.status === 'scarcity') {
                box.classList.add('bg-amber-50', 'border-amber-200');
                statusText.textContent = "ä¾›éœ€ç´§å¼ ";
                statusText.className = "text-2xl font-bold text-amber-600";
                priceText.textContent = "ä»·æ ¼é¡¶æ ¼";
                priceText.className = "text-sm text-amber-500";
                document.getElementById('insight-text').innerHTML = "ğŸ“ˆ <strong>æœºä¼šï¼š</strong> è´Ÿè·æé«˜ï¼Œæ‰€æœ‰æœºç»„æ»¡å‘ã€‚æ­¤æ—¶ç”µä»·æœ€é«˜ï¼Œæ¯ä¸€åº¦ç”µéƒ½æå…·ä»·å€¼ã€‚";

            } else {
                box.classList.add('bg-green-50', 'border-green-200');
                statusText.textContent = "ä¾›éœ€å¹³è¡¡";
                statusText.className = "text-2xl font-bold text-green-700";
                priceText.textContent = "è¾¹é™…å‡ºæ¸…";
                priceText.className = "text-sm text-green-600";
                document.getElementById('insight-text').innerHTML = "âœ… <strong>æ­£å¸¸è¿è¡Œï¼š</strong> è´Ÿè·ç”±ç«ç”µè¾¹é™…æœºç»„è°ƒèŠ‚ã€‚ç”µä»·åæ˜ ç‡ƒæ–™æˆæœ¬ã€‚æ‚¨çš„ç”µé‡è¢«å…¨é¢æ¶ˆçº³ã€‚";
            }
        }

        function animatePrice(targetPrice) {
            const el = document.getElementById('display-price');
            const gauge = document.getElementById('price-gauge');

            // Simple visual animation for number
            el.textContent = Math.round(targetPrice);

            // Rotate gauge
            // 0 deg = Min, 180 deg = Max. Map 0-1000 price to 0-180 rotation
            // Actually CSS rotate starts at 45deg for this visual style
            // Let's map price 50-1000 to rotation
            let rotation = ((targetPrice - 50) / 950) * 180;
            // Clamp
            if (rotation < 0) rotation = 0;
            if (rotation > 180) rotation = 180;

            // Base rotation is -45deg (left) to 135deg (right) visually if we want a semi-circle bottom?
            // Let's just rotate the border box. 
            // Simpler: Map color.
            if (targetPrice <= 50) gauge.style.borderColor = "#EF4444 #CBD5E1 #CBD5E1 #EF4444"; // Red Low
            else if (targetPrice > 800) gauge.style.borderColor = "#F59E0B #F59E0B #EF4444 #CBD5E1"; // High
            else gauge.style.borderColor = "#CBD5E1 #0F766E #0F766E #CBD5E1"; // Normal
        }

        // --- STRATEGY LOGIC ---
        function setStrategy(mode) {
            state.strategy = mode;
            const btnA = document.getElementById('btn-mode-a');
            const btnB = document.getElementById('btn-mode-b');

            if (mode === 'taker') {
                btnA.className = "px-3 py-1 text-xs font-bold rounded text-white bg-teal-600 shadow transition-all";
                btnB.className = "px-3 py-1 text-xs font-bold rounded text-slate-300 hover:text-white transition-all";
            } else {
                btnA.className = "px-3 py-1 text-xs font-bold rounded text-slate-300 hover:text-white transition-all";
                btnB.className = "px-3 py-1 text-xs font-bold rounded text-white bg-amber-600 shadow transition-all";
            }
            // Trigger recalculation
            updateSimulation();
        }

        function updateStrategyOutcome(snap) {
            // Logic:
            // Mode A (Taker): Bids Floor. If Curtailment > 0, gets pro-rata cut.
            // Mode B (Maker): Assume bid = 350 (Cost based). 
            // If Price < 350, Volume = 0 (Economic Curtailment).
            // If Price >= 350, Volume = 100%.

            let myCap = 100; // MW
            let clearedVol = 0;
            let revenue = 0;
            let comparisonRev = 0; // The other strategy

            // 1. Calculate Taker (Mode A) result for comparison
            let takerVol = myCap;
            if (snap.status === 'curtailment') {
                // Pro-rata cut: (ThermalMin + Renewables) > Load
                // Curtailment % = Excess / TotalRenewables
                let totalRen = snap.solar + snap.wind;
                let cutRatio = snap.curtailment / totalRen;
                takerVol = myCap * (1 - cutRatio);
            }
            let takerRev = takerVol * snap.price;

            // 2. Calculate Maker (Mode B) result for comparison
            let makerVol = myCap;
            let makerBid = 320; // Assume a rational bid slightly above floor but below thermal
            if (snap.price < makerBid) {
                makerVol = 0; // Not cleared
            } else if (snap.status === 'curtailment') {
                // If we cleared (Price >= Bid), do we still get curtailed?
                // In Guangxi rules, if Price is Floor, Maker bidding floor is same as Taker.
                // If Price is Floor and Maker bid > Floor, Maker is 0.
                if (snap.price < makerBid) makerVol = 0;
                else {
                    // Similar pro-rata if cleared at margin? Simplifying for demo:
                    // If Maker clears, they get full volume unless physical constraint
                    makerVol = takerVol;
                }
            }
            let makerRev = makerVol * snap.price;


            // Set Current Display
            if (state.strategy === 'taker') {
                clearedVol = takerVol;
                revenue = takerRev;
                comparisonRev = makerRev;
                document.getElementById('strategy-context').innerHTML = "ç­–ç•¥ï¼š<span class='font-bold text-teal-600'>å…¨é¢ä¿é‡</span>ã€‚ä¼˜å…ˆäº‰å–ä¸Šç½‘ï¼Œæ¥å—å¸‚åœºä»·æ ¼ã€‚";
            } else {
                clearedVol = makerVol;
                revenue = makerRev;
                comparisonRev = takerRev;
                document.getElementById('strategy-context').innerHTML = "ç­–ç•¥ï¼š<span class='font-bold text-amber-600'>æŠ¥ä»·320å…ƒ</span>ã€‚ä½äºæ­¤ä»·æ ¼ä¸å‘ï¼Œè§„é¿ä½ä»·æŸè€—ã€‚";
            }

            document.getElementById('res-gen').textContent = `${myCap} MW`;
            document.getElementById('res-cleared').textContent = `${Math.round(clearedVol)} MW`;
            document.getElementById('res-revenue').textContent = `Â¥ ${Math.round(revenue).toLocaleString()}`;

            // Update Strategy Chart
            chartStrategy.data.datasets[0].data = [revenue, comparisonRev];
            chartStrategy.update();
        }


        // --- CHART CONFIG ---
        function initCharts() {
            // 1. 24h Curve
            const ctxCurve = document.getElementById('chartCurve').getContext('2d');
            chartCurve = new Chart(ctxCurve, {
                type: 'line',
                data: {
                    labels: baseProfile.labels,
                    datasets: [
                        {
                            label: 'å…‰ä¼å‡ºåŠ›',
                            data: [],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.4)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'é£ç”µå‡ºåŠ›',
                            data: [],
                            borderColor: '#0F766E',
                            backgroundColor: 'rgba(15, 118, 110, 0.4)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'ç«ç”µå‡ºåŠ› (è°ƒèŠ‚)',
                            data: [],
                            borderColor: '#64748B',
                            backgroundColor: 'rgba(100, 116, 139, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'ç”¨æˆ·æ€»è´Ÿè·',
                            data: [],
                            borderColor: '#4F46E5', // Indigo
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            stacked: false, // Important: We want lines to overlap/stack logically
                            beginAtZero: true,
                            title: { display: true, text: 'åŠŸç‡ (MW)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += Math.round(context.parsed.y) + ' MW';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // 2. Pie Chart (Mix)
            const ctxPie = document.getElementById('chartPie').getContext('2d');
            chartPie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['å…‰ä¼', 'é£ç”µ', 'ç«ç”µ'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#F59E0B', '#0F766E', '#64748B'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // 3. Strategy Chart (Bar)
            const ctxStrat = document.getElementById('chartStrategy').getContext('2d');
            chartStrategy = new Chart(ctxStrat, {
                type: 'bar',
                data: {
                    labels: ['å½“å‰ç­–ç•¥', 'æ›¿ä»£ç­–ç•¥'],
                    datasets: [{
                        label: 'é¢„ä¼°æ”¶ç›Š',
                        data: [0, 0],
                        backgroundColor: ['#0F766E', '#CBD5E1'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    </script>
</body>

</html>