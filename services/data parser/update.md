# 更新记录

## 基本部署 2026年2月10日 13:30

✅项目结构初始化与规划 [/]
✅创建✅spec.md(Web 版本)
✅设立 output 文件夹
✅后端开发 (Flask/FastAPI) [ ]
✅迁移analyzer.py逻辑到 Web 后端
✅实现文件上传与处理接口
✅实现分析报告导出接口
✅前端开发 (HTML/CSS/JS) [ ]
✅搭建简约大气的 UI 界面
✅实现文件拖拽上传交互
✅展示分析简报 (Top 3 场站与问题)
✅验证与部署 [ ]
✅E2E 测试验证
✅编写启动脚本

## 完成处理

看不到场站的数据 ✅ 2026年2月10日 13:33
报告内容有问题 ✅ 2026年2月10日 13:39
优化场站显示排版 ✅ 2026年2月10日 13:47
报告首先按总体汇总、显示图标，然后按站按类别排版、汇总 ✅ 2026年2月10日 13:47
点击运行深度分析后，弹出一个打开文件的窗口，增加一个打开文件按钮 ✅ 2026年2月10日 13:47
增加部署到本地nas功能，配置 ✅ 2026年2月10日 14:46
NAS_USER="yjiefl"
NAS_IP="192.168.3.10"
NAS_PORT="22222"

## 后续更新

### 新功能：运营日报表自动化审核

- **完成时间**: 2026-02-11 13:10
- **功能描述**:
  - 将 daily_report_processor.py 逻辑集成到 Web 平台，实现 .xlsx 日报文件的上传与审核。
  - 新增 daily_report.html 前端页面，与现有 UI 风格统一。
  - 在 power_prediction.html 和 daily_report.html 顶部增加导航栏，实现功能切换。
  - 后端新增 /daily_report 相关路由，支持生成 JSON 数据及 PDF 报告。

### 2026-02-11 12:30:00

- **任务**: 重新审核 2026年02月10日运营日报表.xlsx
- **状态**: 已完成
- **改进内容**:
  - 安装了 `reportlab` 依赖以支持 PDF 报告生成。
  - 运行 `daily_report_processor.py` 完成了数据清洗与异常审计。
  - 输出了 `analysis_report.txt` 和 `analysis_report.pdf`。
  - 关键发现：贵港公司樟木站存在 173 台逆变器被人为拉停，影响容量巨大。
- **待改进**:
  - 分布式场站的利用率记录普遍缺失，需核实报表源头是否支持该项数据追踪。
  - PDF 字体当前硬编码为 `/Library/Fonts/Arial Unicode.ttf`，在不同系统上可能路径不一。
    部分问题提示为未知问题

1. 删除功能要加密码，禁止随意删除 密码：yj666 ✅ 2026年2月11日 14:44
2. 计算正确的，要显示计算过程 ✅ 2026年2月11日 14:44
3. 修复 NAS 部署后 502 问题（端口映射修正 5004:5001） ✅ 2026年2月11日 14:48
4. 修复 NAS 部署缺失依赖 (reportlab) 导致容器崩溃问题 ✅ 2026年2月11日 14:52
5. ✅ 不对分布式的可利用率进行分析

### 1. 关键指标计算复核 (计算红线) ✅ 2026年2月11日 15:00

- **限电率验证**: 必须根据公式 `限电率=限电量 / (上网电量 + 限电量)` 逐一核对各场站及合计行的百分比，限电量大于发电量或上网电量不是错误逻辑。
- **区域限电率验证**: 根据表1数据计算，贵港区域场站为榕木光伏、樟木光伏、樟木风电，崇左地区场站为派岸、弄滩、六留、强胜、寨安、那小、浦峙、峙书、康宁、守旗、岑凡、把荷、武安、坤山， 必须根据公式 `限电率 = 限电量 / (上网电量 + 限电量)` 逐一核对各区域限电率百分比。
- **综合厂用电率验证**: 必须核对 `综合厂用电量 / 发电量`。
- **风电及光伏项目厂用电量验证**:分别检查风电项目与光伏项目综合厂用电量描述是否正确。风电项目综合厂用电量=坤山风电场+武安风电场+樟木风电场+把荷风电场；光伏项目综合厂用电量=综合厂用电量合计-（坤山风电场+武安风电场+樟木风电场+把荷风电场）；
- **逻辑匹配**: 检查正文描述的“最高/最低值”是否与表格中的实际数值一一对应。
- **场站日可利用率**: 统一命名，计算方法为 `∑（故障容量*故障时长） / 并网容量*24小时`。
- **等效停运时长**: 计算方法为`等效停运时长 (h) = 损失电量 (万kWh) × 10 / 停运容量 (MW)`。
- **停运总容量**: 停运总容量为表9的停运容量之和
- **等效利用小时数**: 计算方法为 `[发电量 (万kWh) × 10] / 容量 (MW或MWp)`，光伏取直流容量（MWp）。

### 2. 表格间交叉勾稽检查 (数据一致性)

- **容量一致性**: 核对【设备停运表】中的“停运容量”与【可利用率统计表】中的数据必须完全一致。
- **电量一致性**: 检查各表格的同一电量指标数值一致。【电量统计表】的合计行必须等于各分项之和，重点检查表1与表6的每个场站的发电量必须完全一致；
- **限电量一致性**: 储能表中的限电量数据需与电量总表逻辑匹配。弄滩储能限电量之和 = （板崇+六留+那小）限电量之和；守旗储能限电量 = 中原光伏项目限电量\*1.835
- **时间一致性**: 检查故障开始时间、消缺时间与“影响时长”是否逻辑相符。
- **风灾组串一致性**:表11 光伏电站组串支路故障情况统计表内描述的各场站风灾组串数量必须与表13典型、重大设备缺陷情况统计表内描述的各场站风灾剩余组串数量一致。
- **组串一致性**:表11 光伏电站组串支路故障情况统计表内描述的各场站组串数量必须与表11表格内剩余组串数量一致。如有特别描述风灾X条，运维X条，则风灾+运维=剩余组串，运维今日消缺组串不列入计算公式，且描述“组串支路故障数量存量较多的场站”总数应该与表格内一致。
- **故障持续时间一致性**: 表13典型、重大设备缺陷情况统计表中缺陷开始时间至一、安全情况中的描述的时间为表中处理进度的累计天数。
- **完成时间**: 2026-02-11 13:45
- **功能更新**: 已根据要求在审计逻辑中排除分布式场站的可利用率分析及 TOP 3 统计。

### 增加页面描述说明和导入档案模版 ✅ 2026年2月12日 12:22

功率预测分析模版：/Users/yangjie/code/antigravity/services/data parser/input/20260126 功率预测合格率.csv
运营日报表模版：/Users/yangjie/code/antigravity/services/data parser/input/2026年02月10日运营日报表.xlsx

功率预测分析说明：导入功率预测质量问题表
运营日报审核说明：导入按模版制作xlsx格式文件

### 增加页面描述说明和导入档案模版 ✅ 2026年2月11日 15:10

- 功率预测分析：增加“功率预测质量问题表”导入说明及模版下载
- 运营日报审核：增加“运营日报表”导入说明及模版下载

### 修复 Web 访问与依赖问题 ✅ 2026-02-12 09:05

- **问题描述**: 用户反馈网页打不开。
- **原因分析**:
  - 环境中缺失 `flask` 和 `python-magic` 依赖。
  - Web 服务未启动。
- **解决方案**:
  - 执行 `pip install -r requirements.txt` 补全环境依赖。
  - **新增 `check_env.py` 脚本，自动检查 Python 依赖和系统库（如 `libmagic`）。**
  - **改进 `start.sh`，在启动前强制执行环境自检。**
  - 运行 `start.sh` 启动服务并验证。
  - 按照编程规范重命名 `spec.md` 和 `update.md`，并创建 `README.md`。

- **当前状态**: 已恢复访问，地址 [http://127.0.0.1:5001](http://127.0.0.1:5001)。

### 布局优化与解析增强 ✅ 2026-02-12 09:35

- **UI/UX 优化**:
  - **布局重构**: 采用顶部通栏设计，主标题左对齐并缩小（Logo式），导航按钮右对齐，极大释放了垂直阅读空间。
  - **响应式支持**: 优化 `clamp()` 字体和媒体查询，确保在移动端和不同分辨率下布局不重叠。
  - **交互改进**: 增加上传错误拦截与智能页面切换引导。
- **解析引擎升级**:
  - **全格式适配**: 运营日报现已同时兼容旧版 `.xlsx`（多页签）和新导出的 `.xls`（单页签、单列层级结构）格式。
  - **智能识别**: 自动检测并切换 Sheet 页（如“运营日报”页），支持多种 CSV 编码（UTF-8, GB18030, GBK）。
- **环境自动化**:
  - **依赖自动补全**: `start.sh` 现支持缺失 Python 包及 macOS 系统库 (`libmagic`, `xlrd`) 的一键式自动检测与安装。
- **说明更新**: 明确运营日报导入指引：“将运营日报导出的xls/xlsx文件导入”。

## 待增加

增加功率预测数据对比功能，勾选两次数据，对比并输出结果
