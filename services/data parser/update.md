# 更新记录

## 基本部署 2026年2月10日 13:30

✅项目结构初始化与规划 [/]
✅创建✅spec.md(Web 版本)
✅设立 output 文件夹
✅后端开发 (Flask/FastAPI) [ ]
✅迁移analyzer.py逻辑到 Web 后端
✅实现文件上传与处理接口
✅实现分析报告导出接口
✅前端开发 (HTML/CSS/JS) [ ]
✅搭建简约大气的 UI 界面
✅实现文件拖拽上传交互
✅展示分析简报 (Top 3 场站与问题)
✅验证与部署 [ ]
✅E2E 测试验证
✅编写启动脚本

## 完成处理

看不到场站的数据 ✅ 2026年2月10日 13:33
报告内容有问题 ✅ 2026年2月10日 13:39
优化场站显示排版 ✅ 2026年2月10日 13:47
报告首先按总体汇总、显示图标，然后按站按类别排版、汇总 ✅ 2026年2月10日 13:47
点击运行深度分析后，弹出一个打开文件的窗口，增加一个打开文件按钮 ✅ 2026年2月10日 13:47
增加部署到本地nas功能，配置 ✅ 2026年2月10日 14:46
NAS_USER="yjiefl"
NAS_IP="192.168.3.10"
NAS_PORT="22222"

## 后续更新

### 新功能：运营日报表自动化审核

- **完成时间**: 2026-02-11 13:10
- **功能描述**:
  - 将 daily_report_processor.py 逻辑集成到 Web 平台，实现 .xlsx 日报文件的上传与审核。
  - 新增 daily_report.html 前端页面，与现有 UI 风格统一。
  - 在 power_prediction.html 和 daily_report.html 顶部增加导航栏，实现功能切换。
  - 后端新增 /daily_report 相关路由，支持生成 JSON 数据及 PDF 报告。

### 2026-02-11 12:30:00

- **任务**: 重新审核 2026年02月10日运营日报表.xlsx
- **状态**: 已完成
- **改进内容**:
  - 安装了 `reportlab` 依赖以支持 PDF 报告生成。
  - 运行 `daily_report_processor.py` 完成了数据清洗与异常审计。
  - 输出了 `analysis_report.txt` 和 `analysis_report.pdf`。
  - 关键发现：贵港公司樟木站存在 173 台逆变器被人为拉停，影响容量巨大。
- **待改进**:
  - 分布式场站的利用率记录普遍缺失，需核实报表源头是否支持该项数据追踪。
  - PDF 字体当前硬编码为 `/Library/Fonts/Arial Unicode.ttf`，在不同系统上可能路径不一。
    部分问题提示为未知问题

1. 删除功能要加密码，禁止随意删除 密码：yj666 ✅ 2026年2月11日 14:44
2. 计算正确的，要显示计算过程 ✅ 2026年2月11日 14:44
3. 修复 NAS 部署后 502 问题（端口映射修正 5004:5001） ✅ 2026年2月11日 14:48
4. 修复 NAS 部署缺失依赖 (reportlab) 导致容器崩溃问题 ✅ 2026年2月11日 14:52
5. ✅ 不对分布式的可利用率进行分析

### 1. 关键指标计算复核 (计算红线) ✅ 2026年2月11日 15:00

- **限电率验证**: 必须根据公式 `限电率=限电量 / (上网电量 + 限电量)` 逐一核对各场站及合计行的百分比，限电量大于发电量或上网电量不是错误逻辑。
- **区域限电率验证**: 根据表1数据计算，贵港区域场站为榕木光伏、樟木光伏、樟木风电，崇左地区场站为派岸、弄滩、六留、强胜、寨安、那小、浦峙、峙书、康宁、守旗、岑凡、把荷、武安、坤山， 必须根据公式 `限电率 = 限电量 / (上网电量 + 限电量)` 逐一核对各区域限电率百分比。
- **综合厂用电率验证**: 必须核对 `综合厂用电量 / 发电量`。
- **风电及光伏项目厂用电量验证**:分别检查风电项目与光伏项目综合厂用电量描述是否正确。风电项目综合厂用电量=坤山风电场+武安风电场+樟木风电场+把荷风电场；光伏项目综合厂用电量=综合厂用电量合计-（坤山风电场+武安风电场+樟木风电场+把荷风电场）；
- **逻辑匹配**: 检查正文描述的“最高/最低值”是否与表格中的实际数值一一对应。
- **场站日可利用率**: 统一命名，计算方法为 `∑（故障容量*故障时长） / 并网容量*24小时`。
- **等效停运时长**: 计算方法为`等效停运时长 (h) = 损失电量 (万kWh) × 10 / 停运容量 (MW)`。
- **停运总容量**: 停运总容量为表9的停运容量之和
- **等效利用小时数**: 计算方法为 `[发电量 (万kWh) × 10] / 容量 (MW或MWp)`，光伏取直流容量（MWp）。

### 2. 表格间交叉勾稽检查 (数据一致性)

- **容量一致性**: 核对【设备停运表】中的“停运容量”与【可利用率统计表】中的数据必须完全一致。
- **电量一致性**: 检查各表格的同一电量指标数值一致。【电量统计表】的合计行必须等于各分项之和，重点检查表1与表6的每个场站的发电量必须完全一致；
- **限电量一致性**: 储能表中的限电量数据需与电量总表逻辑匹配。弄滩储能限电量之和 = （板崇+六留+那小）限电量之和；守旗储能限电量 = 中原光伏项目限电量\*1.835
- **时间一致性**: 检查故障开始时间、消缺时间与“影响时长”是否逻辑相符。
- **风灾组串一致性**:表11 光伏电站组串支路故障情况统计表内描述的各场站风灾组串数量必须与表13典型、重大设备缺陷情况统计表内描述的各场站风灾剩余组串数量一致。
- **组串一致性**:表11 光伏电站组串支路故障情况统计表内描述的各场站组串数量必须与表11表格内剩余组串数量一致。如有特别描述风灾X条，运维X条，则风灾+运维=剩余组串，运维今日消缺组串不列入计算公式，且描述“组串支路故障数量存量较多的场站”总数应该与表格内一致。
- **故障持续时间一致性**: 表13典型、重大设备缺陷情况统计表中缺陷开始时间至一、安全情况中的描述的时间为表中处理进度的累计天数。
- **完成时间**: 2026-02-11 13:45
- **功能更新**: 已根据要求在审计逻辑中排除分布式场站的可利用率分析及 TOP 3 统计。

### 增加页面描述说明和导入档案模版 ✅ 2026年2月12日 12:22

功率预测分析模版：/Users/yangjie/code/antigravity/services/data parser/input/20260126 功率预测合格率.csv
运营日报表模版：/Users/yangjie/code/antigravity/services/data parser/input/2026年02月10日运营日报表.xlsx

功率预测分析说明：导入功率预测质量问题表
运营日报审核说明：导入按模版制作xlsx格式文件

### 增加页面描述说明和导入档案模版 ✅ 2026年2月11日 15:10

- 功率预测分析：增加“功率预测质量问题表”导入说明及模版下载
- 运营日报审核：增加“运营日报表”导入说明及模版下载

### 修复 Web 访问与依赖问题 ✅ 2026-02-12 09:05

- **问题描述**: 用户反馈网页打不开。
- **原因分析**:
  - 环境中缺失 `flask` 和 `python-magic` 依赖。
  - Web 服务未启动。
- **解决方案**:
  - 执行 `pip install -r requirements.txt` 补全环境依赖。
  - **新增 `check_env.py` 脚本，自动检查 Python 依赖和系统库（如 `libmagic`）。**
  - **改进 `start.sh`，在启动前强制执行环境自检。**
  - 运行 `start.sh` 启动服务并验证。
  - 按照编程规范重命名 `spec.md` 和 `update.md`，并创建 `README.md`。

- **当前状态**: 已恢复访问，地址 [http://127.0.0.1:5001](http://127.0.0.1:5001)。

### 布局优化与解析增强 ✅ 2026-02-12 09:35

- **UI/UX 优化**:
  - **布局重构**: 采用顶部通栏设计，主标题左对齐并缩小（Logo式），导航按钮右对齐，极大释放了垂直阅读空间。
  - **响应式支持**: 优化 `clamp()` 字体和媒体查询，确保在移动端和不同分辨率下布局不重叠。
  - **交互改进**: 增加上传错误拦截与智能页面切换引导。
- **解析引擎升级**:
  - **全格式适配**: 运营日报现已同时兼容旧版 `.xlsx`（多页签）和新导出的 `.xls`（单页签、单列层级结构）格式。
  - **智能识别**: 自动检测并切换 Sheet 页（如“运营日报”页），支持多种 CSV 编码（UTF-8, GB18030, GBK）。
- **环境自动化**:
  - **依赖自动补全**: `start.sh` 现支持缺失 Python 包及 macOS 系统库 (`libmagic`, `xlrd`) 的一键式自动检测与安装。
- **说明更新**: 明确运营日报导入指引：“将运营日报导出的xls/xlsx文件导入”。

## 待增加

/Users/yangjie/code/antigravity/services/data parser
改进这个项目，功率预测分析增加对这个文件的支持：/Users/yangjie/code/antigravity/services/data parser/input/GX-2026-02-12.xlsx

### 增加功率预测分析对 GX-yyyy-mm-dd.xlsx 格式支持 ✅ 2026-02-14 20:20

- **功能更新**:
  - 新增对 `GX-yyyy-mm-dd.xlsx` 格式文件的支持。
  - 针对该格式文件，**自动放开场站白名单限制**，支持全量场站分析（本次测试发现 336 个场站）。
  - 优化解析正则，支持含中括号 `[]` 的考核条件格式（如 `[全站可利用有功功率]`）。
功率预测分析增加一个选项，勾选后只分析中能建广西公司的场站 ✅已完成 2026年2月14日 21:18
  派岸光伏电站
  浦峙光伏电站
  寨安光伏电站
  樟木光伏电站
  强胜光伏电站
  守旗光伏电站
  弄滩光伏电站
  康宁光伏电站
  峙书光伏电站
  榕木光伏电站
  驮堪光伏电站
  岑凡光伏电站
  坤山风电场
  把荷风电场
  武安风电场
  樟木风电场
功率预测分析增加数据对比功能：勾选任意两次分析历史记录，对比两次数据的变化，统计、分析、评估功率预测各个数据质量指标是否有改善，输出对比结果报告。（已完成 2026-02-14 20:50:00） ✅ 2026年2月14日 21:19
  - **对比看板升级**：比对结果不再以弹窗显示，而是集成到主页面下方，采用与深度分析一致的专业看板样式。
  - **穿透式联动**：点击场站或考核项支持深度穿透，直观查看变化原因及具体轨迹。
  - **专业报告导出**：新增对比分析的 Excel 和 PDF 报告导出功能，支持离线汇报。 ✅ 已完成 2026年2月14日 21:40

## 已完成 2026年2月14日 22:15，两个细则功能并入

将这个项目：/Users/yangjie/code/antigravity/两个细则分析系统
并入本项目：/Users/yangjie/code/antigravity/services/data parser
多一个选项「两个细则分析」 ✅ 已完成 2026年2月14日 22:15

## 历史修正记录

- [x] 修正对比穿透页面“全周期具体原因追踪”为空的问题（2026-02-14）

改进UI设计

## 两个细则分析系统 更新记录

### 核心功能完成情况

- [x] Excel 数据自动化清洗与录入 (支持多级表头)
- [x] 场站名称标准化映射
- [x] 经营损益多维分析 (净收入排名)
- [x] 考核动因占比分析
- [x] 功率预测申诉减免成效评估
- [x] Web 交互界面 (文件上传 + 可视化仪表盘)
- [x] 详细 Excel 分析报表导出

### 更新日志

#### 2026-02-14 21:30:00

- **初始化项目**: 建立 Flask 后端架构。
- **完成核心解析器**: `analysis_core.py` 支持对“数据表（两个细则系统）”复杂结构的智能识别与提取。
- **实现可视化大屏**: 前端采用 ECharts 展示功率预测考核对比、利润排名及考核构成。
- **状态**: 已完成核心逻辑开发及测试。

#### 2026-02-14 21:36:00

- **服务管理**: 制作并交付 `start.sh` (支持自动清理旧进程) 与 `stop.sh` 脚本，并赋予以执行权限。
- **项目交付**: 完成所有核心功能并通过单元逻辑测试及 Web 界面连通性测试。
- **历史记录**: 增加两个细则分析的历史记录存档、调取与删除功能。
- **功能补全**: 增加辅助服务补偿结构分析与同类场站（风电/光伏）考核强度对标看板。
- **状态**: ✅ 已完成 2026-02-14 22:15:00

#### 任务 2026-02-15 09:00:00

1. **按月、年统计**: 实现了从结算单中解析日期，并支持在前端按月份/周期进行筛选与重新统计。
2. **UI 优化**:
   - 调整布局为每维度单行显示，增强可读性。
   - 优化 ECharts 边距，解决数值标签被遮挡问题。
   - 优化对比色方案，解决扇区颜色过近无法区分的问题。

- **状态**: ✅ 已完成 2026-02-15 09:00:00

#### 已完成 2026-02-15 09:20:00

1. **多维筛选**:
    - 修复了周期选择器显示问题。
    - 新增了“场站”筛选器，支持查看单一场站的详细考核数据。
2. **考核细分**:
    - 将散乱的考核项（如“运行管理-报表迟报”、“技术指导-检修计划”）聚合为6大类（技术指导、功率预测、AGC/AVC等），饼图更清晰。
    - 实现了**二级穿透**：点击饼图大类，可查看该类下的具体考核项排名及涉及场站。
3. **免考与申诉分离**:
    - 专门提取“功率预测”与“数据合格率”的免考增益，独立展示。
    - 预留了“申诉效果”展示位（待接入申诉台账数据）。

- **状态**: ✅ 已完成 2026-02-15 09:20:00

#### 已完成 2026-02-15 12:15:00

1. **处理图片UI异常 (彻底修复)**:
    - 针对图表容器初始化时高度未及时计算导致的“压扁”现象，增加了多次布局强制刷新机制（Resize Listeners）。
    - 统一了所有图表卡片的 `min-height` 规范，并增强了 CSS 优先级（!important）。
2. **解决对标数据不显示问题**:
    - 修复了“同类场站考核强度对标”表格数据为空的问题。通过增强后端列名识别算法，兼容了结算单中不同 Sheet 页的表头命名差异（如“总考核电量”等变体）。
3. **完善点击穿透功能**:
    - 确保在“重新筛选”、“切换历史记录”等所有交互场景下，图表和排行榜的穿透功能均能正常运作。

#### 已完成 2026-02-15 12:30:00

1. **考核费用与考核电量数据分离**:
    - **后端重构**: 将《公示-表二》（结算单，万元）与《数据表》（中间表，MWh）的数据源分开加载，确保财务统计准确无误。
    - **前端优化**: 首页“考核动因分析”饼图统一使用**考核费用（万元）**，与财务报表口径一致。
    - **交互增强**: 场站钻取详情页增加“**考核费用(万元)/考核电量(MWh)**”切换开关，既能查成本，又能溯源与技术指标的偏差。
    - **数据展示**: “重点考核对标”中的数值明确标注为 **MWh**，体现技术考核强度。

- **状态**: ✅ 已完成 2026-02-15 12:30:00

#### 已完成 2026-02-15 13:24:00

1. 完成显示总计 ✅
2. 完成色彩风格调整：橙色 ✅
3. 完成正负值颜色逻辑 ✅

#### 已完成 2026-02-15 14:00:00

1. **详细考核分析弹窗优化**:
    - **图表升级**: 左侧“细分项占比”饼图（清晰展示构成），右侧“涉及场站排名”全量柱状图（取消 Top 10 限制，展示完整数据）。
    - **交互调整**:
        - 根据需求**移除了二级钻取功能**，点击饼图不再过滤右侧场站，保持公示数据的全局概览视角。
        - 弹窗标题动态显示当前筛选的“周期”和“场站”信息（如 `2026-02 · 楠木风电场`），避免数据混淆。
    - **布局优化**:
        - 移除了“涉及场站排名”图表的内部滚动条，改为高度自适应，一目了然。
        - 修复了数据映射（`item_group_map`）导致的弹窗打不开问题。
2. **状态**: ✅ 已完成

#### 已完成 2026-02-15 14:15:00

1. **场站详情弹窗交互升级**:
    - **双视图支持**: 实现了“考核费用(万元)”与“考核电量(MWh)”的一键切换，确保财务与技术数据的双向溯源。
    - **数图联动**:
        - **双向高亮**: 鼠标悬停在右侧明细列表时，左侧饼图对应扇区会自动高亮，直观展示占比情况。
        - **视觉统一**: 为列表项增加了与饼图一致的颜色标记（Color Dots），解决了“对不上号”的困扰。
        - **动态交互**: 当在饼图图例中取消勾选某一项（如“投运率考核”）时，右侧列表及总计数值会**实时联动更新**，方便用户进行假设性分析（What-if Analysis）。
    - **布局优化**:
        - 将饼图图例调整为**滚动模式**（Scrollable），解决了因考核细分项过多导致图例遮挡图表的问题。
        - 净化了“考核电量”视图，自动排除“装机容量”、“并网时间”等非考核类指标，提高数据纯度。

2. **状态**: ✅ 已完成

#### 已完成 2026年2月15日 14:20

1. 图例布局回归：将场站详情页中的饼图图例恢复为分行显示（Wrap Layout），不再强制单行滚动，方便一眼查看所有图例项。通过限制图例宽度（90%）并居中，确保其自动换行且不溢出。
2. 弹窗尺寸扩容：将弹窗的最大宽度从 1000px 增加到了 1250px，为您展示更多数据细节和更舒展的图表布局提供空间。

#### 已完成 2026年2月15日 14:32

1. **场站详情弹窗信息增强**:
    - **动态标题**: 在场站详情弹窗标题中增加了**当前筛选的日期周期**信息。例如：`樟木风电场 - 考核与补偿明细 2026-02`。这确保了用户在查看具体明细时，能够清晰感知当前数据所属的时间维度，避免因多窗口切换导致的数据误读。

#### 已完成 2026年2月15日 14:55

1. **可视化界面深度优化**:
    - **弹窗空间扩容**: 将全局弹窗最大宽度从 `1250px` 进一步提升至 `1500px`。优化后的超宽屏布局确保了在侧重复杂数据的钻取分析（Drill-down）时，左侧图表与右侧明细表有更充裕的并排空间，彻底消除文字重叠隐患。
    - **图例交互优化**: 为所有饼图图例引入了**分页滚动（Scroll）**机制。即使场站涉及的考核子项极多，图例也会以优雅的翻页形式呈现，既保持了界面的整洁，又确保了每一项考核数据都清晰可辨。
    - **考核明细表增强**: 在场站考核明细表中增加了**粘性表头（Sticky Header）**与**色彩标识**。表头在滚动时保持可见，每一行均配有与饼图对应的颜色小块，实现了图表与数据的直观视觉联动。
2. **功能调整**:
    - **取消自动巡检看板**: 应用户要求，暂时移除了首页的“关键指标巡检汇总 (MWh)”区块，待后续根据实际业务场景重新定义该模块的逻辑与展示形式。

#### 已完成 2026年2月15日 14:35

1. **核心解析引擎逻辑修复**:
    - **修复 MWh 穿透分析空白问题**: 解决了在“详细考核分析”弹窗中切换到“考核电量 (MWh)”视图时，图表和列表显示为空的问题。
    - **原因分析**: 此前 `item_group_map` 仅包含了财务项（万元）的名称映射，导致在电量视图下无法识别逻辑对应的电量科目列名。
    - **解决方案**: 升级了后端解析器，实现了电量科目与财务科目的**联合映射同步**。现在解析引擎会自动识别所有考核电量相关的原始科目，并将其归类到对应的考核维度（如：功率预测、AGC/AVC 等），确保了技术数据与财务数据的双向穿透链路闭环。

#### 已完成 2026年2月15日 15:15

1. **考核指标体系全量重构**:
    - **18个标准化分类**: 按照业务逻辑将成百上千个考核科目精准划分为 `发电计划`、`一次调频`、`AVC`、`功率预测`、`技术指导与管理` 等 18 个核心维度。
    - **双倍统计消除算法**: 攻克了报表中“总额项”与“明细项”并存导致的统计翻倍难题。系统现在能自动识别包含“总计/合计”关键字的列，并与明细细分列进行冲突校验，确保可视化报表中的分量加总始终等于物理总量。
    - **穿透链路闭环**: 前后端同步支持该去重逻辑，无论是首页宏观占比还是场站微观明细，数据表现始终保持一致、准确。

### 待更新

增加按月、按年形成报告功能
增加主要指标展示
