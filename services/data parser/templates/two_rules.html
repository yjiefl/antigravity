<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸¤ä¸ªç»†åˆ™åˆ†æå·¥ä½œç«™</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
      :root {
        --bg-dark: #0f172a; /* Slate 900 */
        --card-bg: #1e293b; /* Slate 800 */
        --primary-color: #f97316; /* Orange 500 */
        --accent-color: #fbbf24; /* Amber 400 */
        --text-main: #f8fafc;
        --text-sub: #cbd5e1;
        --glass-border: rgba(249, 115, 22, 0.2);
      }
      body {
        background-color: var(--bg-dark);
        background-image:
          radial-gradient(
            circle at 0% 0%,
            rgba(249, 115, 22, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 100% 100%,
            rgba(251, 191, 36, 0.15) 0%,
            transparent 50%
          );
        color: var(--text-main);
        font-family:
          "Inter",
          -apple-system,
          sans-serif;
        margin: 0;
        padding: 2rem;
      }
      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        z-index: 1000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: var(--card-bg);
        width: 95%;
        max-width: 1500px;
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        padding: 2.5rem;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }
      .modal-close {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        background: none;
        border: none;
        color: var(--text-sub);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s;
      }
      .modal-close:hover {
        color: #fff;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      .data-table th {
        text-align: left;
        padding: 0.8rem;
        color: var(--text-sub);
        border-bottom: 1px solid var(--glass-border);
      }
      .data-table td {
        padding: 0.8rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
      }
      .theme-rules {
        --primary-color: #f97316;
        --accent-color: #fbbf24;
        --bg-gradient: radial-gradient(circle at top right, #451a03, #0f172a);
      }
      .grid-3 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }
      .metric-card {
        padding: 1.5rem;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.05); /* Slightly brighter */
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
      }
      /* Ensure viz grid expands */
      .viz-grid {
        display: grid;
        grid-template-columns: 1fr; /* Force 1 column per row */
        gap: 2rem;
        width: 100%;
      }
      .card {
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 2rem;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .chart-card {
        min-height: 550px !important;
      }
      .wide-card {
        grid-column: auto;
      }
      @media (max-width: 1000px) {
        .viz-grid {
          grid-template-columns: 1fr;
        }
        .wide-card {
          grid-column: span 1;
        }
      }
      .chart-container {
        flex: 1;
        width: 100%;
        min-height: 0; /* Flex fix */
        position: relative;
      }
      .metric-label {
        color: #94a3b8;
        font-size: 0.9rem;
        margin-bottom: 0.8rem;
        font-weight: 600;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.4rem;
      }
      /* Toggle Segment Control */
      .toggle-group {
        display: inline-flex;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
      }
      .toggle-item {
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s;
        border: none;
        color: var(--text-sub);
        background: transparent;
      }
      .toggle-item.active {
        background: var(--primary-color);
        color: #fff;
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }
      .toggle-group.theme-mwh .active {
        background: #10b981 !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
      }
      .nav-btn.active {
        background: var(--primary-color);
        box-shadow: 0 4px 12px -2px rgba(249, 115, 22, 0.3) !important;
      }
      .ranking-list {
        position: relative;
        max-height: 1000px;
        overflow-y: auto;
        scrollbar-width: thin;
      }
      .ranking-list::-webkit-scrollbar {
        display: none;
      }
      .ranking-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.4rem;
        font-size: 0.85rem;
        transition: all 0.2s;
        cursor: pointer;
      }
      .ranking-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .rank-idx {
        width: 1.8rem;
        font-weight: 800;
        color: #475569;
        font-style: italic;
      }
      .rank-idx.top {
        color: #f59e0b;
      }
      .rank-name {
        flex: 1;
        color: #e2e8f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 0.5rem;
      }
      .rank-val {
        font-family: "JetBrains Mono", monospace;
        font-weight: 600;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body class="theme-rules">
    <div class="container">
      <header class="app-header">
        <div class="branding">
          <h1>ä¸¤ä¸ªç»†åˆ™Â·å¹¶ç½‘è€ƒæ ¸åˆ†æ</h1>
          <p>è‡ªåŠ¨åŒ–ç»Ÿè®¡æŸç›Šã€è€ƒæ ¸åŠ¨å› åŠç”³è¯‰å¯¹æ¯”</p>
        </div>

        <nav class="top-nav">
          <a href="/power_prediction" class="btn btn-secondary nav-btn"
            >åŠŸç‡é¢„æµ‹åˆ†æ</a
          >
          <a href="/daily_report" class="btn btn-secondary nav-btn"
            >è¿è¥æ—¥æŠ¥å®¡æ ¸</a
          >
          <a href="/two_rules" class="btn nav-btn active">ä¸¤ä¸ªç»†åˆ™åˆ†æ</a>
        </nav>
      </header>

      <section class="upload-section">
        <div class="upload-box" id="dropZone">
          <div id="fileTriggerArea" style="cursor: pointer; padding: 2rem">
            <span style="font-size: 3rem">ğŸ“Š</span>
            <p
              id="fileDisplay"
              style="
                color: var(--text-muted);
                font-size: 1rem;
                margin-top: 1rem;
              "
            >
              ç‚¹å‡»æµè§ˆæ–‡ä»¶ æˆ– æ‹–å…¥ä¸¤ä¸ªç»†åˆ™ç»“ç®—å• <br />
              <span style="font-size: 0.85rem; color: #64748b"
                >(æ”¯æŒ .xlsx æ ¼å¼ï¼Œéœ€åŒ…å«æ•°æ®è¡¨åŠæ±‡æ€»è¡¨)</span
              >
            </p>
          </div>
          <input
            type="file"
            id="fileInput"
            accept=".xlsx"
            style="display: none"
          />
          <button
            class="btn btn-primary"
            onclick="document.getElementById('fileInput').click()"
            style="margin-top: 1rem"
          >
            é€‰æ‹©æ–‡ä»¶å¹¶åˆ†æ
          </button>

          <div id="uploadStatus" style="display: none; margin-top: 1rem">
            <div class="spinner"></div>
            <p style="color: var(--primary-color)">
              æ­£åœ¨è¿›è¡Œå¤šç»´äº¤å‰åˆ†æï¼Œè¯·ç¨å€™...
            </p>
          </div>
        </div>
      </section>

      <section
        class="viz-grid"
        id="historySection"
        style="margin-top: 1rem; margin-bottom: 2rem; display: block !important"
      >
        <div
          class="card wide-card"
          style="padding: 1.5rem; border: 1px dashed var(--glass-border); min-height: auto;"
        >
          <div
            class="card-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              padding-bottom: 0.8rem;
              margin-bottom: 1rem;
            "
          >
            <span style="font-size: 1.1rem">ğŸ“‚ å†å²åˆ†æè®°å½•</span>
            <span
              id="historyCount"
              style="
                font-size: 0.85rem;
                color: var(--primary-color);
                font-weight: 600;
              "
              >æ£€æµ‹ä¸­...</span
            >
          </div>
          <div
            id="historyList"
            style="
              display: flex;
              flex-direction: column;
              gap: 0.8rem;
              max-height: 200px;
              overflow-y: auto;
              padding-right: 0.5rem;
            "
          >
            <!-- å†å²è®°å½•åˆ—è¡¨ -->
          </div>
        </div>
      </section>

      <div id="resultsArea" style="display: none">
        <div
          class="flex-row"
          style="
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.02);
            padding: 1rem 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
          "
        >
          <div style="display: flex; align-items: center; gap: 1.5rem">
            <h2 style="color: #fff; margin: 0; font-size: 1.4rem">
              æ ¸å¿ƒåˆ†æçœ‹æ¿
            </h2>
            <div
              id="filterWrap"
              style="
                display: none;
                align-items: center;
                gap: 0.8rem;
                padding-left: 1.5rem;
                border-left: 1px solid rgba(255, 255, 255, 0.1);
              "
            >
              <div style="display: flex; align-items: center; gap: 0.5rem">
                <span style="color: var(--text-sub); font-size: 0.9rem"
                  >å‘¨æœŸ:</span
                >
                <select
                  id="periodSelect"
                  style="
                    background: var(--bg-dark);
                    color: #fff;
                    border: 1px solid var(--glass-border);
                    padding: 0.4rem 0.8rem;
                    border-radius: 8px;
                    font-family: inherit;
                    font-size: 0.9rem;
                    cursor: pointer;
                    outline: none;
                    min-width: 110px;
                  "
                >
                  <option value="all">å…¨éƒ¨</option>
                </select>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem">
                <span style="color: var(--text-sub); font-size: 0.9rem"
                  >åœºç«™:</span
                >
                <select
                  id="stationSelect"
                  style="
                    background: var(--bg-dark);
                    color: #fff;
                    border: 1px solid var(--glass-border);
                    padding: 0.4rem 0.8rem;
                    border-radius: 8px;
                    font-family: inherit;
                    font-size: 0.9rem;
                    cursor: pointer;
                    outline: none;
                    min-width: 160px;
                  "
                >
                  <option value="all">å…¨éƒ¨</option>
                </select>
              </div>
            </div>
          </div>
          <a
            id="downloadReport"
            href="#"
            class="btn"
            style="
              background: #10b981;
              border: none;
              font-weight: 600;
              padding: 0.8rem 1.5rem;
              border-radius: 10px;
              color: #fff;
              text-decoration: none;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              font-size: 1rem;
            "
          >
            ğŸš¢ ä¸‹è½½è¯¦ç»†åˆ†ææŠ¥å‘Š (Excel)
          </a>
        </div>

        <!-- å…³é”®æ’è¡Œæ¦œ -->
        <div class="grid-3" style="margin-bottom: 1.5rem">
          <div
            class="metric-card"
            style="border-top: 3px solid #ef4444; padding: 1.2rem"
          >
            <div
              class="metric-label"
              style="display: flex; justify-content: space-between"
            >
              <span>ğŸš© æŸç›Šæœ€å¤§äºæŸæ’è¡Œ</span>
            </div>
            <div class="ranking-list" id="lossRankingList"></div>
          </div>
          <div
            class="metric-card"
            style="border-top: 3px solid #10b981; padding: 1.2rem"
          >
            <div
              class="metric-label"
              style="display: flex; justify-content: space-between"
            >
              <span>ğŸ† æŸç›Šæœ€å¤§ç›ˆåˆ©æ’è¡Œ</span>
            </div>
            <div class="ranking-list" id="profitRankingList"></div>
          </div>
          <div
            class="metric-card"
            style="border-top: 3px solid #10b981; padding: 1.2rem"
          >
            <div
              class="metric-label"
              style="display: flex; justify-content: space-between"
            >
              <span>ğŸ›¡ï¸ å…è€ƒå¢ç›Šæ’è¡Œ (MWh)</span>
            </div>
            <div class="ranking-list" id="exemptionRankingList"></div>
          </div>
        </div>

        <div class="viz-grid" id="chartsGrid" style="display: none">
          <!-- ç»è¥æŸç›Šæ’è¡Œ -->
          <div class="card wide-card chart-card">
            <div class="card-title" id="profitChartTitle">åœºç«™ç»è¥æŸç›Šåˆ†å¸ƒ (TOP 10)</div>
            <div id="profitChart" class="chart-container"></div>
          </div>

          <!-- è€ƒæ ¸é¡¹æ„æˆ -->
          <div class="card chart-card">
            <div class="card-title" id="compositionChartTitle">è€ƒæ ¸åŠ¨å› é¡¹å æ¯”åˆ†æ</div>
            <div id="compositionChart" class="chart-container"></div>
          </div>

          <!-- è¡¥å¿é¡¹æ„æˆ -->
          <div class="card chart-card">
            <div class="card-title" id="compChartTitle">è¾…åŠ©æœåŠ¡è¡¥å¿æ„æˆåˆ†æ</div>
            <div id="compChart" class="chart-container"></div>
          </div>


          <!-- å…è€ƒä¸ç”³è¯‰ -->
          <div class="card wide-card chart-card">
            <div class="card-title" id="exemptionChartTitle">å…è€ƒä¸ç”³è¯‰å¢ç›Šåˆ†æ</div>
            <div
              class="grid-3"
              style="
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
                margin-bottom: 0;
                height: 100%;
              "
            >
              <div style="flex: 1">
                <h4
                  style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 1rem"
                >
                  åœºç«™å…è€ƒå¢ç›Šæ’å (å…¨éƒ¨)
                </h4>
                <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                    <div
                      id="exemptionChart"
                      class="chart-container"
                      style="height: 300px"
                    ></div>
                </div>
              </div>
              <!-- Appeal placeholder or future chart -->
              <div
                style="
                  flex: 1;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border: 1px dashed rgba(255, 255, 255, 0.1);
                  border-radius: 12px;
                "
              >
                <div style="text-align: center; color: #64748b">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem">âš–ï¸</div>
                  <div>ç”³è¯‰æ•ˆæœç»Ÿè®¡æš‚æ— æ•°æ®</div>
                  <div style="font-size: 0.8rem; opacity: 0.7">
                    (éœ€æ¥å…¥å•ç‹¬ç”³è¯‰å°è´¦)
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœˆåº¦è¶‹åŠ¿åˆ†æ (æ–°å¢) -->
        <div class="card wide-card chart-card" id="trendCard" style="display: none; margin-top: 1.5rem;">
          <div class="card-title">æœˆåº¦è¶‹åŠ¿æŒ‡æ ‡æ³¢åŠ¨åˆ†æ</div>
          
          <div style="display: flex; gap: 1.5rem; margin: 1rem 0; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 12px; flex-wrap: wrap; align-items: center;">
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <span style="color: #94a3b8; font-size: 0.9rem">èµ·å§‹:</span>
              <select id="trendStartPeriod" style="background: #1e293b; color: #fff; border: 1px solid #334155; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;" onchange="updateTrends()">
                <option value="all">æœ€æ—©</option>
              </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <span style="color: #94a3b8; font-size: 0.9rem">ç»“æŸ:</span>
              <select id="trendEndPeriod" style="background: #1e293b; color: #fff; border: 1px solid #334155; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;" onchange="updateTrends()">
                <option value="all">æœ€æ™š</option>
              </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <span style="color: #94a3b8; font-size: 0.9rem">å¹´åº¦:</span>
              <select id="trendYear" style="background: #1e293b; color: #fff; border: 1px solid #334155; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;" onchange="updateTrends()">
                <option value="all">å…¨éƒ¨</option>
              </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <span style="color: #94a3b8; font-size: 0.9rem">åœºç«™:</span>
              <select id="trendStation" style="background: #1e293b; color: #fff; border: 1px solid #334155; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;" onchange="updateTrends()">
                <option value="all">å…¨éƒ¨åœºç«™å¯¹æ¯”</option>
              </select>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem">
              <span style="color: #94a3b8; font-size: 0.9rem">æŒ‡æ ‡:</span>
              <select id="trendIndicator" style="background: #1e293b; color: #fff; border: 1px solid #334155; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;" onchange="updateTrends()">
                <option value="overview">æ€»ä½“æŸç›Šæ¦‚è§ˆ</option>
              </select>
            </div>
          </div>

          <div id="trendChart" class="chart-container" style="height: 400px"></div>
        </div>
      </div>
    </div>

    <!-- Drill-down Modal -->
    <div class="modal-overlay" id="detailModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <h2 id="modalTitle" style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
          è¯¦æƒ…åˆ†æ
        </h2>
        <div id="modalTableWrap"></div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const dropZone = document.getElementById("dropZone");
      const uploadStatus = document.getElementById("uploadStatus");
      const resultsArea = document.getElementById("resultsArea");
      const periodSelect = document.getElementById("periodSelect");
      const stationSelect = document.getElementById("stationSelect");
      const filterWrap = document.getElementById("filterWrap");

      let currentFilename = ""; // Store current working filename

      // Drag and Drop
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "var(--primary-color)";
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.style.borderColor = "rgba(255, 255, 255, 0.1)";
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "rgba(255, 255, 255, 0.1)";
        const file = e.dataTransfer.files[0];
        if (file) handleUpload(file);
      });

      fileInput.addEventListener("change", (e) =>
        handleUpload(e.target.files[0]),
      );

      async function handleUpload(file) {
        if (!file) return;

        uploadStatus.style.display = "block";
        resultsArea.style.display = "none";

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch("/upload_two_rules", {
            method: "POST",
            body: formData,
          });
          const json = await res.json();

          if (json.success) {
            currentFilename = file.name;
            renderDashboard(json.data);
            document.getElementById("downloadReport").href = json.report_url;
            resultsArea.style.display = "block";
            document.getElementById("chartsGrid").style.display = "grid"; // Ensure charts are shown

            // Wait for DOM update then render
            setTimeout(() => {
              window.dispatchEvent(new Event("resize"));
              resultsArea.scrollIntoView({ behavior: "smooth" });
            }, 100);
            
            setTimeout(() => {
              window.dispatchEvent(new Event("resize"));
            }, 500);

            fetchHistory(); // Refresh history after upload
          } else {
            alert("åˆ†æå¤±è´¥: " + json.error);
          }
        } catch (err) {
          alert("ç½‘ç»œé”™è¯¯");
        } finally {
          uploadStatus.style.display = "none";
        }
      }

      let globalData = null; // Store data for interactions

      function renderDashboard(data) {
        globalData = data; // Save to global scope

        // Update Filters
        const showPeriod =
          data.available_periods && data.available_periods.length > 0;
        const showStation =
          data.available_stations && data.available_stations.length > 0;

        if (showPeriod || showStation) {
          filterWrap.style.display = "flex";

          // Period
          if (showPeriod) {
            periodSelect.innerHTML =
              '<option value="all">å…¨éƒ¨å‘¨æœŸ</option>' +
              data.available_periods
                .map(
                  (p) =>
                    `<option value="${p}" ${data.selected_period === p ? "selected" : ""}>${p}</option>`,
                )
                .join("");
          }

          // Station
          if (showStation) {
            stationSelect.innerHTML =
              '<option value="all">å…¨éƒ¨åœºç«™</option>' +
              data.available_stations
                .map(
                  (s) =>
                    `<option value="${s}" ${data.selected_station === s ? "selected" : ""}>${s}</option>`,
                )
                .join("");
          }
        } else {
          filterWrap.style.display = "none";
        }

        // --- Render Rankings ---
        const renderRankList = (
          elId,
          list,
          key,
          color,
          unit,
          isProfit = false,
        ) => {
          const listEl = document.getElementById(elId);
          if (!list || list.length === 0) {
            listEl.innerHTML =
              '<div style="color: #64748b; text-align: center; padding: 2rem;">æš‚æ— æ•°æ®</div>';
            return;
          }
          listEl.innerHTML = list
            .map((item, idx) => {
              const val = item[key];
              const displayVal = isProfit
                ? (val >= 0 ? "+" : "") + val.toFixed(2)
                : val.toFixed(2);
              const valColor =
                color === "dynamic"
                  ? val >= 0
                    ? "#ef4444" // Profit (Red)
                    : "#10b981" // Loss (Green)
                  : color;
              return `
                    <div class="ranking-item" onclick="showStationDetail('${item.Station.replace(/'/g, "\\'")}')">
                        <span class="rank-idx ${idx < 3 ? "top" : ""}">${idx + 1}</span>
                        <span class="rank-name" title="${item.Station}">${item.Station}</span>
                        <span class="rank-val" style="color: ${valColor}">${displayVal} <small style="font-weight: 400; font-size: 0.7rem">${unit}</small></span>
                    </div>
                `;
            })
            .join("");
        };

        if (data.profit_ranking) {
          renderRankList(
            "lossRankingList",
            data.profit_ranking.top_loss,
            "NetIncome",
            "dynamic",
            "ä¸‡",
          );
          renderRankList(
            "profitRankingList",
            data.profit_ranking.top_profit,
            "NetIncome",
            "dynamic",
            "ä¸‡",
          );
        } else {
           document.getElementById("lossRankingList").innerHTML = '<div style="color: #64748b; text-align: center; padding: 2rem;">æš‚æ— æŸç›Šæ•°æ®</div>';
           document.getElementById("profitRankingList").innerHTML = '<div style="color: #64748b; text-align: center; padding: 2rem;">æš‚æ— æŸç›Šæ•°æ®</div>';
        }

        if (data.exemption_effect) {
          renderRankList(
            "exemptionRankingList",
            data.exemption_effect,
            "ExemptionDiff",
            "dynamic",
            "MWh",
            true,
          );
        } else {
           document.getElementById("exemptionRankingList").innerHTML = '<div style="color: #64748b; text-align: center; padding: 2rem;">æš‚æ— å…è€ƒæ•°æ®</div>';
        }

        // Update Chart Titles with Period/Station Info
        const periodLabel = data.selected_period === 'all' ? 'å…¨éƒ¨å‘¨æœŸ' : data.selected_period;
        const stationLabel = data.selected_station === 'all' ? 'å…¨éƒ¨åœºç«™' : data.selected_station;
        const infoSpan = `<span style="margin-left: 1rem; color: #94a3b8; font-size: 0.9rem; font-weight: normal;">${periodLabel} Â· ${stationLabel}</span>`;

        const asmTotal = Object.values(data.assessment_composition || {}).reduce((a, b) => a + b, 0).toFixed(2);
        const compTotal = Object.values(data.comp_composition || {}).reduce((a, b) => a + b, 0).toFixed(2);
        const totalAsmBadge = `<span style="background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 2px 10px; border-radius: 6px; font-size: 0.9rem; margin-left: 10px; border: 1px solid rgba(239, 68, 68, 0.2); font-weight: 700;">æ€»è®¡: ${asmTotal} ä¸‡</span>`;
        const totalCompBadge = `<span style="background: rgba(16, 185, 129, 0.15); color: #10b981; padding: 2px 10px; border-radius: 6px; font-size: 0.9rem; margin-left: 10px; border: 1px solid rgba(16, 185, 129, 0.2); font-weight: 700;">æ€»è®¡: ${compTotal} ä¸‡</span>`;

        const exemptionTotal = (data.exemption_effect || []).reduce((a, b) => a + (b.ExemptionDiff || 0), 0).toFixed(2);
        const totalExemptionBadge = `<span style="background: rgba(16, 185, 129, 0.15); color: #10b981; padding: 2px 10px; border-radius: 6px; font-size: 0.9rem; margin-left: 10px; border: 1px solid rgba(16, 185, 129, 0.2); font-weight: 700;">å‡å…æ€»é‡: ${exemptionTotal} MWh</span>`;

        document.getElementById("profitChartTitle").innerHTML = "åœºç«™ç»è¥æŸç›Šåˆ†å¸ƒ (TOP 10)" + infoSpan;
        document.getElementById("compositionChartTitle").innerHTML = "è€ƒæ ¸åŠ¨å› é¡¹å æ¯”åˆ†æ" + totalAsmBadge + infoSpan;
        document.getElementById("compChartTitle").innerHTML = "è¾…åŠ©æœåŠ¡è¡¥å¿æ„æˆåˆ†æ" + totalCompBadge + infoSpan;
        document.getElementById("exemptionChartTitle").innerHTML = "å…è€ƒä¸ç”³è¯‰å¢ç›Šåˆ†æ" + totalExemptionBadge + infoSpan;

        // Charts
        requestAnimationFrame(() => {
          initProfitChart(data.profit_ranking);
          initCompositionChart(data.assessment_composition);
          initCompChart(data.comp_composition);
          initExemptionChart(data.exemption_effect);


          // Force resize trigger
          window.dispatchEvent(new Event("resize"));
        });
      }

      function initProfitChart(rankingData) {
        const dom = document.getElementById("profitChart");
        let chart = echarts.getInstanceByDom(dom);

        if (!rankingData || !rankingData.full || rankingData.full.length === 0) {
          if (chart) {
            chart.dispose();
            chart = null;
          }
          dom.innerHTML = '<div style="display: flex; height: 100%; align-items: center; justify-content: center; color: #64748b;">è¯¥çŠ¶æ€ä¸‹æš‚æ— æŸç›Šæ•°æ®</div>';
          dom.removeAttribute('_echarts_instance_');
          return;
        }
        
        if (!chart) {
          dom.innerHTML = "";
          chart = echarts.init(dom);
        }

        const displayData = rankingData.full;

        const option = {
          backgroundColor: "transparent",
          tooltip: { trigger: "axis", axisPointer: { type: "shadow" } },
          grid: {
            left: "3%",
            right: "15%",
            bottom: "15%",
            top: "10%",
            containLabel: true,
          },
          xAxis: {
            type: "value",
            axisLabel: { color: "#94a3b8" },
            splitLine: { lineStyle: { color: "rgba(255,255,255,0.05)" } },
          },
          yAxis: {
            type: "category",
            data: displayData.map((d) => d.Station),
            axisLabel: { color: "#cbd5e1", fontSize: 11, interval: 0 },
            inverse: true,
          },
          series: [
            {
              name: "æŸç›Šå‡€æ”¶å…¥",
              type: "bar",
              // Use aggregated data, but keep colors based on +/-
              data: displayData.map((d) => ({
                value: d.NetIncome.toFixed(2),
                itemStyle: {
                  color: d.NetIncome >= 0 ? "#ef4444" : "#10b981",
                  // Add hover effect
                  shadowBlur: 10,
                  shadowColor: "rgba(0,0,0,0.3)",
                },
              })),
              label: {
                show: true,
                position: "right",
                color: "#fff",
                fontSize: 10,
                formatter: "{c}",
              },
              barMaxWidth: 30,
            },
          ],
          // Use dataZoom to handle many stations gracefully
          // Use dataZoom to handle many stations gracefully

        };
        chart.setOption(option);

        // Click for drill-down
        chart.off("click"); // Remove old listeners
        chart.on("click", function (params) {
          const stationName = params.name;
          showStationDetail(stationName);
        });
      }

      function initCompositionChart(compData) {
        const dom = document.getElementById("compositionChart");
        let chart = echarts.getInstanceByDom(dom);
        
        if (!compData || Object.keys(compData).length === 0) {
          if (chart) {
            chart.dispose();
            chart = null;
          }
          dom.innerHTML = '<div style="display: flex; height: 100%; align-items: center; justify-content: center; color: #64748b;">è¯¥çŠ¶æ€ä¸‹æš‚æ— è€ƒæ ¸æ•°æ®</div>';
          dom.removeAttribute('_echarts_instance_');
          return;
        }
        
        if (!chart) {
          dom.innerHTML = "";
          chart = echarts.init(dom);
        }
        const data = Object.entries(compData)
          .sort((a, b) => b[1] - a[1])
          .map(([name, value]) => ({ name, value: Number(value.toFixed(2)) }));

        const option = {
          backgroundColor: "transparent",
          tooltip: { trigger: "item", formatter: "{b}: {c} ({d}%)" },
          legend: {
            orient: "vertical",
            right: "5%",
            top: "middle",
            itemGap: 10,
            type: "scroll",
            pageTextStyle: { color: "#fff" },
            textStyle: { 
                color: "#cbd5e1", 
                fontSize: 12,
                rich: {
                    name: {
                        color: "#94a3b8",
                        width: 100,
                        align: 'left',
                        padding: [0, 10, 0, 0]
                    },
                    val: {
                        color: "#fff",
                        width: 80,
                        align: 'right',
                        fontWeight: 'bold'
                    }
                }
            },
            formatter: function(name) {
                const item = data.find(d => d.name === name);
                return item ? `{name|${name}}{val|${item.value}}` : name;
            }
          },

          series: [
            {
              type: "pie",
              radius: ["50%", "75%"],
              center: ["25%", "50%"],
              avoidLabelOverlap: true,
              itemStyle: {
                borderRadius: 10,
                borderColor: "#1e293b",
                borderWidth: 2,
              },
              label: { show: false },
              data: data,
              color: [
                "#f97316", 
                "#10b981", 
                "#3b82f6", 
                "#f59e0b", 
                "#6366f1", 
                "#ef4444", 
                "#ec4899", 
              ],
            },
          ],
        };
        chart.setOption(option);

        // Detailed Drill down by Group
        // Detailed Drill down by Group
        chart.on("click", function (params) {
          if (params.componentType === 'series') {
              const groupName = params.name;
              showAssessmentDetail(groupName);
          }
        });
      }

      function initAppealChart(appealData) {
        if (!appealData) return;
        const chart = echarts.init(document.getElementById("appealChart"));

        const option = {
          backgroundColor: "transparent",
          tooltip: { trigger: "axis" },
          legend: {
            data: ["å…è€ƒå‰", "å…è€ƒå"],
            textStyle: { color: "#94a3b8" },
          },
          grid: { left: 60, right: 40, top: 60, bottom: 60 },
          xAxis: {
            type: "category",
            data: appealData.map((d) => d.Station),
            axisLabel: {
              color: "#94a3b8",
              fontSize: 10,
              rotate: 30,
              interval: 0,
            },
          },
          yAxis: { type: "value", axisLabel: { color: "#94a3b8" } },
          series: [
            {
              name: "å…è€ƒå‰",
              type: "bar",
              data: appealData.map((d) => d["å…è€ƒå‰"].toFixed(2)),
              itemStyle: { color: "rgba(255,255,255,0.1)" },
            },
            {
              name: "å…è€ƒå",
              type: "bar",
              data: appealData.map((d) => d["å…è€ƒå"].toFixed(2)),
              itemStyle: { color: "#10b981" },
            },
          ],
        };
        chart.setOption(option);
      }

      function initExemptionChart(data) {
        const dom = document.getElementById("exemptionChart");
        let chart = echarts.getInstanceByDom(dom);

        if (!data || data.length === 0) {
          if (chart) {
             chart.dispose();
             chart = null;
          }
          dom.innerHTML = '<div style="display: flex; height: 100%; align-items: center; justify-content: center; color: #64748b;">è¯¥çŠ¶æ€ä¸‹æš‚æ— å…è€ƒæ•°æ®</div>';
          dom.removeAttribute('_echarts_instance_');
          return;
        }

        // Set dynamic height based on data length
        const chartHeight = Math.max(300, data.length * 30);
        dom.style.height = chartHeight + "px";

        if (!chart) {
           dom.innerHTML = "";
           chart = echarts.init(dom);
        } else {
           chart.resize();
        }

        const option = {
          backgroundColor: "transparent",
          tooltip: { trigger: "axis" },
          grid: {
            left: "3%",
            right: "10%",
            bottom: "3%",
            top: "5%",
            containLabel: true,
          },
          xAxis: {
            type: "value",
            axisLabel: { color: "#94a3b8" },
            splitLine: { show: false },
          },
          yAxis: {
            type: "category",
            data: data.map((d) => d.Station),
            axisLabel: { color: "#cbd5e1", fontSize: 10 },
            inverse: true,
          },
          series: [
            {
              type: "bar",
              data: data.map((d) => d.ExemptionDiff.toFixed(2)),
              itemStyle: { color: "#10b981", borderRadius: [0, 4, 4, 0] },
              label: { show: true, position: "right", color: "#fff" },
            },
          ],
        };
        chart.setOption(option);
      }

      function initCompChart(compData) {
        const dom = document.getElementById("compChart");
        let chart = echarts.getInstanceByDom(dom);

        if (!compData || Object.keys(compData).length === 0) {
          if (chart) {
             chart.dispose();
             chart = null;
          }
          dom.innerHTML = '<div style="display: flex; height: 100%; align-items: center; justify-content: center; color: #64748b;">è¯¥çŠ¶æ€ä¸‹æš‚æ— è¡¥å¿æ•°æ®</div>';
          dom.removeAttribute('_echarts_instance_');
          return;
        }

        if (!chart) {
           dom.innerHTML = "";
           chart = echarts.init(dom);
        }
        const data = Object.entries(compData)
          .map(([name, value]) => ({ name, value: Number(value.toFixed(2)) }))
          .sort((a, b) => b.value - a.value);

        const option = {
          backgroundColor: "transparent",
          tooltip: { trigger: "item", formatter: "{b}: {c} ({d}%)" },
          legend: {
            orient: "vertical",
            right: "5%",
            top: "middle",
            itemGap: 10,
            type: "scroll",
            pageTextStyle: { color: "#fff" },
            textStyle: { 
                color: "#cbd5e1", 
                fontSize: 12,
                rich: {
                    name: {
                        color: "#94a3b8",
                        width: 100,
                        align: 'left',
                        padding: [0, 10, 0, 0]
                    },
                    val: {
                        color: "#fff",
                        width: 80,
                        align: 'right',
                        fontWeight: 'bold'
                    }
                }
            },
            formatter: function(name) {
                const item = data.find(d => d.name === name);
                return item ? `{name|${name}}{val|${item.value}}` : name;
            }
          },

          series: [
            {
              type: "pie",
              radius: ["50%", "75%"],
              center: ["25%", "50%"],
              avoidLabelOverlap: true,
              itemStyle: {
                borderRadius: 10,
                borderColor: "#1e293b",
                borderWidth: 2,
              },
              label: { show: false },
              data: data,
              color: ["#f97316", "#10b981", "#f59e0b", "#3b82f6", "#ef4444"], 
            },
          ],
        };
        chart.setOption(option);

        // Detailed Drill down by Compensation Item
        chart.on("click", function (params) {
          const compName = params.name;
          showCompensationDetail(compName);
        });
      }



      window.addEventListener("resize", () => {
        echarts
          .getInstanceByDom(document.getElementById("profitChart"))
          ?.resize();
        echarts
          .getInstanceByDom(document.getElementById("compositionChart"))
          ?.resize();
        echarts
          .getInstanceByDom(document.getElementById("compChart"))
          ?.resize(); // New
        echarts
          .getInstanceByDom(document.getElementById("appealChart"))
          ?.resize();
        echarts
          .getInstanceByDom(document.getElementById("trendChart")) // New
          ?.resize();
      });

      // History Functions
      async function fetchHistory() {
        try {
          const res = await fetch("/two_rules/history");
          const history = await res.json();
          renderHistory(history);
          initTrendFilters(history); // Populate trend filters
        } catch (err) {
          console.error("Failed to fetch history");
        }
      }

      function renderHistory(history) {
        const list = document.getElementById("historyList");
        document.getElementById("historyCount").innerText =
          `å…± ${history.length} æ¡è®°å½•`;

        if (history.length === 0) {
          list.innerHTML =
            '<p style="color: #94a3b8; text-align: center; padding: 1rem;">æš‚æ— å†å²è®°å½•</p>';
          return;
        }

        list.innerHTML = history
          .map(
            (item) => `
            <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 0.8rem 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #fff; margin-bottom: 0.2rem; font-size: 0.95rem;">${item.filename}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; gap: 0.8rem;">
                        <span>ğŸ“… ${item.timestamp}</span>
                        <a href="/download/${item.report_filename}" style="color: #10b981; text-decoration: none;">ğŸ“¥ ä¸‹è½½æŠ¥å‘Š</a>
                    </div>
                </div>
                <div style="display: flex; gap: 0.6rem;">
                    <button class="btn btn-secondary" onclick='loadRecord(${JSON.stringify(item).replace(/'/g, "&apos;")})' style="padding: 0.35rem 0.8rem; font-size: 0.75rem;">ğŸ“Š æŸ¥çœ‹çœ‹æ¿</button>
                    <button class="btn" onclick="deleteHistory('${item.file_id}')" style="padding: 0.35rem 0.8rem; font-size: 0.75rem; background: rgba(255,77,77,0.1); color: #ff4d4d; border-color: rgba(255,77,77,0.2)">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            </div>
        `,
          )
          .join("");
      }

      // Trend Functions
      function initTrendFilters(history) {
        if (!history || history.length === 0) return;
        
        const periods = new Set();
        const stations = new Set();
        const years = new Set();
        const categories = new Set();
        
        history.forEach(item => {
            if (item.data && item.data.selected_period && item.data.selected_period !== 'all') {
                periods.add(item.data.selected_period);
                years.add(item.data.selected_period.split('-')[0]);
            }
            if (item.data && item.data.available_stations) {
                item.data.available_stations.forEach(s => stations.add(s));
            }
            if (item.data && item.data.assessment_composition) {
                Object.keys(item.data.assessment_composition).forEach(cat => categories.add(cat));
            }
            if (item.data && item.data.comp_composition) {
                Object.keys(item.data.comp_composition).forEach(cat => categories.add(cat));
            }
        });
        
        const sortedPeriods = Array.from(periods).sort();
        const sortedStations = Array.from(stations).sort();
        const sortedYears = Array.from(years).sort().reverse();
        const sortedCategories = Array.from(categories).sort();
        
        const startSelect = document.getElementById('trendStartPeriod');
        const endSelect = document.getElementById('trendEndPeriod');
        const yearSelect = document.getElementById('trendYear');
        const stationSelect = document.getElementById('trendStation');
        const indicatorSelect = document.getElementById('trendIndicator');
        
        if (sortedPeriods.length > 0) {
            document.getElementById('trendCard').style.display = 'block';
            
            const periodOptions = sortedPeriods.map(p => `<option value="${p}">${p}</option>`).join('');
            startSelect.innerHTML = `<option value="all">æœ€æ—©</option>` + periodOptions;
            endSelect.innerHTML = `<option value="all">æœ€æ™š</option>` + periodOptions;
            
            yearSelect.innerHTML = `<option value="all">å…¨éƒ¨å¹´ä»½</option>` + sortedYears.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
            stationSelect.innerHTML = `<option value="all">å…¨éƒ¨åœºç«™å¯¹æ¯”</option>` + sortedStations.map(s => `<option value="${s}">${s}</option>`).join('');
            
            indicatorSelect.innerHTML = `<option value="overview">æ€»ä½“æŸç›Šæ¦‚è§ˆ (ç›ˆäº/è€ƒæ ¸/è¡¥å¿)</option>` + 
                sortedCategories.map(cat => `<option value="${cat}">æ˜ç»†æŒ‡æ ‡: ${cat}</option>`).join('');

            updateTrends();
        }
      }

      async function updateTrends() {
        const start = document.getElementById('trendStartPeriod').value;
        const end = document.getElementById('trendEndPeriod').value;
        const year = document.getElementById('trendYear').value;
        const station = document.getElementById('trendStation').value;
        const indicator = document.getElementById('trendIndicator').value;
        
        const params = new URLSearchParams({
            start_period: start,
            end_period: end,
            year: year,
            station: station,
            indicator: indicator
        });
        
        try {
            const res = await fetch(`/two_rules/trends?${params.toString()}`);
            const data = await res.json();
            if (data.success) {
                renderTrendChart(data.trends);
            }
        } catch (err) {
            console.error("Failed to fetch trends", err);
        }
      }

      function renderTrendChart(trends) {
        const dom = document.getElementById("trendChart");
        if (!dom) return;
        let chart = echarts.getInstanceByDom(dom);
        if (!chart) chart = echarts.init(dom);
        
        const isOverview = trends.indicator === 'overview';
        
        let series = [];
        let legendData = [];
        
        if (isOverview) {
            legendData = ['ç»è¥å‡€æŸç›Š', 'è€ƒæ ¸æ€»è´¹ç”¨', 'è¡¥å¿æ€»æ”¶ç›Š'];
            series = [
                {
                    name: 'ç»è¥å‡€æŸç›Š',
                    type: 'bar',
                    barWidth: '30%',
                    data: trends.profit,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#3b82f6' },
                            { offset: 1, color: '#1d4ed8' }
                        ]),
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: { show: true, position: 'top', color: '#94a3b8', fontSize: 10 }
                },
                {
                    name: 'è€ƒæ ¸æ€»è´¹ç”¨',
                    type: 'line',
                    data: trends.assessment,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    itemStyle: { color: '#ef4444' },
                    lineStyle: { width: 3, shadowBlur: 10, shadowColor: 'rgba(239, 68, 68, 0.3)' }
                },
                {
                    name: 'è¡¥å¿æ€»æ”¶ç›Š',
                    type: 'line',
                    data: trends.compensation,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    itemStyle: { color: '#10b981' },
                    lineStyle: { width: 3, shadowBlur: 10, shadowColor: 'rgba(16, 185, 129, 0.3)' }
                }
            ];
        } else {
            legendData = [trends.indicator];
            series = [
                {
                    name: trends.indicator,
                    type: 'line',
                    data: trends.values,
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 8,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                            { offset: 1, color: 'rgba(59, 130, 246, 0)' }
                        ])
                    },
                    itemStyle: { color: '#3b82f6' },
                    lineStyle: { width: 3 }
                }
            ];
        }
        
        const option = {
            backgroundColor: "transparent",
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                borderColor: '#334155',
                textStyle: { color: '#fff' }
            },
            legend: {
                data: legendData,
                textStyle: { color: '#94a3b8', fontSize: 12 },
                bottom: 0,
                icon: 'circle'
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '12%',
                top: '10%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: trends.periods,
                axisLabel: { color: '#94a3b8', fontSize: 11 },
                axisLine: { lineStyle: { color: '#334155' } }
            },
            yAxis: {
                type: 'value',
                name: 'é‡‘é¢ (ä¸‡å…ƒ)',
                nameTextStyle: { color: '#94a3b8', padding: [0, 0, 0, 40] },
                axisLabel: { color: '#94a3b8' },
                splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)', type: 'dashed' } },
                axisLine: { show: false }
            },
            series: series
        };
        
        chart.setOption(option);
      }

      let currentAssessmentGroup = null;
      let currentAssessmentView = 'cost'; // 'cost' or 'mwh'

      function showAssessmentDetail(groupName) {
         currentAssessmentGroup = groupName;
         currentAssessmentView = 'cost'; // Default to cost
         renderAssessmentDetail();
      }

      function switchAssessmentView(view) {
          currentAssessmentView = view;
          renderAssessmentDetail();
      }

      function renderAssessmentDetail() {
        const groupName = currentAssessmentGroup;
        if (
          !groupName ||
          !globalData ||
          !globalData.details
        )
          return;

        // correct data source
        let rawData;
        let valueUnit;
        let colorPalette;
        let axisColor;

        if (currentAssessmentView === 'mwh') {
            rawData = globalData.details.assessment_mwh || [];
            valueUnit = "MWh";
            // Green/Teal palette for MWh
            colorPalette = ["#10b981", "#34d399", "#6ee7b7", "#059669", "#047857"];
            axisColor = "#10b981";
        } else {
            rawData = globalData.details.assessment_raw || globalData.details.assessment_cost || [];
            valueUnit = "ä¸‡å…ƒ";
            // Orange/Red palette for Cost
            colorPalette = ["#f97316", "#fbbf24", "#3b82f6", "#ef4444", "#f59e0b", "#8b5cf6"];
            axisColor = "#f97316";
        }
        
        if (!rawData || rawData.length === 0) {
            alert("è¯¥è§†å›¾æš‚æ— æ•°æ®");
            return;
        }

        // 1. Filter Items for this Group
        // Note: We use itemGroupMap from Cost analysis. 
        // We assume MWh items have same keys or similar enough to be mapped?
        // If keys differ, we might need a separate map. 
        // For now, assume keys are shared (normalized item names).
        const itemGroupMap = globalData.item_group_map || (globalData.details && globalData.details.item_group_map) || {};
        
        // Find items that belong to this group
        // If specific keys for MWh exist, this might miss them if they are not in the map.
        // Fallback: If MWh view and no items found via map, maybe try to match fuzzy?
        // Let's stick to map for now.
        let targetItems = Object.entries(itemGroupMap)
          .filter(
            ([item, group]) => group === groupName || groupName === "å…¨éƒ¨",
          )
          .map(([item]) => item);

        // Avoid double counting: If both "Total/Sum" items and sub-items exist, prioritize sub-items
        if (groupName !== "å…¨éƒ¨" && groupName !== "æ•°æ®è´¨é‡") {
            const isTotal = (item) => /æ€»è€ƒæ ¸|æ€»è®¡|åˆè®¡|å°è®¡/.test(item) || item.trim() === groupName;
            const totals = targetItems.filter(item => isTotal(item));
            const subs = targetItems.filter(item => !isTotal(item));
            if (subs.length > 0 && totals.length > 0) {
                targetItems = subs; 
            }
        }

        if (targetItems.length === 0 && groupName !== "å…¨éƒ¨") {
          // If no items found in map, maybe this group doesn't have cost items?
          // Or maybe I should check the data columns directly?
          // For safety, proceed.
        }

        // 2. Aggregate value per Item for the top pie chart
        let itemTotals = {};
        targetItems.forEach((item) => (itemTotals[item] = 0));

        // Aggregate
        rawData.forEach((row) => {
          targetItems.forEach((item) => {
            // value check
            const val = parseFloat(row[item]) || 0;
            // For MWh, values might be positive or negative depending on context.
            // Usually we sum them.
            itemTotals[item] += val;
          });
        });

        const topItems = Object.entries(itemTotals)
          .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1])) // Sort by magnitude
          .filter((x) => x[1] !== 0); // Remove zeros

        // 3. Aggregate value per Station for the table
        let stationTotals = {};
        rawData.forEach((row) => {
          let sum = 0;
          targetItems.forEach((item) => (sum += parseFloat(row[item]) || 0));
          if (sum !== 0) {
            stationTotals[row.Station] = (stationTotals[row.Station] || 0) + sum;
          }
        });

        const topStations = Object.entries(stationTotals).sort(
          (a, b) => b[1] - a[1], // Sort descending? Or magnitude? Assumed positive cost/quantity usually.
        );

        // Calculate Grand Total
        const grandTotal = topStations.reduce((sum, item) => sum + item[1], 0);

        // Period/Station Info for Title
        const periodSelect = document.getElementById("periodSelect");
        const stationSelect = document.getElementById("stationSelect");
        const periodText = periodSelect.options[periodSelect.selectedIndex]?.text || "å…¨éƒ¨å‘¨æœŸ";
        const stationText = stationSelect.options[stationSelect.selectedIndex]?.text || "å…¨éƒ¨åœºç«™";

        // Render Markup
        // We inject the toggle into the title or body. 
        // Let's use openModal logic but append toggle.
        openModal(`${groupName} - è¯¦ç»†è€ƒæ ¸åˆ†æ <span style="font-size: 0.8rem; font-weight: normal; color: #94a3b8; margin-left: 1rem;">${periodText} Â· ${stationText}</span>`);

        // Calculate height for station chart
        const stationChartHeight = Math.max(300, topStations.length * 30);
        
        // Prepare Pie Data
        const pieData = topItems.map(x => ({ name: x[0], value: parseFloat(x[1].toFixed(2)) }));
        
        // Toggle Buttons HTML
        const toggleHtml = `
            <div style="position: absolute; right: 50px; top: 20px; z-index: 10;">
                <div class="toggle-group ${currentAssessmentView === 'mwh' ? 'theme-mwh' : ''}" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="switchAssessmentView('cost')" class="toggle-item ${currentAssessmentView === 'cost' ? 'active' : ''}" style="font-size: 0.8rem; padding: 4px 12px;">è€ƒæ ¸è´¹ç”¨ (ä¸‡å…ƒ)</button>
                    <button onclick="switchAssessmentView('mwh')" class="toggle-item ${currentAssessmentView === 'mwh' ? 'active' : ''}" style="font-size: 0.8rem; padding: 4px 12px;">è€ƒæ ¸ç”µé‡ (MWh)</button>
                </div>
            </div>
        `;

        const content = document.getElementById("modalTableWrap");
        content.innerHTML = `
            ${toggleHtml}
            <div style="display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap; margin-top: 1rem;">
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: var(--text-sub); margin-bottom: 1rem;">ç»†åˆ†é¡¹å æ¯” (${valueUnit})</h4>
                    <div id="detailItemChart" style="height: 300px; width: 100%;"></div>
                </div>
                <div style="flex: 1; min-width: 300px;">
                     <h4 style="color: var(--text-sub); margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <span>æ¶‰åŠåœºç«™æ’å (å…¨éƒ¨)</span>
                        <span style="font-size: 0.9em; color: ${axisColor}; margin-right: 15px;">æ€»è®¡: ${grandTotal.toFixed(2)}</span>
                     </h4>
                     <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                        <div id="detailStationChart" style="height: ${stationChartHeight}px; width: 100%;"></div>
                     </div>
                </div>
            </div>
            <h4 style="color: var(--text-sub); margin-bottom: 1rem;">è€ƒæ ¸æ˜ç»†è¡¨</h4>
            <div>
                <table class="data-table">
                    <thead><tr><th>æ’å</th><th>åœºç«™åç§°</th><th>æ€»è®¡ (${valueUnit})</th><th>æŸ¥çœ‹</th></tr></thead>
                    <tbody>
                        ${topStations
                          .map(
                            (s, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${s[0]}</td>
                                <td style="color: ${axisColor}; font-weight:600;">${s[1].toFixed(2)}</td>
                                <td style="color: #94a3b8; font-size: 0.85rem;">æŸ¥çœ‹åŸå§‹å•æ®</td>
                            </tr>
                        `,
                          )
                          .join("")}
                        <tr style="background: rgba(255,255,255,0.05); font-weight: bold;">
                            <td>-</td>
                            <td style="text-align: right; padding-right: 2rem;">æ€»è®¡</td>
                            <td style="color: ${axisColor}; font-weight:700;">${grandTotal.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

        // Render Item Chart (Pie)
        setTimeout(() => {
          const chart1 = echarts.init(
            document.getElementById("detailItemChart"),
          );
          chart1.setOption({
            tooltip: { trigger: "item", formatter: "{b}: {c} ({d}%)" },
            legend: { 
                type: 'scroll',
                orient: 'horizontal',
                bottom: 0,
                left: 'center',
                textStyle: { color: "#cbd5e1" } 
            },
            series: [
              {
                type: "pie",
                radius: ["40%", "70%"],
                center: ["50%", "45%"], // Adjusted center
                avoidLabelOverlap: true,
                itemStyle: {
                  borderRadius: 10,
                  borderColor: "#1e293b",
                  borderWidth: 2,
                },
                label: { 
                    show: true, 
                    formatter: '{b}\n{c}', 
                    color: '#cbd5e1' 
                },
                labelLine: { 
                    show: true, 
                    lineStyle: { color: '#64748b' } 
                },
                data: pieData,
                color: colorPalette,
              },
            ],
            graphic: [{
                type: 'text',
                left: 'center',
                top: '42%',
                style: {
                    text: grandTotal.toFixed(0),
                    textAlign: 'center',
                    fill: '#fff',
                    fontSize: 24,
                    fontWeight: 'bold'
                }
            }, {
                type: 'text',
                left: 'center',
                top: '52%',
                style: {
                    text: 'æ€»è®¡',
                    textAlign: 'center',
                    fill: '#94a3b8',
                    fontSize: 12
                }
            }]
          });

          // Render Station Chart (All Stations)
          const chart2 = echarts.init(
            document.getElementById("detailStationChart"),
          );
          chart2.setOption({
            tooltip: { trigger: "axis" },
            grid: {
              left: "3%",
              right: "4%",
              bottom: "3%",
              top: "5%",
              containLabel: true,
            },
            xAxis: { 
                type: "value", 
                axisLabel: { color: "#94a3b8" },
                position: 'top',
                splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
            },
            yAxis: {
              type: "category",
              data: topStations.map((x) => x[0]),
              axisLabel: { color: "#cbd5e1" },
              inverse: true,
            },
            series: [
              {
                type: "bar",
                data: topStations.map((x) => x[1].toFixed(2)),
                itemStyle: { color: axisColor },
                label: { show: true, position: 'right', color: '#fff', fontSize: 10 }
              },
            ],
          });
        }, 100);
      }

      function showCompensationDetail(compName) {
        if (
          !globalData ||
          !globalData.details ||
          !globalData.details.compensation_raw
        )
          return;

        const raw = globalData.details.compensation_raw;
        
        let stationTotals = {};
        raw.forEach((row) => {
            const val = parseFloat(row[compName]) || 0;
            if (val !== 0) {
                stationTotals[row.Station] = (stationTotals[row.Station] || 0) + val;
            }
        });

        const topStations = Object.entries(stationTotals).sort(
          (a, b) => b[1] - a[1],
        );
        
        if (topStations.length === 0) return;

        openModal(`${compName} - è¯¦ç»†è¡¥å¿åˆ†æ`);

        const content = document.getElementById("modalTableWrap");
        content.innerHTML = `
            <div style="display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 600px;">
                     <h4 style="color: var(--text-sub); margin-bottom: 1rem;">æ¶‰åŠåœºç«™æ’å (TOP 10)</h4>
                     <div id="detailStationChart" style="height: 350px; width: 100%;"></div>
                </div>
            </div>
            <h4 style="color: var(--text-sub); margin-bottom: 1rem;">åœºç«™è¡¥å¿æ˜ç»†è¡¨</h4>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="data-table">
                    <thead><tr><th>æ’å</th><th>åœºç«™åç§°</th><th>è¡¥å¿æ€»é¢</th><th>åŸå§‹æ•°æ®</th></tr></thead>
                    <tbody>
                        ${topStations
                          .map(
                            (s, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${s[0]}</td>
                                <td style="color: #10b981;">${s[1].toFixed(2)}</td>
                                <td style="color: #94a3b8; font-size: 0.85rem;">æŸ¥çœ‹</td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            </div>
        `;

          setTimeout(() => {
          const chart2 = echarts.init(
            document.getElementById("detailStationChart"),
          );
          chart2.setOption({
            tooltip: { trigger: "axis" },
            grid: {
              left: "3%",
              right: "5%",
              bottom: "3%",
              containLabel: true,
            },
            xAxis: { type: "value", axisLabel: { color: "#94a3b8" } },
            yAxis: {
              type: "category",
              data: topStations.slice(0, 15).map((x) => x[0]),
              axisLabel: { color: "#cbd5e1" },
              inverse: true,
            },
            series: [
              {
                type: "bar",
                data: topStations.slice(0, 15).map((x) => x[1].toFixed(2)),
                itemStyle: { color: "#10b981" },
                label: { show: true, position: 'right', color: '#fff' }
              },
            ],
          });
        }, 100);
      }

      function loadRecord(item) {
        currentFilename = item.filename; // Sync filename for period selection
        const data = item.data;
        resultsArea.style.display = "block";
        document.getElementById("chartsGrid").style.display = "grid";
        setTimeout(() => {
          renderDashboard(data);
          if (item.report_filename) {
              document.getElementById("downloadReport").href = "/download/" + item.report_filename;
          }
          
          setTimeout(() => {
            window.dispatchEvent(new Event("resize"));
            resultsArea.scrollIntoView({ behavior: "smooth" });
          }, 100);
          setTimeout(() => {
            window.dispatchEvent(new Event("resize"));
          }, 500);
        }, 50);
      }

      async function deleteHistory(fileId) {
        const password = prompt("è¯·è¾“å…¥åˆ é™¤å¯†ç :");
        if (password === null) return;

        try {
          const res = await fetch(
            `/two_rules/history/${fileId}?password=${encodeURIComponent(password)}`,
            { method: "DELETE" },
          );
          const data = await res.json();
          if (data.success) {
            fetchHistory();
          } else {
            alert(data.error || "åˆ é™¤å¤±è´¥");
          }
        } catch (err) {
          alert("ç½‘ç»œé”™è¯¯");
        }
      }

      async function handleRefilter() {
        if (!currentFilename) return;

        uploadStatus.style.display = "block";
        try {
          const res = await fetch("/reanalyze_two_rules", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename: currentFilename,
              period: periodSelect.value,
              station: stationSelect.value,
            }),
          });
          const json = await res.json();
          if (json.success) {
            renderDashboard(json.data);
            document.getElementById("downloadReport").href = json.report_url;
            
            setTimeout(() => {
              window.dispatchEvent(new Event("resize"));
            }, 100);
            setTimeout(() => {
              window.dispatchEvent(new Event("resize"));
            }, 500);
          } else {
            alert("é‡æ–°ç»Ÿè®¡å¤±è´¥: " + json.error);
          }
        } catch (err) {
          alert("ç½‘ç»œé”™è¯¯");
        } finally {
          uploadStatus.style.display = "none";
        }
      }

      periodSelect.addEventListener("change", handleRefilter);
      stationSelect.addEventListener("change", handleRefilter);

      // --- Drill-down Handlers ---

      const modal = document.getElementById("detailModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalChartDiv = document.getElementById("modalChart");
      const modalTableWrap = document.getElementById("modalTableWrap");
      let modalChart = null;

      function openModal(title) {
        modalTitle.innerHTML = title;
        modal.style.display = "flex";
        // Clear previous content
        if (modalChart) {
          modalChart.dispose();
          modalChart = null;
        }
        modalTableWrap.innerHTML = "";
      }

      function closeModal() {
        modal.style.display = "none";
      }

      // Close on outside click
      window.onclick = function (event) {
        if (event.target == modal) closeModal();
      };

      let currentDetailStation = null;
      let currentDetailView = 'cost'; // 'cost' or 'mwh'

      // 1. Show Station Detail (Assessment vs Compensation breakdown)
      function showStationDetail(stationName) {
        if (!globalData || !globalData.details) return;
        currentDetailStation = stationName;
        currentDetailView = 'cost'; // Reset to default
        
        openModal(stationName + " - è¯¦ç»†è€ƒæ ¸åˆ†æ");
        renderStationDetailModal();
      }

      let currentDetailChart = null;

      function highlightStationDetail(name) {
          if (currentDetailChart) {
              currentDetailChart.dispatchAction({
                  type: 'highlight',
                  seriesIndex: 0,
                  name: name
              });
              currentDetailChart.dispatchAction({
                  type: 'showTip',
                  seriesIndex: 0,
                  name: name
              });
          }
      }

      function unhighlightStationDetail() {
          if (currentDetailChart) {
              currentDetailChart.dispatchAction({
                  type: 'downplay',
                  seriesIndex: 0
              });
              currentDetailChart.dispatchAction({
                  type: 'hideTip'
              });
          }
      }

      function renderStationDetailModal() {
        if (!currentDetailStation) return;
        
        // Data sources
        const asmCostRaw = globalData.details.assessment_cost || globalData.details.assessment_raw || [];
        const asmMwhRaw = globalData.details.assessment_mwh || [];
        const compRaw = globalData.details.compensation_raw || []; 
        
        const stationCost = asmCostRaw.find((r) => r.Station === currentDetailStation);
        const stationMwh = asmMwhRaw.find((r) => r.Station === currentDetailStation);
        const stationComp = compRaw.find((r) => r.Station === currentDetailStation);

        const pSel = document.getElementById("periodSelect");
        const periodText = pSel.options[pSel.selectedIndex]?.text || "å…¨éƒ¨å‘¨æœŸ";
        openModal(`${currentDetailStation} - è€ƒæ ¸ä¸è¡¥å¿æ˜ç»† <span style="font-size: 0.8rem; font-weight: normal; color: #94a3b8; margin-left: 1rem;">${periodText}</span>`);

        // Inject Toggle Buttons
        const toggleHtml = `
            <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                <div class="toggle-group ${currentDetailView === 'mwh' ? 'theme-mwh' : ''}">
                    <button onclick="switchDetailView('cost')" class="toggle-item ${currentDetailView === 'cost' ? 'active' : ''}">è€ƒæ ¸è´¹ç”¨ (ä¸‡å…ƒ)</button>
                    <button onclick="switchDetailView('mwh')" class="toggle-item ${currentDetailView === 'mwh' ? 'active' : ''}">è€ƒæ ¸ç”µé‡ (MWh)</button>
                </div>
            </div>
        `;
        
        // Determine active dataset
        const activeData = currentDetailView === 'cost' ? stationCost : stationMwh;
        const unit = currentDetailView === 'cost' ? 'ä¸‡å…ƒ' : 'MWh';
        const color = currentDetailView === 'cost' ? '#ef4444' : '#f59e0b'; 
        
        // Build items
        let asmItems = [];
        const excludeKeys = ["Station", "Date", "è£…æœºå®¹é‡(MW)", "å¹¶ç½‘æ—¶é—´(h)", "ç†è®ºå‘ç”µé‡(MWh)", "å®é™…å‘ç”µé‡(MWh)"];
        
        if (activeData) {
          Object.keys(activeData).forEach((k) => {
            if (
              !excludeKeys.includes(k) &&
              !k.startsWith("abs_") &&
              typeof activeData[k] === "number" &&
              activeData[k] !== 0
            ) {
              asmItems.push({ name: k, value: activeData[k] });
            }
          });
        }
        
        // Avoid double counting in station detail pie chart
        const isTotal = (name) => /æ€»è€ƒæ ¸|æ€»è®¡|åˆè®¡|å°è®¡/.test(name) || (currentDetailView === 'cost' ? false : name.trim() === 'æŠ€æœ¯æŒ‡å¯¼ä¸ç®¡ç†'); 
        // Note: For station detail, checking exact group name match is tricky because we don't know the group context per item easily without lookups.
        // However, "æŠ€æœ¯æŒ‡å¯¼ä¸ç®¡ç†" is a known Total column in MWh view.
        // Let's use a more generic check: if the item name is one of the known Group Keys.
        // But we don't have the group keys here easily. 
        // Heuristic: If item name ends with "æ€»è€ƒæ ¸ç”µé‡" or similar.
        // Or if it is exactly "æŠ€æœ¯æŒ‡å¯¼ä¸ç®¡ç†" (which user says is a total).
        
        const totalItems = asmItems.filter(i => /æ€»è€ƒæ ¸|æ€»è®¡|åˆè®¡|å°è®¡/.test(i.name) || i.name === 'æŠ€æœ¯æŒ‡å¯¼ä¸ç®¡ç†');
        const subItems = asmItems.filter(i => !(/æ€»è€ƒæ ¸|æ€»è®¡|åˆè®¡|å°è®¡/.test(i.name) || i.name === 'æŠ€æœ¯æŒ‡å¯¼ä¸ç®¡ç†'));
        
        if (subItems.length > 0 && totalItems.length > 0) {
            asmItems = subItems;
        }

        asmItems.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));

        // Assign Colors
        const palette = [
            "#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", 
            "#ec4899", "#6366f1", "#14b8a6", "#f97316", "#06b6d4",
            "#84cc16", "#d946ef"
        ];
        asmItems.forEach((item, index) => {
            item.itemStyle = { color: palette[index % palette.length] };
            item.color = palette[index % palette.length];
        });

        // Start building Modal Body
        let bodyHtml = toggleHtml;
        
        // Initial Calculation
        const asmTotal = asmItems.reduce((sum, item) => sum + item.value, 0);

        if (asmItems.length === 0) {
            bodyHtml += '<p style="text-align: center; color: #94a3b8; padding: 2rem;">è¯¥åœºç«™æ— æ­¤é¡¹è®°å½•</p>';
        } else {
             bodyHtml += `
                <div style="display: flex; gap: 3rem; align-items: start;">
                    <div style="width: 50%; height: 480px; flex-shrink: 0;" id="modalChartInner"></div>
                    <div style="flex: 1; padding-top: 1rem;">
                        <h4 style="color: ${color}; border-bottom: 1px solid ${color}; padding-bottom: 0.8rem; margin-bottom: 1.2rem; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center;">
                            <span>${currentDetailView === 'cost' ? 'è€ƒæ ¸è´¹ç”¨' : 'è€ƒæ ¸ç”µé‡'}æ˜ç»†</span>
                            <span style="font-size: 0.9rem; color: #cbd5e1;">æ€»è®¡: <span id="stationDetailTotal" style="font-size: 1.2rem; font-weight: 700; color: ${color}; margin-left: 5px;">${asmTotal.toFixed(2)}</span> ${unit}</span>
                        </h4>
                        <div style="max-height: 380px; overflow-y: auto; padding-right: 0.5rem;">
                            <table class="data-table">
                                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 5;">
                                    <tr>
                                        <th style="text-align: left; padding: 0.8rem 0; font-size: 0.85rem; color: #94a3b8;">è€ƒæ ¸é¡¹</th>
                                        <th style="text-align: right; padding: 0.8rem 0; font-size: 0.85rem; color: #94a3b8;">æ•°å€¼ (${unit})</th>
                                    </tr>
                                </thead>
                                <tbody id="stationDetailTable">
                                    <!-- Content will be updated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
             `;
        }

        if (stationComp && currentDetailView === 'cost') {
            let compItems = [];
            Object.keys(stationComp).forEach((k) => {
              if (k !== "Station" && typeof stationComp[k] === "number" && stationComp[k] !== 0) {
                compItems.push({ name: k, value: stationComp[k] });
              }
            });
            compItems.sort((a, b) => b.value - a.value);
            
            if (compItems.length > 0) {
                const compTotal = compItems.reduce((sum, item) => sum + item.value, 0);
                bodyHtml += `
                <div style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 2rem;">
                     <h4 style="color: #10b981; margin-bottom: 1.5rem; text-align: center;">è¾…åŠ©æœåŠ¡è¡¥å¿æ˜ç»† (ä¸‡å…ƒ)</h4>
                     <div style="display: flex; gap: 3rem; align-items: start;">
                         <div id="modalCompChartInner" style="width: 48%; height: 300px; flex-shrink: 0;"></div>
                         <div style="flex: 1;">
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(16, 185, 129, 0.3);">
                                 <span style="color: #10b981; font-weight: 600;">æ€»è®¡æ”¶å…¥</span>
                                 <span style="font-size: 1.2rem; font-weight: 700; color: #10b981;">${compTotal.toFixed(2)} <span style="font-size: 0.8rem;">ä¸‡å…ƒ</span></span>
                             </div>
                             <table class="data-table">
                                 ${compItems.slice(0, 5).map(i => `<tr><td style="padding: 0.6rem 0;">${i.name}</td><td style="text-align: right; color: #10b981; font-weight: 600;">${i.value.toFixed(2)}</td></tr>`).join("")}
                             </table>
                         </div>
                     </div>
                </div>
                `;
                window.tempCompItems = compItems; 
            }
        }

        document.getElementById("modalTableWrap").innerHTML = bodyHtml;

        // Render Table Function
        const renderTable = (items) => {
            const tableEl = document.getElementById('stationDetailTable');
            if (!tableEl) return;
            // Only show Top 10 or all? User request implies detailed check. Let's show all visible.
            // But if many, scrolling is active. 
            // Let's show items passed.
            tableEl.innerHTML = items.map(i => `
                <tr onmouseenter="highlightStationDetail('${i.name}')" onmouseleave="unhighlightStationDetail()" style="cursor: pointer; transition: background 0.2s;">
                    <td style="padding: 0.8rem 0; color: var(--text-sub); display:flex; align-items:center;">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${i.color};margin-right:10px;"></span>
                        ${i.name}
                    </td>
                    <td style="text-align: right; color: ${color}; font-weight: 700; font-size: 1.05rem;">${i.value.toFixed(2)}</td>
                </tr>
            `).join("");
        };
        
        // Initial Table Render
        if (asmItems.length > 0) {
            renderTable(asmItems);
            
            setTimeout(() => {
                const chartDom = document.getElementById("modalChartInner");
                if (chartDom) {
                     if (currentDetailChart) {
                         currentDetailChart.dispose();
                     }
                     currentDetailChart = echarts.init(chartDom);
                     currentDetailChart.setOption({
                      tooltip: { trigger: "item", formatter: "{b}: {c} (" + unit + ")" },
                      legend: { 
                        type: "scroll", 
                        orient: "horizontal", 
                        bottom: 0, 
                        width: "100%",
                        left: 'center',
                        textStyle: { color: "#cbd5e1", fontSize: 11 },
                        pageTextStyle: { color: "#fff" },
                        pageIconColor: "#3b82f6"
                      },
                      series: [{
                          name: "æ˜ç»†",
                          type: "pie",
                          radius: ["35%", "65%"], 
                          center: ["50%", "38%"], 
                          data: asmItems,
                          label: { show: false },
                          itemStyle: { borderRadius: 8, borderColor: "#0f172a", borderWidth: 2 }
                      }]
                    });
                    
                    // Event Listener for Legend Change
                    currentDetailChart.on('legendselectchanged', function(params) {
                        const selected = params.selected;
                        const visibleItems = asmItems.filter(item => selected[item.name] !== false);
                        const newTotal = visibleItems.reduce((sum, item) => sum + item.value, 0);
                        
                        // Update Total
                        const totalEl = document.getElementById('stationDetailTotal');
                        if(totalEl) totalEl.innerText = newTotal.toFixed(2);
                        
                        // Update Table
                        renderTable(visibleItems);
                    });
                }
            }, 50);
        }
        
        if (stationComp && currentDetailView === 'cost' && window.tempCompItems) {
            setTimeout(() => {
                const chartDom = document.getElementById("modalCompChartInner");
                if (chartDom) {
                    let myChart = echarts.getInstanceByDom(chartDom);
                    if (myChart) myChart.dispose();
                    myChart = echarts.init(chartDom);
                    myChart.setOption({
                      tooltip: { trigger: "item", formatter: "{b}: {c}" },
                      legend: { 
                        type: "scroll", 
                        orient: "horizontal", 
                        bottom: 0, 
                        width: '100%',
                        left: 'center',
                        textStyle: { color: "#cbd5e1", fontSize: 10 },
                        pageIconColor: "#10b981"
                      },
                      series: [{
                          type: "pie",
                          radius: ["40%", "70%"],
                          center: ["50%", "45%"],
                          data: window.tempCompItems,
                          label: { show: false },
                          color: ["#8b5cf6", "#10b981", "#f59e0b"]
                      }]
                    });
                }
                delete window.tempCompItems;
            }, 50);
        }
      }

      function switchDetailView(mode) {
          currentDetailView = mode;
          renderStationDetailModal();
      }

      // Init
      fetchHistory();
    </script>
  </body>
</html>
