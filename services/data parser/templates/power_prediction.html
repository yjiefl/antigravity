<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–°èƒ½æºåŠŸç‡é¢„æµ‹å¯è§†åŒ–å·¥ä½œç«™</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  </head>
  <body class="theme-power">
    <div class="container">
      <header class="app-header">
        <div class="branding">
          <h1>åŠŸç‡é¢„æµ‹Â·åˆæ ¼ç‡åˆ†æ</h1>
          <p>äº¤äº’å¼ç©¿é€æŸ¥çœ‹åŠŸç‡é¢„æµ‹æ‰£åˆ†æ˜ç»†ä¸åŸå› çƒ­åº¦</p>
        </div>

        <nav class="top-nav">
          <a href="/power_prediction" class="btn nav-btn active">åŠŸç‡é¢„æµ‹åˆ†æ</a>
          <a href="/daily_report" class="btn btn-secondary nav-btn">è¿è¥æ—¥æŠ¥å®¡æ ¸</a>
          <a href="/two_rules" class="btn btn-secondary nav-btn">ä¸¤ä¸ªç»†åˆ™åˆ†æ</a>
        </nav>
      </header>

      <section class="upload-section">
        <div class="upload-box" id="dropZone">
          <div id="fileTriggerArea" style="cursor: pointer; padding: 0.8rem">
            <span style="font-size: 2.2rem">ğŸ§¬</span>
            <p
              id="fileDisplay"
              style="
                color: var(--text-muted);
                font-size: 0.95rem;
                margin-top: 0.5rem;
              "
            >
              ç‚¹å‡»æµè§ˆæ–‡ä»¶ æˆ– æ‹–å…¥ CSV <br />
              <span style="font-size: 0.85rem; color: #64748b"
                >(è¯´æ˜ï¼šå¯¼å…¥åŠŸç‡é¢„æµ‹è´¨é‡é—®é¢˜è¡¨)</span
              >
            </p>
          </div>
          <div style="text-align: center; margin-bottom: 0.5rem">
            <a
              href="/static/templates/power_prediction_template.csv"
              download="åŠŸç‡é¢„æµ‹åˆ†ææ¨¡ç‰ˆ.csv"
              style="
                font-size: 0.8rem;
                color: var(--primary-color);
                text-decoration: none;
                border-bottom: 1px dashed var(--primary-color);
                display: inline-block;
              "
              >â¬‡ï¸ ä¸‹è½½å¯¼å…¥æ¨¡ç‰ˆ</a
            >
          </div>

          <input
            type="file"
            id="fileInput"
            accept=".csv"
            style="display: none"
          />

          <!-- å…¬å¸ç­›é€‰é€‰é¡¹ -->
          <div style="margin-top: 1rem; text-align: center">
            <label
              style="
                display: inline-flex;
                align-items: center;
                gap: 8px;
                font-size: 0.9rem;
                color: #cbd5e1;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="filterCompany"
                style="
                  width: 16px;
                  height: 16px;
                  accent-color: var(--primary-color);
                "
              />
              <span style="user-select: none">ä»…åˆ†æä¸­èƒ½å»ºå¹¿è¥¿å…¬å¸åœºç«™</span>
            </label>
          </div>

          <div
            style="
              display: flex;
              justify-content: center;
              gap: 1.5rem;
              margin-top: 1rem;
            "
          >
            <button class="btn btn-secondary" id="browseBtn">
              ğŸ“‚ æµè§ˆæ–‡ä»¶
            </button>
            <button class="btn" id="analyzeBtn">ğŸš€ è¿è¡Œæ·±åº¦åˆ†æ</button>
          </div>
        </div>
      </section>

      <div class="loading-spinner" id="loader">
        <div class="spinner"></div>
        <p
          style="
            margin-top: 1rem;
            color: var(--primary-color);
            font-weight: 600;
          "
        >
          æ·±åº¦çŸ©é˜µåˆ†æä¸­ï¼Œè¯·ç¨å€™...
        </p>
      </div>

      <section
        class="viz-grid"
        id="historySection"
        style="margin-top: 1rem; margin-bottom: 2rem; display: block !important"
      >
        <div
          class="card wide-card"
          style="padding: 1.5rem; border: 1px dashed var(--glass-border)"
        >
          <div
            class="card-title"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              padding-bottom: 0.8rem;
              margin-bottom: 1rem;
            "
          >
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="font-size: 1.1rem">ğŸ“‚ åˆ†æå†å²è®°å½• (äº‘ç«¯åŒæ­¥)</span>
                <button id="startCompareBtn" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background: var(--primary-color); display: none;" onclick="runComparison()">
                    âš–ï¸ å¯¹æ¯”æ‰€é€‰ (0/2)
                </button>
            </div>
            <span
              id="historyCount"
              style="
                font-size: 0.85rem;
                color: var(--primary-color);
                font-weight: 600;
              "
              >æ£€æµ‹ä¸­...</span
            >
          </div>
          <div
            id="historyList"
            style="
              display: flex;
              flex-direction: column;
              gap: 1rem;
              max-height: 400px;
              overflow-y: auto;
              padding-right: 0.5rem;
            "
          >
            <!-- å†å²è®°å½•åˆ—è¡¨ -->
          </div>
        </div>
      </section>

      <section class="viz-grid" id="dashboard">
        <div class="summary-cards wide-card">
          <div class="card">
            <div class="card-title">ç´¯è®¡æ‰£åˆ†æ€»é¢</div>
            <div class="card-value" style="color: #ff4d4d" id="totalDeduction">
              0.00
            </div>
          </div>
          <div class="card">
            <div class="card-title">å¼‚å¸¸è®°å½•æ€»æ•°</div>
            <div class="card-value" id="totalCases">0</div>
          </div>
          <div class="card">
            <div class="card-title">ä¸»è¦è´£ä»»å•ä½</div>
            <div
              class="card-value"
              style="font-size: 1.2rem; color: var(--primary-color)"
              id="topOffender"
            >
              -
            </div>
          </div>
        </div>

        <div class="card wide-card">
          <div class="card-title">åœºç«™æ‰£åˆ†çƒ­åº¦ (ç‚¹å‡»æŸ±æ¡æŸ¥çœ‹æ˜ç»†)</div>
          <div class="chart-container">
            <canvas id="stationChart"></canvas>
          </div>
        </div>

        <div class="card wide-card">
          <div class="card-title">åŸå› é¢‘ç‡åˆ†å¸ƒ (ç‚¹å‡»æ‰‡åŒºæŸ¥çœ‹æ˜ç»†)</div>
          <div class="chart-container">
            <canvas id="problemChart"></canvas>
          </div>
        </div>

        <div
          class="card wide-card"
          id="drillDownCard"
          style="
            display: none;
            animation: slideUp 0.5s ease;
            border-top: 2px solid var(--primary-color);
          "
        >
          <div
            class="card-title"
            id="drillDownTitle"
            style="color: #fff; font-size: 1.2rem; margin-bottom: 1.5rem"
          >
            é’»å–ç»“æœæº¯æº
          </div>
          <div class="detail-table-wrapper">
            <table id="detailsTable">
              <thead>
                <tr>
                  <th>å‚ç«™å</th>
                  <th>æ—¥æœŸ</th>
                  <th>æ—¶åˆ»</th>
                  <th>è€ƒæ ¸é¡¹</th>
                  <th>æ‰£åˆ†å€¼</th>
                  <th>å…·ä½“åŸå› </th>
                </tr>
              </thead>
              <tbody id="detailsBody"></tbody>
            </table>
          </div>
        </div>

        <div
          class="wide-card"
          style="
            text-align: center;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1.2rem;
            flex-wrap: wrap;
          "
        >

          <button class="btn" style="background: #8b5cf6" id="offlineBtn">
            ğŸŒ ç¦»çº¿äº¤äº’çœ‹æ¿ (HTML)
          </button>
          <div
            style="
              width: 100%;
              height: 1px;
              background: rgba(255, 255, 255, 0.05);
              margin: 0.5rem 0;
            "
          ></div>
          <a
            href="#"
            class="btn btn-secondary"
            id="xlsxBtn"
            style="padding: 0.8rem 1.5rem; font-size: 1rem"
            >ğŸ“Š Excel çŸ©é˜µ</a
          >
          <a
            href="#"
            class="btn btn-secondary"
            id="pdfBtn"
            style="padding: 0.8rem 1.5rem; font-size: 1rem"
            >ğŸ“„ PDF æŠ¥å‘Šæ±‡æ€»</a
          >
        </div>
      </section>

      <!-- å¯¹æ¯”åˆ†æçœ‹æ¿ -->
      <section class="viz-grid" id="compareDashboard" style="display: none; border-top: 2px solid var(--primary-color); padding-top: 2rem;">
        <div class="summary-cards wide-card">
           <div class="card" style="grid-column: span 1;">
              <div class="card-title">å¯¹æ¯”åŸºå‡† (æ—§)</div>
              <div id="compareMetaOld" style="font-size: 0.9rem; font-weight: 600;"></div>
              <div id="compareTimeOld" style="font-size: 0.75rem; color: var(--text-muted);"></div>
           </div>
           <div class="card" style="grid-column: span 1;">
              <div class="card-title">å¯¹æ¯”å¯¹è±¡ (æ–°)</div>
              <div id="compareMetaNew" style="font-size: 0.9rem; font-weight: 600;"></div>
              <div id="compareTimeNew" style="font-size: 0.75rem; color: var(--text-muted);"></div>
           </div>
           <div class="card" style="grid-column: span 1; text-align: center;">
              <div class="card-title">æ‰£åˆ†å˜åŒ–å·®å¼‚</div>
              <div id="compareDiffScore" style="font-size: 2.4rem; font-weight: 800;"></div>
              <div id="compareDiffLabel" style="font-size: 1rem; font-weight: 600;"></div>
           </div>
        </div>

        <div class="card wide-card">
          <div class="card-title">æ‰£åˆ†æ³¢åŠ¨è¶‹åŠ¿ï¼ˆæŒ‰åœºç«™/è€ƒæ ¸é¡¹ï¼Œç‚¹å‡»æŸ¥çœ‹ç©¿é€ï¼‰</div>
          <div class="chart-container">
            <canvas id="compareChart"></canvas>
          </div>
        </div>

        <div class="card wide-card">
           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <div class="card-title" style="margin: 0;">åœºç«™å¯¹æ¯”æ³¢åŠ¨æ¦œå•</div>
              <div style="display: flex; gap: 0.8rem;">
                 <a href="#" id="compareXlsxBtn" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; color: #10b981;">ğŸŸ¢ å¯¼å‡º Excel å¯¹æ¯”</a>
                 <a href="#" id="comparePdfBtn" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; color: #6366f1;">ğŸ”µ å¯¼å‡º PDF æŠ¥å‘Š</a>
              </div>
           </div>
           <div id="compareListContent"></div>
        </div>
        <div class="card wide-card" id="compareDrillDownCard" style="display: none; border-top: 2px solid var(--primary-color); background: rgba(15, 23, 41, 0.6);">
           <div class="card-title" id="compareDrillTitle" style="color: var(--primary-color);">ç©¿é€æ˜ç»†è§£æ</div>
           <div class="detail-table-wrapper">
              <table id="compareDetailsTable">
                 <thead>
                    <tr>
                       <th style="width: 15%;">æŒ‡æ ‡ / å…³è”å•ä½</th>
                       <th style="width: 10%; text-align: right;">æ—§è®°å½•çŠ¶å†µ</th>
                       <th style="width: 10%; text-align: right;">æ–°è®°å½•çŠ¶å†µ</th>
                       <th style="width: 12%; text-align: right;">å·®å¼‚æ³¢åŠ¨</th>
                       <th style="width: 53%;">å…¨å‘¨æœŸå…·ä½“åŸå› è¿½è¸ª</th>
                    </tr>
                 </thead>
                 <tbody id="compareDetailsBody"></tbody>
              </table>
           </div>
        </div>
      </section>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
      Chart.register(ChartDataLabels);

      const dropZone = document.getElementById("dropZone");
      const fileTriggerArea = document.getElementById("fileTriggerArea");
      const browseBtn = document.getElementById("browseBtn");
      const fileInput = document.getElementById("fileInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const dashboard = document.getElementById("dashboard");
      const loader = document.getElementById("loader");
      const detailsBody = document.getElementById("detailsBody");
      const drillDownCard = document.getElementById("drillDownCard");
      const drillDownTitle = document.getElementById("drillDownTitle");

      let stationChart, problemChart, compareChart;
      let allDetails = [];
      let lastComparisonData = null; // Store comparison results for drill-down

      const triggerFile = () => fileInput.click();
      fileTriggerArea.onclick = triggerFile;
      browseBtn.onclick = triggerFile;

      fileInput.onchange = () => {
        if (fileInput.files.length) {
          document.getElementById("fileDisplay").innerText =
            `å·²å°±ç»ª: ${fileInput.files[0].name}`;
          document.getElementById("fileDisplay").style.color = "#10b981";
        }
      };

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.background = "rgba(99, 102, 241, 0.1)";
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.style.background = "var(--glass-bg)";
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.style.background = "var(--glass-bg)";
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          fileInput.dispatchEvent(new Event("change"));
        }
      });

      async function fetchHistory() {
        try {
          const res = await fetch("/history");
          const history = await res.json();
          renderHistory(history);
        } catch (err) {
          console.error("Failed to fetch history");
        }
      }

      function renderHistory(history) {
        const list = document.getElementById("historyList");
        document.getElementById("historyCount").innerText =
          `å…± ${history.length} æ¡è®°å½•`;

        if (history.length === 0) {
          list.innerHTML =
            '<p style="color: #94a3b8; text-align: center; padding: 1rem;">æš‚æ— å†å²è®°å½•</p>';
          return;
        }

        list.innerHTML = history
          .map(
            (item) => `
                <div class="history-item" style="display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 0.8rem 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="margin-right: 1rem;">
                        <input type="checkbox" class="history-checkbox" value="${item.file_id}" onchange="handleSelection(this)" style="width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer;">
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 0.2rem; font-size: 0.95rem;">${item.filename}</div>
                        <div style="font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; gap: 0.8rem;">
                            <span>ğŸ“… ${item.timestamp}</span>
                            <span>ğŸ”¥ æ‰£åˆ†: <b style="color: #ff4d4d">${item.total_deduction}</b></span>
                            <span>ğŸ“Š è®°å½•: ${item.total_cases}</span>
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a href="/download/original/${item.filename}" class="history-download" style="color: #94a3b8; text-decoration: none; font-size: 0.72rem; display: flex; align-items: center; gap: 4px;">
                                âšª ä¸‹è½½åŸå§‹ CSV
                            </a>
                            <a href="/download/${item.xlsx_filename}" class="history-download" style="color: #10b981; text-decoration: none; font-size: 0.72rem; display: flex; align-items: center; gap: 4px;">
                                ğŸŸ¢ Excel çŸ©é˜µ
                            </a>
                            <a href="/download/${item.pdf_filename}" class="history-download" style="color: #6366f1; text-decoration: none; font-size: 0.72rem; display: flex; align-items: center; gap: 4px;">
                                ğŸ”µ PDF æŠ¥å‘Š
                            </a>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.6rem; align-self: center;">
                        <button class="btn btn-secondary" onclick='loadRecord(${JSON.stringify(item).replace(/'/g, "&apos;")})' style="padding: 0.35rem 0.8rem; font-size: 0.75rem;">ğŸ“‚ è°ƒå‡ºçœ‹æ¿</button>
                        <button class="btn" onclick="deleteHistory('${item.file_id}')" style="padding: 0.35rem 0.8rem; font-size: 0.75rem; background: rgba(255,77,77,0.1); color: #ff4d4d; border-color: rgba(255,77,77,0.2)">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function loadRecord(item) {
        allDetails = item.raw_details;
        renderDashboard(item);
        dashboard.scrollIntoView({ behavior: "smooth" });
      }

      async function deleteHistory(fileId) {
        const password = prompt("è¯·è¾“å…¥åˆ é™¤å¯†ç :");
        if (password === null) return;

        try {
          const res = await fetch(
            `/history/${fileId}?password=${encodeURIComponent(password)}`,
            { method: "DELETE" },
          );
          const data = await res.json();
          if (data.success) {
            fetchHistory();
          } else {
            alert(data.error || "åˆ é™¤å¤±è´¥");
          }
        } catch (err) {
          alert("ç½‘ç»œé”™è¯¯");
        }
      }

      // åˆå§‹åŠ è½½å†å²
      fetchHistory();

      analyzeBtn.onclick = async () => {
        if (!fileInput.files.length) {
          alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
          return;
        }
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append(
          "filter_ceec",
          document.getElementById("filterCompany").checked,
        );
        loader.style.display = "block";
        dashboard.style.display = "none";
        drillDownCard.style.display = "none";

        try {
          const res = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.success) {
            allDetails = data.raw_details;
            renderDashboard(data);
            fetchHistory(); // åˆ†æå®Œåˆ·æ–°å†å²
          } else alert("åˆ†æä¸­æ–­: " + data.error);
        } catch (err) {
          alert("ç½‘ç»œè¶…æ—¶");
        } finally {
          loader.style.display = "none";
        }
      };



      // ç¦»çº¿äº¤äº’çœ‹æ¿å¯¼å‡º (HTML)
      document.getElementById("offlineBtn").onclick = () => {
        if (!allDetails.length) return;

        const currentData = {
          total_deduction: document.getElementById("totalDeduction").innerText,
          total_cases: document.getElementById("totalCases").innerText,
          top_stations: lastRenderedData.top_stations,
          top_items: lastRenderedData.top_items,
          raw_details: allDetails,
        };

        const offlineTemplate = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç¦»çº¿åˆ†æçœ‹æ¿ - ${new Date().toLocaleDateString()}</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"><\/script>
    <style>
        ${document.querySelector('link[rel="stylesheet"]').href ? '@import url("' + document.querySelector('link[rel="stylesheet"]').href + '");' : ""}
        body { background: #0b0e14; padding: 2rem; color: #fff; font-family: 'Outfit', sans-serif; }
        .container { max-width: 1400px; margin: 0 auto; }
        .viz-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-title { font-size: 0.9rem; color: #e2e8f0; font-weight: 700; margin-bottom: 0.8rem; }
        .card-value { font-size: 2.4rem; font-weight: 800; }
        .chart-container { height: 400px; position: relative; }
        .wide-card { grid-column: span 2; }
        .detail-table-wrapper { margin-top: 1.5rem; max-height: 600px; overflow-y: auto; background: rgba(15, 23, 42, 0.4); border-radius: 20px; border: 1px solid rgba(255,255,255,0.08); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { position: sticky; top: 0; background: #1e293b; padding: 1.2rem 1rem; text-align: left; color: #6366f1; border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; vertical-align: top; word-wrap: break-word; }
        .offline-notice { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; padding: 1rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="offline-notice">è¿™æ˜¯ä¸€ä¸ªç¦»çº¿ç”Ÿæˆçš„äº¤äº’å¼æŠ¥å‘Šï¼Œæ‚¨å¯ä»¥è‡ªç”±ç‚¹å‡»å›¾è¡¨è¿›è¡Œé’»å–åˆ†æã€‚</div>
        <div class="viz-grid" style="display: grid;">
            <div class="summary-cards wide-card">
                <div class="card">
                    <div class="card-title">ç´¯è®¡æ‰£åˆ†æ€»é¢</div>
                    <div class="card-value" style="color: #ff4d4d;">${currentData.total_deduction}</div>
                </div>
                <div class="card">
                    <div class="card-title">å¼‚å¸¸è®°å½•æ€»æ•°</div>
                    <div class="card-value">${currentData.total_cases}</div>
                </div>
                <div class="card">
                    <div class="card-title">ä¸»è¦è´£ä»»å•ä½</div>
                    <div id="offlineOffender"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">åœºç«™æ‰£åˆ†çƒ­åº¦ (ç‚¹å‡»æŸ¥çœ‹æ˜ç»†)</div>
                <div class="chart-container"><canvas id="stationChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title">åŸå› åˆ†å¸ƒ (ç‚¹å‡»æŸ¥çœ‹æ˜ç»†)</div>
                <div class="chart-container"><canvas id="problemChart"></canvas></div>
            </div>
            <div class="card wide-card" id="drillDownCard" style="display: none; border-top: 2px solid #6366f1; margin-top:1rem;">
                <div class="card-title" id="drillDownTitle" style="color: #fff; font-size: 1.1rem; margin-bottom: 1rem;"></div>
                <div class="detail-table-wrapper">
                    <table>
                        <thead><tr><th>å‚ç«™å</th><th>æ—¥æœŸ</th><th>æ—¶åˆ»</th><th>è€ƒæ ¸é¡¹</th><th>æ‰£åˆ†å€¼</th><th>åŸå› </th></tr></thead>
                        <tbody id="detailsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const data = ${JSON.stringify(currentData)};
        const allDetails = data.raw_details;
        Chart.register(ChartDataLabels);

        // æ¸²æŸ“è´£ä»»å•ä½
        document.getElementById('offlineOffender').innerHTML = data.top_stations.slice(0, 3).map(s => \`
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <span style="font-size: 0.95rem;">\${s.name}</span>
                <b style="color: #ff4d4d;">-\${s.value}</b>
            </div>
        \`).join('');

        const ctx1 = document.getElementById('stationChart').getContext('2d');
        const sc = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: data.top_stations.map(s => s.name),
                datasets: [{ data: data.top_stations.map(s => s.value), backgroundColor: 'rgba(99, 102, 241, 0.8)' }]
            },
            options: { 
                indexAxis: 'y', maintainAspectRatio: false, 
                plugins: { legend: {display: false}, datalabels: {color: '#fff', font: {weight: 'bold'}} },
                scales: { x: {ticks: {color:'#fff'}}, y: {ticks: {color:'#fff'}} },
                onClick: (e, el) => { if(el.length) showDrillDown('station', sc.data.labels[el[0].index]); }
            }
        });

        const ctx2 = document.getElementById('problemChart').getContext('2d');
        const pc = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: data.top_items.map(p => p.name),
                datasets: [{ data: data.top_items.map(p => p.value), backgroundColor: ['#6366f1','#a855f7','#f43f5e','#fbbf24','#10b981','#3b82f6','#ec4899','#f59e0b','#06b6d4'] }]
            },
            options: { 
                maintainAspectRatio: false, 
                plugins: { legend: { labels: {color:'#fff'}, position:'right', align: 'start' }, datalabels:{display:false} },
                onClick: (e, el) => { if(el.length) showDrillDown('item', pc.data.labels[el[0].index]); }
            }
        });

        function showDrillDown(type, value) {
            const card = document.getElementById('drillDownCard');
            card.style.display = 'block';
            const filtered = allDetails.filter(d => (type === 'station' ? d.å‚ç«™å : d.è€ƒæ ¸é¡¹) === value);
            const total = filtered.reduce((s, d) => s + parseFloat(d.æ‰£åˆ†å€¼), 0).toFixed(2);
            document.getElementById('drillDownTitle').innerHTML = \`æº¯æº: \${value} (ç´¯è®¡ -\${total})\`;
            document.getElementById('detailsBody').innerHTML = filtered.map(d => \`
                <tr>
                    <td>\${d.å‚ç«™å}</td><td>\${d.æ—¥æœŸ}</td><td>\${d.æ—¶åˆ»}</td>
                    <td style="color:#fbbf24">\${d.è€ƒæ ¸é¡¹}</td>
                    <td style="color:#ff4d4d; font-weight:800;">-\${d.æ‰£åˆ†å€¼}</td>
                    <td style="color:#cbd5e1; font-size:0.8rem;">\${d.å…·ä½“åŸå› }</td>
                </tr>
            \`).join('');
            card.scrollIntoView({behavior: 'smooth'});
        }
    <\/script>
</body>
</html>`;

        const blob = new Blob([offlineTemplate], { type: "text/html" });
        const link = document.createElement("a");
        link.download = `åˆ†æäº¤äº’çœ‹æ¿_${new Date().getTime()}.html`;
        link.href = URL.createObjectURL(blob);
        link.click();
      };

      let lastRenderedData = null; // è®°å½•æœ€è¿‘ä¸€æ¬¡æ¸²æŸ“æ•°æ®

      function renderDashboard(data) {
        lastRenderedData = data;
        document.getElementById("totalDeduction").innerText =
          data.total_deduction;
        document.getElementById("totalCases").innerText = data.total_cases;

        // æ¸²æŸ“å‰3åè´£ä»»å•ä½
        const topOffendersList = data.top_stations.slice(0, 3);
        const offenderHtml = topOffendersList
          .map(
            (s) => `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.95rem; font-weight: 500;">${s.name}</span>
                    <b style="color: var(--danger); font-size: 1rem;">-${s.value}</b>
                </div>
            `,
          )
          .join("");
        document.getElementById("topOffender").innerHTML = offenderHtml || "-";

        document.getElementById("xlsxBtn").href =
          `/download/${data.xlsx_filename}`;

        document.getElementById("pdfBtn").href =
          `/download/${data.pdf_filename}`;
        dashboard.style.display = "grid";

        const ctx1 = document.getElementById("stationChart").getContext("2d");
        if (stationChart) stationChart.destroy();
        stationChart = new Chart(ctx1, {
          type: "bar",
          data: {
            labels: data.top_stations.map((s) => s.name),
            datasets: [
              {
                label: "ç´¯è®¡æ‰£åˆ†",
                data: data.top_stations.map((s) => s.value),
                backgroundColor: "rgba(99, 102, 241, 0.8)",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            plugins: {
              legend: { display: false },
              datalabels: {
                color: "#fff",
                anchor: "end",
                align: "right",
                font: { weight: "bold", size: 11 },
              },
            },
            scales: {
              x: { ticks: { color: "#cbd5e1" } },
              y: {
                ticks: { color: "#fff", font: { size: 12, weight: "bold" } },
              },
            },
            onClick: (event, elements) => {
              if (elements.length > 0)
                showDrillDown(
                  "station",
                  stationChart.data.labels[elements[0].index],
                );
            },
          },
        });

        const ctx2 = document.getElementById("problemChart").getContext("2d");
        if (problemChart) problemChart.destroy();
        problemChart = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: data.top_items.map((p) => p.name),
            datasets: [
              {
                data: data.top_items.map((p) => p.value),
                backgroundColor: [
                  "#6366f1",
                  "#a855f7",
                  "#f43f5e",
                  "#fbbf24",
                  "#10b981",
                  "#3b82f6",
                  "#ec4899",
                  "#f59e0b",
                  "#06b6d4",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                align: "start",
                labels: {
                  color: "#ffffff",
                  font: { size: 12, weight: "600" },
                  padding: 15,
                  boxWidth: 12,
                },
              },
              datalabels: { display: false },
            },
            onClick: (event, elements) => {
              if (elements.length > 0)
                showDrillDown(
                  "item",
                  problemChart.data.labels[elements[0].index],
                );
            },
          },
        });
      }

      function showDrillDown(type, value) {
        drillDownCard.style.display = "block";
        const searchVal = value.toString().trim();
        const filtered = allDetails.filter(
          (d) =>
            (type === "station" ? d.å‚ç«™å : d.è€ƒæ ¸é¡¹).toString().trim() ===
            searchVal,
        );

        const currentTotal = filtered
          .reduce((sum, d) => sum + parseFloat(d.æ‰£åˆ†val || d.æ‰£åˆ†å€¼), 0)
          .toFixed(2);

        // æ„å»ºåˆ†ç±»å°è®¡ HTML (å¦‚æœç©¿é€çš„æ˜¯åœºç«™)
        let breakdownHtml = "";
        if (type === "station") {
          const groups = filtered.reduce((acc, d) => {
            const cat = d.è€ƒæ ¸é¡¹;
            acc[cat] = (acc[cat] || 0) + parseFloat(d.æ‰£åˆ†å€¼);
            return acc;
          }, {});

          breakdownHtml =
            '<div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.8rem;">';
          for (const [cat, val] of Object.entries(groups)) {
            breakdownHtml += `
                        <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem;">
                            <span style="color: #94a3b8;">${cat}:</span> 
                            <b style="color: var(--primary-color); margin-left: 4px;">-${val.toFixed(2)}</b>
                        </div>`;
          }
          breakdownHtml += "</div>";
        }

        drillDownCard.scrollIntoView({ behavior: "smooth", block: "start" });
        drillDownTitle.innerHTML = `
                <div style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.3rem;">é’»å–ç»“æœæº¯æºï¼š<b style="color: var(--primary-color)">${value}</b></span>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 2px;">å½“å‰é€‰ä¸­é¡¹ç´¯è®¡æ‰£åˆ†</div>
                            <div style="color: #ff4d4d; font-size: 1.5rem; font-weight: 800;">${currentTotal}</div>
                        </div>
                    </div>
                    ${breakdownHtml}
                </div>
            `;

        if (filtered.length === 0) {
          detailsBody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 3rem;">æœªæ‰¾åˆ°ç›¸å…³æ˜ç»†</td></tr>';
        } else {
          detailsBody.innerHTML = filtered
            .map(
              (d) => `
                    <tr style="font-size: 0.85rem;">
                        <td style="color: #fff; font-weight: 600;">${d.å‚ç«™å}</td>
                        <td style="color: #fff;">${d.æ—¥æœŸ}</td>
                        <td style="color: #fff; font-family: monospace;">${d.æ—¶åˆ»}</td>
                        <td><span style="color: var(--warning); font-weight: 600;">${d.è€ƒæ ¸é¡¹}</span></td>
                        <td style="color: var(--danger); font-weight: 800; font-size: 0.95rem;">-${d.æ‰£åˆ†å€¼}</td>
                        <td style="color: #f1f5f9; line-height: 1.5; font-size: 0.82rem;">${d.å…·ä½“åŸå› }</td>
                    </tr>
                `,
            )
            .join("");
        }
      }

      // Comparison Logic
      let selectedIds = [];

      function handleSelection(checkbox) {
          if (checkbox.checked) {
              if (selectedIds.length >= 2) {
                  checkbox.checked = false;
                  alert("æœ€å¤šåªèƒ½é€‰æ‹© 2 æ¡è®°å½•è¿›è¡Œå¯¹æ¯”");
                  return;
              }
              selectedIds.push(checkbox.value);
          } else {
              selectedIds = selectedIds.filter(id => id !== checkbox.value);
          }
          
          const btn = document.getElementById("startCompareBtn");
          if (selectedIds.length === 2) {
              btn.style.display = "block";
              btn.innerText = `âš–ï¸ å¼€å§‹å¯¹æ¯” (${selectedIds.length}/2)`;
          } else {
              btn.style.display = "none";
          }
      }

      async function runComparison() {
          if (selectedIds.length !== 2) return;
          
          const btn = document.getElementById("startCompareBtn");
          btn.innerText = "â³ æ­£åœ¨äº¤å‰è®¡ç®—...";
          
          try {
              const res = await fetch(`/compare?id1=${selectedIds[0]}&id2=${selectedIds[1]}`);
              const json = await res.json();
              
              if (json.success) {
                  lastComparisonData = json.data;
                  renderComparison(json.data);
                  
                  // Show compare dashboard, hide single dashboard
                  document.getElementById("dashboard").style.display = "none";
                  document.getElementById("compareDashboard").style.display = "grid";
                  document.getElementById("compareDashboard").scrollIntoView({ behavior: "smooth" });
                  
                  // Setup Export Links
                  document.getElementById("compareXlsxBtn").href = `/compare/export/excel?id1=${selectedIds[0]}&id2=${selectedIds[1]}`;
                  document.getElementById("comparePdfBtn").href = `/compare/export/pdf?id1=${selectedIds[0]}&id2=${selectedIds[1]}`;
              } else {
                  alert("å¯¹æ¯”å¤±è´¥: " + json.error);
              }
          } catch (err) {
              alert("ç½‘ç»œé”™è¯¯");
          } finally {
              btn.innerText = `âš–ï¸ å¼€å§‹å¯¹æ¯” (2/2)`;
          }
      }

      function renderComparison(data) {
          const meta = data.meta;
          const diffScore = meta.total_deduction_diff;
          const diffColor = diffScore < 0 ? "#10b981" : (diffScore > 0 ? "#ff4d4d" : "#94a3b8");
          const diffIcon = diffScore < 0 ? "ğŸ“‰ æƒ…å†µæœ‰æ‰€æ”¹å–„" : (diffScore > 0 ? "ğŸ“ˆ æƒ…å†µæ­£åœ¨æ¶åŒ–" : "â– æŒå¹³");
          
          // Fill Meta
          document.getElementById('compareMetaOld').innerText = meta.filename_old;
          document.getElementById('compareTimeOld').innerText = meta.timestamp_old;
          document.getElementById('compareMetaNew').innerText = meta.filename_new;
          document.getElementById('compareTimeNew').innerText = meta.timestamp_new;
          
          const scoreEl = document.getElementById('compareDiffScore');
          scoreEl.innerText = (diffScore > 0 ? '+' : '') + diffScore;
          scoreEl.style.color = diffColor;
          
          const labelEl = document.getElementById('compareDiffLabel');
          labelEl.innerText = diffIcon;
          labelEl.style.color = diffColor;

          // Render List Tables
          const listHtml = `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                  <div>
                      <h4 style="margin-bottom: 1rem; color: #94a3b8; font-size: 0.85rem;">åœºç«™æ³¢åŠ¨æ’è¡Œ (ç‚¹å‡»è¡Œç©¿é€)</h4>
                      ${renderDiffTable(data.station_diffs, 'åœºç«™')}
                  </div>
                  <div>
                      <h4 style="margin-bottom: 1rem; color: #94a3b8; font-size: 0.85rem;">æŒ‡æ ‡è¶‹åŠ¿å˜åŠ¨ (ç‚¹å‡»è¡Œç©¿é€)</h4>
                      ${renderDiffTable(data.item_diffs, 'è€ƒæ ¸é¡¹')}
                  </div>
              </div>
          `;
          document.getElementById('compareListContent').innerHTML = listHtml;
          document.getElementById('compareDrillDownCard').style.display = 'none';
          
          // Render Compare Chart
          setTimeout(() => {
              const ctx = document.getElementById('compareChart').getContext('2d');
              if (compareChart) compareChart.destroy();
              
              // Sort by absolute diff and get top 15
              const topChanges = [...data.station_diffs]
                  .sort((a,b) => Math.abs(b.diff) - Math.abs(a.diff))
                  .slice(0, 15);
              
              compareChart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: topChanges.map(c => c.name),
                      datasets: [{
                          label: 'å¾—åˆ†å˜åŠ¨ (-ä¸ºæ”¹å–„, +ä¸ºæ¶åŒ–)',
                          data: topChanges.map(c => c.diff),
                          backgroundColor: topChanges.map(c => c.diff > 0 ? 'rgba(255, 77, 77, 0.7)' : 'rgba(16, 185, 129, 0.7)'),
                          borderColor: topChanges.map(c => c.diff > 0 ? '#ff4d4d' : '#10b981'),
                          borderWidth: 1
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: { 
                        legend: { display: false },
                        tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)' }
                      },
                      scales: {
                          y: { 
                            ticks: { color: '#94a3b8' }, 
                            grid: { color: 'rgba(255,255,255,0.05)' } 
                          },
                          x: { 
                            ticks: { color: '#cbd5e1', font: { size: 10 } },
                            grid: { display: false }
                          }
                      },
                      onClick: (e, el) => {
                          if (el.length) {
                              const idx = el[0].index;
                              showCompareDrillDown('station', topChanges[idx].name);
                          }
                      }
                  }
              });
          }, 100);
      }

      function renderDiffTable(diffs, label) {
          if (!diffs || diffs.length === 0) return '<p style="color:#64748b; text-align:center;">æ­¤ç»´åº¦æ— æ˜æ˜¾æ•°æ®å˜åŒ–</p>';
          
          return `
              <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                      <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); color: #94a3b8; font-size: 0.85rem;">
                          <th style="padding: 10px; text-align: left;">${label}</th>
                          <th style="padding: 10px; text-align: right;">æ—§å€¼</th>
                          <th style="padding: 10px; text-align: right;">æ–°å€¼</th>
                          <th style="padding: 10px; text-align: right;">å˜åŒ–é‡</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${diffs.map(d => {
                          const color = d.diff > 0 ? '#ff4d4d' : (d.diff < 0 ? '#10b981' : '#94a3b8');
                          const sign = d.diff > 0 ? '+' : '';
                          const rowColor = d.diff > 0 ? 'rgba(255,77,77,0.05)' : (d.diff < 0 ? 'rgba(16,185,129,0.05)' : 'transparent');
                          return `
                              <tr onclick="showCompareDrillDown('${label === 'åœºç«™' ? 'station' : 'item'}', '${d.name}')" 
                                  style="border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; background: ${rowColor};"
                                  onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                  onmouseout="this.style.background='${rowColor}'">
                                  <td style="padding: 10px;">${d.name} <span style="font-size: 0.7rem; color: var(--primary-color);">ğŸ”</span></td>
                                  <td style="padding: 10px; text-align: right; color: #64748b;">${d.val_old}</td>
                                  <td style="padding: 10px; text-align: right; font-weight: 600;">${d.val_new}</td>
                                  <td style="padding: 10px; text-align: right; color: ${color}; font-weight: 800;">${sign}${d.diff}</td>
                              </tr>
                          `;
                      }).join('')}
                  </tbody>
              </table>
          `;
      }

      function showCompareDrillDown(type, value) {
          if (!lastComparisonData) return;
          
          const card = document.getElementById('compareDrillDownCard');
          const body = document.getElementById('compareDetailsBody');
          const title = document.getElementById('compareDrillTitle');
          
          card.style.display = 'block';
          title.innerText = `ç©¿é€åˆ†æ: ${value}`;
          
          // Filter granular cross-diffs
          const relatedDiffs = lastComparisonData.station_item_diffs.filter(d => 
              (type === 'station' ? d.station : d.item) === value
          );
          
          // Sort by impact (absolute diff)
          relatedDiffs.sort((a,b) => Math.abs(b.diff) - Math.abs(a.diff));

          body.innerHTML = relatedDiffs.map(d => {
              const color = d.diff > 0 ? '#ff4d4d' : (d.diff < 0 ? '#10b981' : '#94a3b8');
              const sign = d.diff > 0 ? '+' : '';
              const targetLabel = type === 'station' ? d.item : d.station;
              
              // Try to find raw reasons if any
              const getReasons = (raw) => {
                  return raw.filter(r => r.å‚ç«™å === d.station && r.è€ƒæ ¸é¡¹ === d.item)
                            .map(r => `â€¢ ${r.å…·ä½“åŸå›  || r.åŸå› }`)
                            .slice(0, 2).join('<br>') || '-';
              };
              
              const reasonsOld = getReasons(lastComparisonData.raw_old);
              const reasonsNew = getReasons(lastComparisonData.raw_new);

              return `
                <tr>
                    <td><b style="color:#fff">${targetLabel}</b></td>
                    <td style="font-size: 0.9rem; color: #94a3b8; text-align: right;">${d.val_old}</td>
                    <td style="font-size: 0.9rem; color: #fff; text-align: right; font-weight: 600;">${d.val_new}</td>
                    <td style="text-align: right; color: ${color}; font-weight: 800;">
                        ${sign}${d.diff}
                        <div style="font-size: 0.7rem; font-weight: 400; margin-top: 4px;">
                            ${d.diff > 0 ? 'âš ï¸ æƒ…å†µè½¬å·®' : (d.diff < 0 ? 'âœ… æ˜æ˜¾æ”¹å–„' : 'æ— å˜åŒ–')}
                        </div>
                    </td>
                    <td style="font-size: 0.82rem; line-height: 1.6; padding: 0.8rem;">
                        <div style="background: rgba(255,255,255,0.02); padding: 0.6rem; border-radius: 8px; margin-bottom: 0.6rem; border-left: 3px solid #64748b;">
                            <div style="color: #94a3b8; font-size: 0.7rem; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">
                                <span style="background: #475569; color: #fff; padding: 1px 4px; border-radius: 3px;">æ—§</span> å†å²æº¯æºçŠ¶å†µ
                            </div>
                            <div style="color: #94a3b8;">${reasonsOld}</div>
                        </div>
                        <div style="background: rgba(99, 102, 241, 0.05); padding: 0.6rem; border-radius: 8px; border-left: 3px solid var(--primary-color);">
                            <div style="color: var(--primary-color); font-size: 0.7rem; font-weight: 800; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">
                                <span style="background: var(--primary-color); color: #fff; padding: 1px 4px; border-radius: 3px;">æ–°</span> å½“å‰è·Ÿè¿›çŠ¶å†µ
                            </div>
                            <div style="color: #cbd5e1;">${reasonsNew}</div>
                        </div>
                    </td>
                </tr>
              `;
          }).join('');
          
          card.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    </script>
  </body>
</html>
