<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¥æ—¥æŠ¥è‡ªåŠ¨åŒ–å®¡æ ¸ - æ•°æ®æ™ºèƒ½åˆ†æ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body class="theme-report">
    <div class="container">
        <header class="app-header">
            <div class="branding">
                <h1>è¿è¥æ—¥æŠ¥Â·è‡ªåŠ¨åŒ–å®¡æ ¸</h1>
                <p>æ·±åº¦æ¸…æ´— Excel æŠ¥è¡¨ï¼Œç²¾å‡†å®¡è®¡åˆå¹¶å•å…ƒæ ¼èƒŒåçš„é€»è¾‘æ¼æ´</p>
            </div>
            
            <nav class="top-nav">
                <a href="/power_prediction" class="btn btn-secondary nav-btn">åŠŸç‡é¢„æµ‹åˆ†æ</a>
                <a href="/daily_report" class="btn nav-btn active">è¿è¥æ—¥æŠ¥å®¡æ ¸</a>
            </nav>
        </header>

        <section class="upload-section">
            <div class="upload-box" id="dropZone">
                <div id="fileTriggerArea" style="cursor: pointer; padding: 0.8rem;">
                    <span style="font-size: 2.2rem;">ğŸ“Š</span>
                    <p id="fileDisplay" style="color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem;">
                        ç‚¹å‡»æµè§ˆæ–‡ä»¶ æˆ– æ‹–å…¥ Excel (.xlsx, .xls) <br>
                        <span style="font-size: 0.85rem; color: #64748b;">(è¯´æ˜ï¼šå°†è¿è¥æ—¥æŠ¥å¯¼å‡ºçš„xls/xlsxæ–‡ä»¶å¯¼å…¥)</span>
                    </p>
                </div>
                <div style="text-align: center; margin-bottom: 0.5rem;">
                    <a href="/static/templates/daily_report_template.xls" download="è¿è¥æ—¥æŠ¥è¡¨æ¨¡ç‰ˆ.xls" style="font-size: 0.8rem; color: var(--primary-color); text-decoration: none; border-bottom: 1px dashed var(--primary-color); display: inline-block;">â¬‡ï¸ ä¸‹è½½å¯¼å…¥æ¨¡ç‰ˆ (.xls)</a>
                </div>

                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                
                <div style="display: flex; justify-content: center; gap: 1.5rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" id="browseBtn">ğŸ“‚ æµè§ˆæ–‡ä»¶</button>
                    <button class="btn" id="analyzeBtn">ğŸ” æ‰§è¡Œæ™ºèƒ½å®¡è®¡</button>
                </div>
            </div>
        </section>

        <div class="loading-spinner" id="loader">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; color: var(--primary-color); font-weight: 600;">æ­£åœ¨è¿›è¡Œæ·±åº¦é€»è¾‘æ ¡éªŒ...</p>
        </div>

        <section class="viz-grid" id="historySection" style="margin-top: 1rem; margin-bottom: 2rem; display: block !important">
            <div class="card wide-card" style="padding: 1.5rem; border: 1px dashed var(--glass-border)">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.8rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.1rem">ğŸ“‚ å†å²å®¡è®¡è®°å½•</span>
                    <span id="historyCount" style="font-size: 0.85rem; color: var(--primary-color); font-weight: 600;">æ£€æµ‹ä¸­...</span>
                </div>
                <div id="historyList" style="display: flex; flex-direction: column; gap: 1rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                    <!-- å†å²è®°å½•åˆ—è¡¨ -->
                </div>
            </div>
        </section>

        <section class="viz-grid" id="dashboard">
            <div class="summary-cards wide-card">
                <div class="card">
                    <div class="card-title">æ–°èƒ½æºæ€»å‘ç”µé‡</div>
                    <div class="card-value" style="color: var(--success);" id="totalEnergy">0.00</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">ä¸‡kWh</div>
                </div>
                <div class="card">
                    <div class="card-title">é€»è¾‘æ ¡éªŒçŠ¶æ€</div>
                    <div class="card-value" id="auditStatus">-</div>
                </div>
                <div class="card">
                    <div class="card-title">å‘ç°å¼‚å¸¸é¡¹</div>
                    <div class="card-value" style="color: var(--danger);" id="anomalyCount">0</div>
                </div>
            </div>

            <div class="card wide-card">
                <div class="card-title">é€»è¾‘å®¡è®¡ç»“æœ (å¼‚å¸¸é¡¹ä¸æ­£ç¡®é¡¹)</div>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn btn-secondary nav-btn active" id="showAnomaliesBtn" style="min-width: 120px; padding: 0.4rem 1rem;">âŒ å¼‚å¸¸é¡¹</button>
                    <button class="btn btn-secondary nav-btn" id="showPassesBtn" style="min-width: 120px; padding: 0.4rem 1rem;">âœ… æ­£ç¡®é¡¹</button>
                </div>
                <div id="auditResultList" style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
                    <!-- Audit Content -->
                </div>
            </div>

            <div class="card">
                <div class="card-title">é™ç”µç‡ TOP 3</div>
                <div id="topCurtailment" style="padding: 1rem 0;"></div>
            </div>

            <div class="card">
                <div class="card-title">åˆ©ç”¨ç‡æœ€ä½ TOP 3</div>
                <div id="minAvailability" style="padding: 1rem 0;"></div>
            </div>
            
             <div class="wide-card" style="text-align: center; margin-top: 1rem; display: flex; justify-content: center; gap: 1.2rem; flex-wrap: wrap;">
                <a href="#" class="btn btn-secondary" id="jsonBtn" style="padding: 0.8rem 1.5rem; font-size: 1rem;">ğŸ’¾ ä¸‹è½½æ¸…æ´—åæ•°æ® (JSON)</a>
                <a href="#" class="btn btn-secondary" id="pdfBtn" style="padding: 0.8rem 1.5rem; font-size: 1rem;">ğŸ“„ ä¸‹è½½å®¡è®¡æŠ¥å‘Š (PDF)</a>
            </div>
        </section>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileTriggerArea = document.getElementById('fileTriggerArea');
        const browseBtn = document.getElementById('browseBtn');
        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const dashboard = document.getElementById('dashboard');
        const loader = document.getElementById('loader');

        const triggerFile = () => fileInput.click();
        fileTriggerArea.onclick = triggerFile;
        browseBtn.onclick = triggerFile;

        fileInput.onchange = () => {
            if (fileInput.files.length) {
                document.getElementById('fileDisplay').innerText = `å·²å°±ç»ª: ${fileInput.files[0].name}`;
                document.getElementById('fileDisplay').style.color = '#10b981';
            }
        };

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = 'rgba(99, 102, 241, 0.1)'; });
        dropZone.addEventListener('dragleave', () => { dropZone.style.background = 'var(--glass-bg)'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = 'var(--glass-bg)';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        analyzeBtn.onclick = async () => {
            if (!fileInput.files.length) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            loader.style.display = 'block';
            dashboard.style.display = 'none';

            try {
                const res = await fetch('/daily_report/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    renderDashboard(data);
                    fetchHistory();
                } else alert('åˆ†æä¸­æ–­: ' + data.error);
            } catch (err) { alert('ç½‘ç»œè¶…æ—¶'); }
            finally { loader.style.display = 'none'; }
        };

        async function fetchHistory() {
            try {
                const res = await fetch('/daily_report/history');
                const history = await res.json();
                renderHistory(history);
            } catch (err) { console.error('Failed to fetch history'); }
        }

        function renderHistory(history) {
            const list = document.getElementById('historyList');
            document.getElementById('historyCount').innerText = `å…± ${history.length} æ¡è®°å½•`;

            if (history.length === 0) {
                list.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 1rem;">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            list.innerHTML = history.map(item => `
                <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 0.8rem 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #fff; margin-bottom: 0.2rem; font-size: 0.95rem;">${item.filename}</div>
                        <div style="font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; gap: 0.8rem;">
                            <span>ğŸ“… ${item.timestamp}</span>
                            <span>âš¡ æ€»ç”µé‡: <b style="color: var(--success)">${item.total_new_energy.toFixed(2)}</b> ä¸‡kWh</span>
                            <span>âš ï¸ å¼‚å¸¸: <b style="color: var(--danger)">${item.anomaly_count}</b> é¡¹</span>
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a href="/download/${item.json_filename}" class="history-download" style="color: #10b981; text-decoration: none; font-size: 0.72rem; display: flex; align-items: center; gap: 4px;">
                                ğŸŸ¢ JSON æ•°æ®
                            </a>
                            <a href="/download/${item.pdf_filename}" class="history-download" style="color: #6366f1; text-decoration: none; font-size: 0.72rem; display: flex; align-items: center; gap: 4px;">
                                ğŸ”µ PDF å®¡è®¡æŠ¥å‘Š
                            </a>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.6rem; align-self: center;">
                        <button class="btn btn-secondary" onclick='loadRecord(${JSON.stringify(item).replace(/'/g, "&apos;")})' style="padding: 0.35rem 0.8rem; font-size: 0.75rem;">ğŸ“‚ æŸ¥çœ‹çœ‹æ¿</button>
                        <button class="btn" onclick="deleteHistory('${item.file_id}')" style="padding: 0.35rem 0.8rem; font-size: 0.75rem; background: rgba(255,77,77,0.1); color: #ff4d4d; border-color: rgba(255,77,77,0.2)">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function loadRecord(item) {
            renderDashboard(item);
            dashboard.scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteHistory(fileId) {
            const password = prompt('è¯·è¾“å…¥åˆ é™¤å¯†ç :');
            if (password === null) return; // Cancelled
            
            try {
                const res = await fetch(`/daily_report/history/${fileId}?password=${encodeURIComponent(password)}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    fetchHistory();
                } else {
                    alert(data.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        fetchHistory();

        let currentAnomalies = [];
        let currentPasses = [];

        function renderDashboard(data) {
            const overview = data.overview;
            document.getElementById('totalEnergy').innerText = overview.total_new_energy.toFixed(2);
            
            currentAnomalies = data.anomalies || [];
            currentPasses = data.passes || [];
            
            const statusEl = document.getElementById('auditStatus');
            statusEl.innerText = currentAnomalies.length > 0 ? 'âš ï¸ å‘ç°é£é™©' : 'âœ… æ ¡éªŒé€šè¿‡';
            statusEl.style.color = currentAnomalies.length > 0 ? 'var(--warning)' : 'var(--success)';
            
            document.getElementById('anomalyCount').innerText = currentAnomalies.length;

            // Updated tab labels with counts
            document.getElementById('showAnomaliesBtn').innerHTML = `âŒ å¼‚å¸¸é¡¹ (${currentAnomalies.length})`;
            document.getElementById('showPassesBtn').innerHTML = `âœ… æ­£ç¡®é¡¹ (${currentPasses.length})`;

            showAuditTab('anomalies');

            // Render Top Lists
            const renderList = (id, list, valKey, labelSuffix) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = list.map((item, idx) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 0.8rem; background: rgba(255,255,255,0.1); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">${idx+1}</span>
                            <span>${item.station}</span>
                        </div>
                        <span style="font-weight: 600; color: var(--primary-color);">${item[valKey]}${labelSuffix}</span>
                    </div>
                `).join('');
            };

            renderList('topCurtailment', data.top_curtailment, 'curtailment_rate', '%');
            renderList('minAvailability', data.min_avail, 'availability', '%');

            document.getElementById('jsonBtn').href = `/download/${data.json_filename}`;
            document.getElementById('pdfBtn').href = `/download/${data.pdf_filename}`;

            dashboard.style.display = 'grid';
        }

        function showAuditTab(type) {
            const listEl = document.getElementById('auditResultList');
            const anomalyBtn = document.getElementById('showAnomaliesBtn');
            const passBtn = document.getElementById('showPassesBtn');
            const items = type === 'anomalies' ? currentAnomalies : currentPasses;

            // Update button styles
            if (type === 'anomalies') {
                anomalyBtn.classList.add('active');
                passBtn.classList.remove('active');
            } else {
                passBtn.classList.add('active');
                anomalyBtn.classList.remove('active');
            }

            if (items.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 3rem;">${type === 'anomalies' ? 'ğŸ‰ å®Œç¾ï¼æ•°æ®é€»è¾‘æ ¡éªŒå…¨éƒ¨é€šè¿‡ã€‚' : 'æš‚æ— æ•°æ®'}</div>`;
                return;
            }

            // Group by category
            const grouped = items.reduce((acc, item) => {
                if (!acc[item.type]) acc[item.type] = [];
                acc[item.type].push(item);
                return acc;
            }, {});

            listEl.innerHTML = Object.entries(grouped).map(([category, list]) => `
                <div class="audit-group" style="margin-bottom: 2rem;">
                    <div style="font-size: 0.8rem; font-weight: 800; color: var(--text-muted); margin-bottom: 0.8rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${type === 'anomalies' ? 'var(--danger)' : 'var(--success)'}"></span>
                        ${category} (${list.length})
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                        ${list.map(item => `
                            <div style="background: ${type === 'anomalies' ? 'rgba(255, 77, 77, 0.05)' : 'rgba(16, 185, 129, 0.05)'}; 
                                        border-left: 4px solid ${type === 'anomalies' ? 'var(--danger)' : 'var(--success)'}; 
                                        padding: 1rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: #fff; margin-bottom: 0.3rem;">${item.station}</div>
                                    <div style="font-size: 0.88rem; color: ${type === 'anomalies' ? '#fca5a5' : '#6ee7b7'}; line-height: 1.4;">${item.desc}</div>
                                </div>
                                <div style="font-size: 0.7rem; background: ${type === 'anomalies' ? 'rgba(255, 77, 77, 0.15)' : 'rgba(16, 185, 129, 0.15)'}; 
                                            padding: 2px 8px; border-radius: 4px; color: ${type === 'anomalies' ? 'var(--danger)' : 'var(--success)'}; 
                                            font-weight: 800; margin-left: 1rem; white-space: nowrap;">
                                    ${item.type}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('showAnomaliesBtn').onclick = () => showAuditTab('anomalies');
        document.getElementById('showPassesBtn').onclick = () => showAuditTab('passes');
    </script>
</body>
</html>
